<?php

namespace App\Models\Transaction;

/*********************************************************************
 *  Created By       :  Generator Version 1.0.23                     *
 *  Created Date     :  Aug 18, 2020                                 *
 *  Description      : All code generated by model generator         *
 *  Generator Author : Tommy Maurice(tommy_maurice@yahoo.com)        *
 *********************************************************************/

use CodeIgniter\Model;

class Tax extends Model
{
    protected $table = 'tr_tax';
    protected $primaryKey = 'tx_id';
    protected $returnType = 'array';
    protected $useTimestamps = false;

    protected $allowedFields = [
        'tx_id',
        'biodata_id',
        'year',
        'month',
        'company_name',
        'marital_status',
        'tax_val',
        'tax_pinalty',
        'netto_setahun',
        'golongan',
        'tunjangan_jabatan',
        'tarif',
        'emp_jp',
        'emp_jht',
        'jp_setahun',
        'jht_setahun',
        'penghasilan_pajak',
        'brutto',
        'pic_input',
        'update_time',
        'brutto_setahun',
        'tunjangan_jabatan_setahun',
        'penghasilan_pajak_bulat',
        'tax_val_1',
        'tax_val_2',
        'tax_val_3',
        'tax_val_4',
        'tax_val_5',
        'total_tax_sebelumnya',
    ];

    /**
     * Ambil data pajak yang diakumulasi setahun
     */
    public function getDataTaxSetahun($biodataId, $bulan, $tahun)
    {
        $start_month = $this->getStartWork($biodataId, $bulan, $tahun) ?? $bulan;

        $builder = $this->select([
            'SUM(brutto) as total_kotor',
            'SUM(emp_jp) as total_jp',
            'SUM(emp_jht) as total_jht',
            'SUM(tunjangan_jabatan) as total_tunjangan_jabatan',
            'SUM(tax_val) as total_tax_sebelumnya',
            'COUNT(tx_id) as jml_bln'
        ])
            ->where('year', $tahun)
            ->where('biodata_id', $biodataId);

        if ($start_month === $bulan) {
            $builder->where('month', $start_month);
        } else {
            $builder->where('month >=', $start_month)
                ->where('month <', $bulan);
        }

        return $builder->first();
    }

    /**
     * Mencari bulan awal bekerja setelah periode END
     */
    public function getStartWork($biodataId, $monthPeriod, $yearPeriod)
    {
        // cari bulan dengan golongan END
        $bulanEND = $this->select('month')
            ->where('year', $yearPeriod)
            ->where('month <', $monthPeriod)
            ->where('biodata_id', $biodataId)
            ->where('golongan', 'END')
            ->orderBy('month', 'DESC')
            ->first();

        $bulanEND = $bulanEND['month'] ?? null;

        if (is_null($bulanEND)) {
            $firstMonth = $this->select('month')
                ->where('biodata_id', $biodataId)
                ->where('year', $yearPeriod)
                ->orderBy('month', 'ASC')
                ->first();

            return $firstMonth['month'] ?? null;
        } else {
            $startKerja = $this->select('month')
                ->where('biodata_id', $biodataId)
                ->where('year', $yearPeriod)
                ->where('month >', $bulanEND)
                ->orderBy('month', 'ASC')
                ->first();

            $startKerja = $startKerja['month'] ?? null;

            if ($startKerja && ($startKerja - $bulanEND) > 1) {
                return $startKerja;
            } else {
                $firstMonth = $this->select('month')
                    ->where('biodata_id', $biodataId)
                    ->where('year', $yearPeriod)
                    ->orderBy('month', 'ASC')
                    ->first();

                return $firstMonth['month'] ?? null;
            }
        }
    }

    /**
     * Generate ID unik format YYMMxxxxx
     */
    public function generateID()
    {
        $yearMonth = date('ym');

        $last = $this->like('tx_id', $yearMonth, 'after')
            ->orderBy('tx_id', 'DESC')
            ->first();

        if ($last) {
            $lastNumber = (int) substr($last['tx_id'], -5);
            $newNumber = str_pad($lastNumber + 1, 5, '0', STR_PAD_LEFT);
            return $yearMonth . $newNumber;
        }

        return $yearMonth . '00001';
    }

    /**
     * Mengecek apakah data pajak sudah ada
     */
    public function isDataExist($biodataId, $clientName, $year, $month)
    {
        return $this->where('year', $year)
            ->where('month', $month)
            ->where('biodata_id', $biodataId)
            ->where('company_name', $clientName)
            ->first();
    }
    public function getTaxDataByBiodata($clientName, $biodataId, $yearPeriod, $monthPeriod)
    {
        // Koneksi ke database (gunakan koneksi khusus jika ada, misalnya 'db_hris_sgt')
        $db = \Config\Database::connect();

        // Query SQL
        $sql = "
        SELECT *
        FROM tr_tax
        WHERE company_name = ?
        AND month = ?
        AND year = ?
        AND biodata_id = ?
        LIMIT 1
    ";

        // Eksekusi query
        $query = $db->query($sql, [$clientName, $monthPeriod, $yearPeriod, $biodataId]);

        // Tampilkan query dan error jika ada (untuk debugging)
        echo "<pre>Last Query: " . $db->getLastQuery() . "</pre>";
        if ($db->error()['code']) {
            echo "<pre>Error: " . print_r($db->error(), true) . "</pre>";
        }

        // Ambil hasil
        $result = $query->getRow();

        return $result ?? null;
    }

    public function getTaxDataForTaxCalculation($clientName, $biodataId, $yearPeriod, $monthPeriod)
    {
        $db = \Config\Database::connect();

        $query = $db->table('tr_tax')
            ->select('tax_pinalty, golongan, tarif')
            ->where('company_name', $clientName)
            ->where('month', $monthPeriod)
            ->where('year', $yearPeriod)
            ->where('biodata_id', $biodataId)
            ->limit(1)
            ->get()
            ->getRow();

        return $query ?? null;
    }
}
