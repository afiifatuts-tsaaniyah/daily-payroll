<?php

namespace App\Controllers\Transaction;

/*********************************************************************
 *  Created By       : Generator Version 1.0.23                      *
 *  Created Date     : Apr 06, 2022                                  *
 *  Description      : All code generated by controller generator    *
 *  Generator Author : Tommy Maurice(tommy_maurice@yahoo.com)        *
 *********************************************************************/

use App\Models\Master\MtAllowance;
use CodeIgniter\Controller;
use App\Controllers\BaseController;



use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\Writer\Xls;
use PhpOffice\PhpSpreadsheet\IOFactory;
use App\Models\Transaction\M_tr_timesheet;
use App\Models\Transaction\M_upload;
use App\Models\Transaction\M_proses;
use App\Models\Transaction\M_tr_overtime;
use App\Models\Transaction\M_tr_slip;
use App\Models\Transaction\M_rp_db;

class Tr_timesheet extends BaseController
{
    public function __construct()
    {
        // parent::__construct();
        // $this->db = \Config\Database::connect('', false);
    }

    /* START INDEX FUNCTION */
    public function index()
    {
        /* ***Using Valid Path */
        $data['actView'] = 'Transaction/v_tr_timesheet';
        return view('home', $data);
    }
    /* END INDEX FUNCTION */
    /* START INPUT FUNCTION */
    public function ins_view()
    {
        /* ***Using Valid Path */
        $data['actView'] = '../ins_tr_timesheet';
        return view('home', $data);
    }
    /* END INPUT FUNCTION */
    /* START UPDATE FUNCTION */
    public function upd_view()
    {
        $trTimesheet = new M_tr_timesheet();
        $data['trTimesheet'] = $trTimesheet->getById($ts_id);
        /* ***Using Valid Path */
        $data['actView'] = '../upd_tr_timesheet';
        return view('home', $data);
    }
    /* END UPDATE FUNCTION */
    /* START INSERT */
    public function ins()
    {

        $trTimesheet = new M_tr_timesheet();
        $trTimesheet->resetValues();
        $trTimesheet->setTsId($_POST['tsId']);
        $trTimesheet->setBiodataId($_POST['biodataId']);
        $trTimesheet->setBadgeNo($_POST['badgeNo']);
        $trTimesheet->setFullName($_POST['fullName']);
        $trTimesheet->setPayrollBase($_POST['payrollBase']);
        $trTimesheet->setClientName($_POST['clientName']);
        $trTimesheet->setDept($_POST['dept']);
        $trTimesheet->setMonthProcess($_POST['monthProcess']);
        $trTimesheet->setYearProcess($_POST['yearProcess']);
        $trTimesheet->setPeriodNo($_POST['periodNo']);
        $trTimesheet->setPassDay($_POST['passDay']);
        $trTimesheet->setD01($_POST['d01']);
        $trTimesheet->setD02($_POST['d02']);
        $trTimesheet->setD03($_POST['d03']);
        $trTimesheet->setD04($_POST['d04']);
        $trTimesheet->setD05($_POST['d05']);
        $trTimesheet->setD06($_POST['d06']);
        $trTimesheet->setD07($_POST['d07']);
        $trTimesheet->setD08($_POST['d08']);
        $trTimesheet->setD09($_POST['d09']);
        $trTimesheet->setD10($_POST['d10']);
        $trTimesheet->setD11($_POST['d11']);
        $trTimesheet->setD12($_POST['d12']);
        $trTimesheet->setD13($_POST['d13']);
        $trTimesheet->setD14($_POST['d14']);
        $trTimesheet->setD15($_POST['d15']);
        $trTimesheet->setD16($_POST['d16']);
        $trTimesheet->setD17($_POST['d17']);
        $trTimesheet->setD18($_POST['d18']);
        $trTimesheet->setD19($_POST['d19']);
        $trTimesheet->setD20($_POST['d20']);
        $trTimesheet->setD21($_POST['d21']);
        $trTimesheet->setD22($_POST['d22']);
        $trTimesheet->setD23($_POST['d23']);
        $trTimesheet->setD24($_POST['d24']);
        $trTimesheet->setD25($_POST['d25']);
        $trTimesheet->setD26($_POST['d26']);
        $trTimesheet->setD27($_POST['d27']);
        $trTimesheet->setD28($_POST['d28']);
        $trTimesheet->setD29($_POST['d29']);
        $trTimesheet->setD30($_POST['d30']);
        $trTimesheet->setD31($_POST['d31']);
        $trTimesheet->setIsActive($_POST['isActive']);
        $trTimesheet->setPicProcess($_POST['picProcess']);
        $trTimesheet->setProcessTime($_POST['processTime']);
        $trTimesheet->ins();
    }
    /* END INSERT */
    /* START UPDATE */
    public function upd()
    {

        $id = $_POST['tsId'];
        $trTimesheet = new M_tr_timesheet();
        $trTimesheet->setObjectById($id);
        $trTimesheet->setTsId($_POST['tsId']);
        $trTimesheet->setBiodataId($_POST['biodataId']);
        $trTimesheet->setBadgeNo($_POST['badgeNo']);
        $trTimesheet->setFullName($_POST['fullName']);
        $trTimesheet->setPayrollBase($_POST['payrollBase']);
        $trTimesheet->setClientName($_POST['clientName']);
        $trTimesheet->setDept($_POST['dept']);
        $trTimesheet->setMonthProcess($_POST['monthProcess']);
        $trTimesheet->setYearProcess($_POST['yearProcess']);
        $trTimesheet->setPeriodNo($_POST['periodNo']);
        $trTimesheet->setPassDay($_POST['passDay']);
        $trTimesheet->setD01($_POST['d01']);
        $trTimesheet->setD02($_POST['d02']);
        $trTimesheet->setD03($_POST['d03']);
        $trTimesheet->setD04($_POST['d04']);
        $trTimesheet->setD05($_POST['d05']);
        $trTimesheet->setD06($_POST['d06']);
        $trTimesheet->setD07($_POST['d07']);
        $trTimesheet->setD08($_POST['d08']);
        $trTimesheet->setD09($_POST['d09']);
        $trTimesheet->setD10($_POST['d10']);
        $trTimesheet->setD11($_POST['d11']);
        $trTimesheet->setD12($_POST['d12']);
        $trTimesheet->setD13($_POST['d13']);
        $trTimesheet->setD14($_POST['d14']);
        $trTimesheet->setD15($_POST['d15']);
        $trTimesheet->setD16($_POST['d16']);
        $trTimesheet->setD17($_POST['d17']);
        $trTimesheet->setD18($_POST['d18']);
        $trTimesheet->setD19($_POST['d19']);
        $trTimesheet->setD20($_POST['d20']);
        $trTimesheet->setD21($_POST['d21']);
        $trTimesheet->setD22($_POST['d22']);
        $trTimesheet->setD23($_POST['d23']);
        $trTimesheet->setD24($_POST['d24']);
        $trTimesheet->setD25($_POST['d25']);
        $trTimesheet->setD26($_POST['d26']);
        $trTimesheet->setD27($_POST['d27']);
        $trTimesheet->setD28($_POST['d28']);
        $trTimesheet->setD29($_POST['d29']);
        $trTimesheet->setD30($_POST['d30']);
        $trTimesheet->setD31($_POST['d31']);
        $trTimesheet->setIsActive($_POST['isActive']);
        $trTimesheet->setPicProcess($_POST['picProcess']);
        $trTimesheet->setProcessTime($_POST['processTime']);
        $trTimesheet->upd($id);
    }
    /* END UPDATE */

    public function validasiCheck($tahun, $bulan, $startDate, $sm)
    {
        $model = new M_tr_slip();
        $data = $model->getValidasiData($startDate, $tahun, $bulan, $sm);
        if (!empty($data)) {
            echo 'true';
        } else {
            echo 'false';
        }
    }

    /* START DELETE */
    public function del()
    {
        $trTimesheet = new M_tr_timesheet();
        $id = $_POST['tsId'];
        $trTimesheet->del($id);
    }
    public function Proses_split($tahun, $bulan, $startDate, $sm)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $data = $data_proses->proses($sm);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // dd($data);
        // echo $checkBpjs;
        // exit();


        $trOvertime = new M_tr_overtime();
        foreach ($data as $row) {
            $bioId = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0;
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall = 0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;



            for ($i = 1; $i <= 31; $i++) {
                $dayIndex++;
                // echo $i;
                if ($i < 10) {
                    $cek = 'd0' . $i;
                } else {
                    $cek = 'd' . $i;
                }
                $data = trim($row[$cek]);
                $SM = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];
                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm / 20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];


                $code = substr($data, 0, 2);
                $hours = substr($data, 2, 5);

                if ($hours == null || $hours == '') {
                    $hours = 0;
                }

                $end    = '';
                if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                    if ($data == 'STR' || $data == 'END') {
                        $standByCount++;
                        $hours = 0;

                        $end    = "END";
                    }
                }

                if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                    $hours = 0;
                }

                if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                    $hours = 0;
                }

                if ($code == 'DS') {
                    $daily++;
                }

                if ($code == 'AI') {
                    $ppt++;
                }

                if ($code == 'SL') {
                    $sick++;
                }

                if ($code == 'AB') {
                    $alpa++;
                }

                if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                    $attend++;
                }

                if ($code == 'HA' || $code == 'HN') {
                    $ph++;
                }

                $ot1 = 0;
                $ot2 = 0;
                $ot3 = 0;
                $ot4 = 0;
                $ot5 = 0;
                // dd($hours);
                $ot = $hours - 8;
                $otoff = $hours - 7;

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    if ($ot > 0) {
                        if ($ot < 1) {
                            $ot1 = $hours - 8;
                        } else {
                            $ot1 = 1;
                        }
                        $ot2 = $hours - 9;
                        // echo $hours.'</br>';
                    } else if ($ot > 0 && $ot < 1) {
                        $ot1 = $ot;
                    } else {
                        $ot1 = 0;
                        $ot2 = 0;
                    }
                }
                // echo $ot1;
                if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }
                }
                if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }
                }


                if ($code == 'OF') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }
                }

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    $nilai++;
                }
                if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                    $a++;
                } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                    $b++;
                }
                $allowanceAfternoon = $a;
                $allowanceNight = $b;

                if ($ot1 <= 0) {
                    $ot1 = 0;
                }
                if ($ot2 <= 0) {
                    $ot2 = 0;
                }
                if ($ot3 <= 0) {
                    $ot3 = 0;
                }
                if ($ot4 <= 0) {
                    $ot4 = 0;
                }
                // echo $hours.'-'.$ot1.'</br>';

                if ($dayIndex < 10) {
                    $ot01Column = 'setOt1D0' . $dayIndex;
                    $ot02Column = 'setOt2D0' . $dayIndex;
                    $ot03Column = 'setOt3D0' . $dayIndex;
                    $ot04Column = 'setOt4D0' . $dayIndex;
                } else {
                    $ot01Column = 'setOt1D' . $dayIndex;
                    $ot02Column = 'setOt2D' . $dayIndex;
                    $ot03Column = 'setOt3D' . $dayIndex;
                    $ot04Column = 'setOt4D' . $dayIndex;
                }

                $userId = $_SESSION['uId'];
                $currDateTm = date("Y-m-d H:i:s");

                $trOvertime->$ot01Column($ot1);
                $trOvertime->$ot02Column($ot2);
                $trOvertime->$ot03Column($ot3);
                $trOvertime->$ot04Column($ot4);

                if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                    $absen = 1;
                } else {
                    $absen = 0;
                }
                $ot1b = $ot1 + $ot1b;
                $ot2b = $ot2 + $ot2b;
                $ot3b = $ot3 + $ot3b;
                $ot4b = $ot4 + $ot4b;


                // echo $totall."<br>";
                $wd = $absen + $wd;





                // echo $ot2.'</br>';
            }

            if ($wd >= 20) {
                $wd = 20;
            }

            // exit();
            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot + $totall;



            $gaji = $bsm * $wd;

            $month_process      = $row['month_process'];
            $year_process       = $row['year_process'];
            $biodata_id         = $row['biodata_id'];

            $month_sebelum      = date('m', strtotime('-1 month', strtotime($year_process . '-' . $month_process . '-10')));
            $year_sebelum       = date('Y', strtotime('-1 month', strtotime($year_process . '-' . $month_process . '-10')));

            $stQuerySekarang    = "SELECT b.biodata_id,b.monthly,b.daily FROM mt_salary b WHERE b.biodata_id='" . $biodata_id . "' ";
            $data_sekarang      = $this->db->query($stQuerySekarang)->getRowArray();
            // dd($data_sekarang);

            $stQuerySebelum     = "SELECT a.work_total, a.gajipokok, (a.gajipokok/a.work_total) as daily
                                    FROM tr_slip a 
                                    WHERE a.biodata_id='" . $biodata_id . "' AND a.year_period='" . $year_sebelum . "' AND a.month_period='" . $month_sebelum . "'";
            $data_sebelum       = $this->db->query($stQuerySebelum)->getRowArray();
            // dd($data_sebelum);
            // dd(number_format($data_sebelum['daily'], 0, ".", "").' '.number_format($data_sekarang['daily'], 0, ".", ""));
            // if($data_sebelum){
            //     if(number_format($data_sebelum['daily'], 0, ".", "") !== number_format($data_sekarang['daily'], 0, ".", "")){
            //         $gaji_sebelum       = $count_sebelum * number_format($data_sebelum['daily'], 0, ".", "");
            //         $gaji_sesudah       = $count_sesudah * number_format($data_sekarang['daily'], 0, ".", "");

            //         $gaji               = $gaji_sebelum + $gaji_sesudah;
            //         // echo $gaji_sebelum.' '.$gaji_sesudah.' = '.$gaji; 
            //     }
            // }else{
            //     $gaji_sesudah   = $gaji;
            //     $gaji_sebelum   = 0;
            // }

            $bsProrate = $gaji;


            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($standByCount != 0) {
                    $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    $bsProrate = ($monthly / 20) * ($wd);
                } else {
                    $bsProrate = $monthly;
                }
                $gaji = $bsProrate;
            }

            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;




            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;



            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;



            $empjp = $monthly * 0.01;


            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            $tunjabatan = $totalgaji * 0.05;
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;

            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            } else if ($status == "K0") {
                $ptkpTotal = 58500000;
            } else if ($status == "K1") {
                $ptkpTotal = 63000000;
            } else if ($status == "K2") {
                $ptkpTotal = 67500000;
            } else if ($status == "K3") {
                $ptkpTotal = 72000000;
            } else {
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";
            /*echo $ptkpTotal;
            exit();*/
            $penghasilanPajak = 0;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0;
                $taxVal5 = 0;
            }

            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15;
            }
            if ($penghasilanPajak >= 60000000) {
                $taxVal1 = 3000000;
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            $pajakPlusSebulan = $pajakGajiSthn / 12;





            $ter = round($totalkotor);
            $strTerima = substr($ter, -3);
            $thp = 0;
            if ($strTerima < 500) {
                $thp = $ter - $strTerima;
            }
            if ($strTerima > 500) {
                $thp = $ter - $strTerima + 1000;
            }
            $round = $thp - $totalkotor;
            // $checkData = $data_proses->cekIdTimesheet($ts_id);

            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setslipPeriod($SDate);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();





            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioId);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setstand_by_count($standByCount);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($gaji);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($SM);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->setcheckFinal($end);
            $trSlip->ins();
        }



        // echo "Process Succeed...";
        echo $this->getPayrollList($tahun, $bulan, $startDate, $sm);
    }

    public function test($x, $exit = 0, $hide = false)
    {
        echo ($hide) ? '<div style="display:none;">' : '';
        echo "<pre>";
        if (is_array($x) || is_object($x)) {
            echo print_r($x);
        } elseif (is_string($x)) {
            echo $x;
        } else {
            echo var_dump($x);
        }
        echo "</pre><hr />";
        echo ($hide) ? '</div>' : '';
        if ($exit == 1) {
            die();
        }
    }

    public function Proses($tahun, $bulan, $startDate, $sm, $isEnd)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $data = $data_proses->proses($sm);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // $this->test($data,1);
        // echo $checkBpjs;
        // exit();



        $trOvertime = new M_tr_overtime();
        foreach ($data as $row) {
            $roster_format      = $row['roster_format'];
            // $this->test($roster_format,1);
            $bioId = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0;
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall = 0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;

            $end    = '';
            // $this->test($roster_format,0);
            if ($roster_format) {
                // Jika menggunakan roster Format
                $segments = explode('-', $roster_format);
                $workOffPairs = [];
                foreach ($segments as $segment) {
                    $parts = str_split($segment);
                    $workOffPairs[] = intval($parts[0]); // Hari kerja
                    $workOffPairs[] = intval($parts[1]); // Hari libur
                }

                $totalDays = array_sum($workOffPairs); // Menjumlahkan semua nilai dalam array workOffPairs

                $SM = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];
                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm / 20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];

                // $this->test($workOffPairs,1);
                for ($x = 0; $x < count($workOffPairs); $x += 2) {

                    $workDay = $workOffPairs[$x];
                    // $this->test($workDay,0);
                    $offDay = $workOffPairs[$x + 1];

                    // $this->test($workDay.' '.$offDay,0);


                    /* START GET WORK DAYS BY SHIFT */
                    // CommonHelper::test($workDay,1);
                    $harike     = 0;
                    // $this->test($workDay.' <--- WorkDay',0);
                    for ($wd = 1; $wd <= $workDay; $wd++) {
                        $harike++;
                        $dayIndex++;

                        if ($dayIndex < 10) {
                            $cek = 'd0' . $dayIndex;
                        } else {
                            $cek = 'd' . $dayIndex;
                        }
                        $data = trim($row[$cek]);

                        $code = substr($data, 0, 2);
                        $hours = substr($data, 2, 5);
                        // dd($data.' '.$statusSalary.' '.$row['full_name']);

                        if ($hours == null || $hours == '') {
                            $hours = 0;
                        }

                        if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                            if ($data == 'END') {
                                $standByCount++;
                                $hours = 0;

                                $end    = "END";
                            } else if ($data == 'STR') {
                                $standByCount++;
                                $hours = 0;
                            }
                        }

                        if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                            $hours = 0;
                        }

                        if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                            $hours = 0;
                        }

                        if ($code == 'DS') {
                            $daily++;
                        }

                        if ($code == 'AI') {
                            $ppt++;
                        }

                        if ($code == 'SL') {
                            $sick++;
                        }

                        if ($code == 'AB') {
                            $alpa++;
                        }

                        if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                            $attend++;
                        }

                        if ($code == 'HA' || $code == 'HN') {
                            $ph++;
                        }

                        $ot1 = 0;
                        $ot2 = 0;
                        $ot3 = 0;
                        $ot4 = 0;
                        $ot5 = 0;
                        // dd($hours);

                        $jamker1    = 7;
                        $jamker2    = 6;

                        $oTSembilan = 8;
                        $oTDelapan  = 7;
                        $oTTujuh    = 6;

                        if ($harike == 6) {
                            // $this->test("harike6");
                            $jamker1 = 5;
                            $jamker2 = 4;

                            $oTSembilan = 6;
                            $oTDelapan  = 4;
                            $oTTujuh    = 4;
                        }

                        $ot = $hours - $jamker1;
                        $otoff = $hours - $jamker2;

                        // $this->test('Hari Ke '.$harike.' || '.$data.' || '.$hours." - ".$jamker1,0);
                        // $this->test('Hari Ke '.$harike.' || '.$data.' || '.$hours." - ".$jamker2,0);

                        // if($harike==6){
                        //     $this->test($harike.' '.$dayIndex.' '.$data.' '.$hours,0);
                        //     $this->test('OT: '.$ot.' '.$otoff,0);
                        // }

                        if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                            if ($ot > 0) {
                                if ($ot < 1) {
                                    $ot1 = $hours - $oTDelapan;
                                } else {
                                    $ot1 = 1;
                                }
                                $ot2 = $hours - $oTSembilan;
                                // echo $hours.'</br>';
                            } else if ($ot > 0 && $ot < 1) {
                                $ot1 = $ot;
                            } else {
                                $ot1 = 0;
                                $ot2 = 0;
                            }
                        }
                        // echo $ot1;
                        if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - $oTTujuh;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - $oTDelapan;
                            } else {
                                $ot2 = $hours;
                            }
                        }
                        if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - $oTTujuh;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - $oTDelapan;
                            } else {
                                $ot2 = $hours;
                            }
                        }


                        if ($code == 'OF') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - $oTTujuh;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - $oTDelapan;
                            } else {
                                $ot2 = $hours;
                            }
                        }

                        if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                            $nilai++;
                        }
                        if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                            $a++;
                        } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                            $b++;
                        }
                        $allowanceAfternoon = $a;
                        $allowanceNight = $b;

                        if ($ot1 <= 0) {
                            $ot1 = 0;
                        }
                        if ($ot2 <= 0) {
                            $ot2 = 0;
                        }
                        if ($ot3 <= 0) {
                            $ot3 = 0;
                        }
                        if ($ot4 <= 0) {
                            $ot4 = 0;
                        }

                        if ($dayIndex < 10) {
                            $ot01Column = 'setOt1D0' . $dayIndex;
                            $ot02Column = 'setOt2D0' . $dayIndex;
                            $ot03Column = 'setOt3D0' . $dayIndex;
                            $ot04Column = 'setOt4D0' . $dayIndex;
                        } else {
                            $ot01Column = 'setOt1D' . $dayIndex;
                            $ot02Column = 'setOt2D' . $dayIndex;
                            $ot03Column = 'setOt3D' . $dayIndex;
                            $ot04Column = 'setOt4D' . $dayIndex;
                        }
                        // echo $ot01Column.' <--- '.$hours.'-'.$ot1.'</br>';

                        $userId = $_SESSION['uId'];
                        $currDateTm = date("Y-m-d H:i:s");

                        $trOvertime->$ot01Column($ot1);
                        $trOvertime->$ot02Column($ot2);
                        $trOvertime->$ot03Column($ot3);
                        $trOvertime->$ot04Column($ot4);

                        if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                            $absen = 1;
                        } else {
                            $absen = 0;
                        }

                        $ot1b = $ot1 + $ot1b;
                        $ot2b = $ot2 + $ot2b;
                        $ot3b = $ot3 + $ot3b;
                        $ot4b = $ot4 + $ot4b;


                        //  // echo $totall."<br>";
                        // $wd = $absen + $wd;

                        //  // $this->test($data.' <--- Masuk',0);

                    }

                    for ($od = 1; $od <= $offDay; $od++) {
                        $dayIndex++;

                        if ($dayIndex < 10) {
                            $cek = 'd0' . $dayIndex;
                        } else {
                            $cek = 'd' . $dayIndex;
                        }
                        $data = trim($row[$cek]);

                        $code = substr($data, 0, 2);
                        $hours = substr($data, 2, 5);
                        // dd($data.' '.$statusSalary.' '.$row['full_name']);

                        if ($hours == null || $hours == '') {
                            $hours = 0;
                        }

                        if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                            if ($data == 'END') {
                                $standByCount++;
                                $hours = 0;

                                $end    = "END";
                            } else if ($data == 'STR') {
                                $standByCount++;
                                $hours = 0;
                            }
                        }

                        if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                            $hours = 0;
                        }

                        if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                            $hours = 0;
                        }

                        if ($code == 'DS') {
                            $daily++;
                        }

                        if ($code == 'AI') {
                            $ppt++;
                        }

                        if ($code == 'SL') {
                            $sick++;
                        }

                        if ($code == 'AB') {
                            $alpa++;
                        }

                        if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                            $attend++;
                        }

                        if ($code == 'HA' || $code == 'HN') {
                            $ph++;
                        }

                        $ot1 = 0;
                        $ot2 = 0;
                        $ot3 = 0;
                        $ot4 = 0;
                        $ot5 = 0;
                        // dd($hours);
                        $ot = $hours - 8;
                        $otoff = $hours - 7;

                        if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                            if ($ot > 0) {
                                if ($ot < 1) {
                                    $ot1 = $hours - 8;
                                } else {
                                    $ot1 = 1;
                                }
                                $ot2 = $hours - 9;
                                // echo $hours.'</br>';
                            } else if ($ot > 0 && $ot < 1) {
                                $ot1 = $ot;
                            } else {
                                $ot1 = 0;
                                $ot2 = 0;
                            }
                        }
                        // echo $ot1;
                        if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - 7;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - 8;
                            } else {
                                $ot2 = $hours;
                            }
                        }
                        if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - 7;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - 8;
                            } else {
                                $ot2 = $hours;
                            }
                        }


                        if ($code == 'OF') {
                            if ($otoff > 0) {
                                $ot2 = 7;
                                if ($otoff < 1) {
                                    $ot3 = $hours - 7;
                                } else {
                                    $ot3 = 1;
                                }
                                $ot4 = $hours - 8;
                            } else {
                                $ot2 = $hours;
                            }
                        }

                        if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                            $nilai++;
                        }
                        if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                            $a++;
                        } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                            $b++;
                        }
                        $allowanceAfternoon = $a;
                        $allowanceNight = $b;

                        if ($ot1 <= 0) {
                            $ot1 = 0;
                        }
                        if ($ot2 <= 0) {
                            $ot2 = 0;
                        }
                        if ($ot3 <= 0) {
                            $ot3 = 0;
                        }
                        if ($ot4 <= 0) {
                            $ot4 = 0;
                        }
                        // echo $hours.'-'.$ot1.'</br>';

                        if ($dayIndex < 10) {
                            $ot01Column = 'setOt1D0' . $dayIndex;
                            $ot02Column = 'setOt2D0' . $dayIndex;
                            $ot03Column = 'setOt3D0' . $dayIndex;
                            $ot04Column = 'setOt4D0' . $dayIndex;
                        } else {
                            $ot01Column = 'setOt1D' . $dayIndex;
                            $ot02Column = 'setOt2D' . $dayIndex;
                            $ot03Column = 'setOt3D' . $dayIndex;
                            $ot04Column = 'setOt4D' . $dayIndex;
                        }

                        $userId = $_SESSION['uId'];
                        $currDateTm = date("Y-m-d H:i:s");

                        $trOvertime->$ot01Column($ot1);
                        $trOvertime->$ot02Column($ot2);
                        $trOvertime->$ot03Column($ot3);
                        $trOvertime->$ot04Column($ot4);

                        if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                            $absen = 1;
                        } else {
                            $absen = 0;
                        }

                        $ot1b = $ot1 + $ot1b;
                        $ot2b = $ot2 + $ot2b;
                        $ot3b = $ot3 + $ot3b;
                        $ot4b = $ot4 + $ot4b;

                        // echo $ot01Column.' <--- '.$hours.'-'.$ot1.'</br>';
                        // echo $totall."<br>";
                        // $wd = $absen + $wd;

                        // $this->test($data.' <--- Libur',0);

                    }
                }

                // $this->test('123',1);
                // $this->test($dayIndex,1);
                // $this->test("kelar",1);
            } else {
                // Jika Tidak Menggunakan Roster Format


                for ($i = 1; $i <= 31; $i++) {
                    $dayIndex++;
                    // echo $i;
                    if ($i < 10) {
                        $cek = 'd0' . $i;
                    } else {
                        $cek = 'd' . $i;
                    }
                    $data = trim($row[$cek]);
                    $SM = $row['payroll_group'];
                    $bioRec = $row['biodata_id'];
                    $roster = $row['ts_id'];
                    $client = $row['client_name'];
                    $year = $row['year_process'];
                    $month = $row['month_process'];
                    $tsId = $row['ts_id'];
                    $SDate = $row['start_date'];
                    $dept = $row['dept'];
                    $fName = $row['full_name'];
                    $monthly = $row['monthly'];
                    $bsm = $row['daily'];
                    $bs = $bsm / 20;
                    $marital = $row['marital_status'];
                    $position = $row['emp_position'];
                    $salaryHourly = $monthly / 173;
                    $status = $row['marital_status'];
                    $statusSalary = $row['status'];


                    $code = substr($data, 0, 2);
                    $hours = substr($data, 2, 5);
                    // dd($data.' '.$statusSalary.' '.$row['full_name']);

                    if ($hours == null || $hours == '') {
                        $hours = 0;
                    }

                    if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                        if ($data == 'END') {
                            $standByCount++;
                            $hours = 0;

                            $end    = "END";
                        } else if ($data == 'STR') {
                            $standByCount++;
                            $hours = 0;
                        }
                    }

                    if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                        $hours = 0;
                    }

                    if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                        $hours = 0;
                    }

                    if ($code == 'DS') {
                        $daily++;
                    }

                    if ($code == 'AI') {
                        $ppt++;
                    }

                    if ($code == 'SL') {
                        $sick++;
                    }

                    if ($code == 'AB') {
                        $alpa++;
                    }

                    if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                        $attend++;
                    }

                    if ($code == 'HA' || $code == 'HN') {
                        $ph++;
                    }

                    $ot1 = 0;
                    $ot2 = 0;
                    $ot3 = 0;
                    $ot4 = 0;
                    $ot5 = 0;
                    // dd($hours);
                    $ot = $hours - 8;
                    $otoff = $hours - 7;

                    if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                        if ($ot > 0) {
                            if ($ot < 1) {
                                $ot1 = $hours - 8;
                            } else {
                                $ot1 = 1;
                            }
                            $ot2 = $hours - 9;
                            // echo $hours.'</br>';
                        } else if ($ot > 0 && $ot < 1) {
                            $ot1 = $ot;
                        } else {
                            $ot1 = 0;
                            $ot2 = 0;
                        }
                    }
                    // echo $ot1;
                    if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                        if ($otoff > 0) {
                            $ot2 = 7;
                            if ($otoff < 1) {
                                $ot3 = $hours - 7;
                            } else {
                                $ot3 = 1;
                            }
                            $ot4 = $hours - 8;
                        } else {
                            $ot2 = $hours;
                        }
                    }
                    if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                        if ($otoff > 0) {
                            $ot2 = 7;
                            if ($otoff < 1) {
                                $ot3 = $hours - 7;
                            } else {
                                $ot3 = 1;
                            }
                            $ot4 = $hours - 8;
                        } else {
                            $ot2 = $hours;
                        }
                    }


                    if ($code == 'OF') {
                        if ($otoff > 0) {
                            $ot2 = 7;
                            if ($otoff < 1) {
                                $ot3 = $hours - 7;
                            } else {
                                $ot3 = 1;
                            }
                            $ot4 = $hours - 8;
                        } else {
                            $ot2 = $hours;
                        }
                    }

                    if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                        $nilai++;
                    }
                    if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                        $a++;
                    } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                        $b++;
                    }
                    $allowanceAfternoon = $a;
                    $allowanceNight = $b;

                    if ($ot1 <= 0) {
                        $ot1 = 0;
                    }
                    if ($ot2 <= 0) {
                        $ot2 = 0;
                    }
                    if ($ot3 <= 0) {
                        $ot3 = 0;
                    }
                    if ($ot4 <= 0) {
                        $ot4 = 0;
                    }
                    // echo $hours.'-'.$ot1.'</br>';

                    if ($dayIndex < 10) {
                        $ot01Column = 'setOt1D0' . $dayIndex;
                        $ot02Column = 'setOt2D0' . $dayIndex;
                        $ot03Column = 'setOt3D0' . $dayIndex;
                        $ot04Column = 'setOt4D0' . $dayIndex;
                    } else {
                        $ot01Column = 'setOt1D' . $dayIndex;
                        $ot02Column = 'setOt2D' . $dayIndex;
                        $ot03Column = 'setOt3D' . $dayIndex;
                        $ot04Column = 'setOt4D' . $dayIndex;
                    }

                    $userId = $_SESSION['uId'];
                    $currDateTm = date("Y-m-d H:i:s");

                    $trOvertime->$ot01Column($ot1);
                    $trOvertime->$ot02Column($ot2);
                    $trOvertime->$ot03Column($ot3);
                    $trOvertime->$ot04Column($ot4);

                    if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                        $absen = 1;
                    } else {
                        $absen = 0;
                    }

                    $ot1b = $ot1 + $ot1b;
                    $ot2b = $ot2 + $ot2b;
                    $ot3b = $ot3 + $ot3b;
                    $ot4b = $ot4 + $ot4b;


                    // echo $totall."<br>";
                    $wd = $absen + $wd;





                    // echo $ot2.'</br>';
                }
            }
            // dd($row['roster_format']);

            // echo $bioRec.'<br/>'.$end.'<br/><br/><br/>';

            // exit();
            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot + $totall;



            $gaji = $bsm * $wd;
            // echo $bsm.' '.$wd.' '.$gaji.'1 <br/>';
            $bsProrate = $gaji;

            // echo $statusSalary.'<br/>';
            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {

                if ($wd >= 20) {
                    $wd = 20;
                }

                if ($standByCount != 0) {
                    $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    $bsProrate = ($monthly / 20) * ($wd);
                } else {
                    $bsProrate = $monthly;
                }
                // $gaji = $bsProrate;
            }
            // echo $bsProrate.' bs_prorate <br/>';
            // echo $gaji.' 2 final <br/>';
            // echo $monthly.' 3 <br/>';
            // exit();

            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;




            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;



            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;



            $empjp = $monthly * 0.01;


            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            // dd($gaji ."+". $totall ."+". $allow2 ."+". $jkkjkm ."+". $allow1 ."+". $bpjs);
            $tunjabatan = $totalgaji * 0.05;
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;

            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            } else if ($status == "K0") {
                $ptkpTotal = 58500000;
            } else if ($status == "K1") {
                $ptkpTotal = 63000000;
            } else if ($status == "K2") {
                $ptkpTotal = 67500000;
            } else if ($status == "K3") {
                $ptkpTotal = 72000000;
            } else {
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";
            /*echo $ptkpTotal;
            exit();*/
            $penghasilanPajak = 0;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0;
                $taxVal5 = 0;
            }

            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15;
            }
            if ($penghasilanPajak >= 60000000) {
                $taxVal1 = 3000000;
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            $pajakPlusSebulan = $pajakGajiSthn / 12;





            $ter = round($totalkotor);
            $strTerima = substr($ter, -2);
            $thp = 0;
            if ($strTerima < 50) {
                $thp = $ter - $strTerima;
            }
            if ($strTerima > 50) {
                $thp = $ter - $strTerima + 100;
            }
            $round = $thp - $totalkotor;
            // dd($totalkotor.' '.$strTerima.' '.$thp.' '.$round);
            // echo "biorec = ".$bioRec.' rosterid = '.$tsId.'<br/>';
            // echo 'totalkotor = '.$totalkotor.' <br/>strTerima = '.$strTerima.' <br/>thp = '.$thp.' <br/>round = '.$round.'<br/><br/><br/><br/>';

            // $checkData = $data_proses->cekIdTimesheet($ts_id);

            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];

            $allowanceModel = new MtAllowance();
            $allowanceData = $allowanceModel->selectAllowanceBySM($bioRec, 'Agincourt_Martabe', $year, $month, $sm);

            $amountMap  = array_column($allowanceData, 'allowance_amount', 'allowance_name');
            $remarksMap = array_column($allowanceData, 'remarks', 'allowance_name');

            $thrAmount  = (int) ($amountMap['thr'] ?? 0);
            $adjustmentInAmount  = (int) ($amountMap['adjustment_in'] ?? 0);
            $adjustmentOutAmount  = (int) ($amountMap['adjustment_out'] ?? 0);
            $thrByUserAmount  = (int) ($amountMap['thr_by_user'] ?? 0);
            // var_dump($thrAmount);
            $workdayAdjustmentAmount  = (int) ($amountMap['workday_adjustment'] ?? 0);
            $lainLainAmount  = (int) ($amountMap['lain_lain'] ?? 0);
            $adjustmentRemarks = $remarksMap['workday_adjustment'] ?? '';

            // var_dump($allowanceData);

            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setslipPeriod($SDate);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();


            // dd($monthly.' '.$gaji);
            // exit();

            // if($isEnd=='1'){
            //     $end = 'END';
            // }            

            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioId);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setstand_by_count($standByCount);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($monthly);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($SM);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->setcheckFinal($end);
            $trSlip->setThr($thrAmount);
            $trSlip->setThrByUser($thrByUserAmount);
            $trSlip->setAllowance03($lainLainAmount);
            $trSlip->setAdjustment($workdayAdjustmentAmount);
            $trSlip->setAdjustmentIn($adjustmentInAmount);
            $trSlip->setAdjustmentOut($adjustmentOutAmount);
            $trSlip->setstatusRemarks($adjustmentRemarks);
            $trSlip->ins();
        }



        // echo "Process Succeed...";
        echo $this->getPayrollList($tahun, $bulan, $startDate, $sm);
    }

    public function processDB($tahun, $bulan, $startDate, $sm)
    {
        ini_set('max_execution_time', 1200); //300 seconds = 5 minutes
        $model = new M_tr_timesheet();
        $data  = $model->getTsIdByProces($tahun, $bulan, $startDate, $sm);
        $rpDb = new M_rp_db();
        $dataRpDb = array();
        foreach ($data as $tsId) {
            $this->insertDataDb($tsId['ts_id'], $model, $rpDb);
        }
    }

    public function insertDataDb($tsId, $trTimesheet, $rpDb)
    {
        $row = $trTimesheet->dbInser($tsId);
        // echo $row['ts_id'];
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $biodata_id = $row['biodata_id'];
        $ts_id = $row['ts_id'];
        $bsm = $row['daily'];
        $slip_id = $row['slip_id'];
        $monthly = $row['monthly'];
        $tanggal = $tDate3 . '-' . $tDate1 . '-' . $startDate;
        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);
        $tanggal1 = $tanggal;


        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $normalTime = 0;
        $ot01Val = 0;
        $ot02Val = 0;
        $ot03Val = 0;
        $ot04Val = 0;
        $tunjanganSiang = 0;
        $tunjanganMalam = 0;
        // $dataRpDb = array();
        for ($i = 1; $i <= $dayCountInMonth; $i++) {

            $in  = '';
            $out = '';

            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if ($i < 10) {
                $ot01Column = 'ot1_d0' . $i;
                $ot02Column = 'ot2_d0' . $i;
                $ot03Column = 'ot3_d0' . $i;
                $ot04Column = 'ot4_d0' . $i;
                $timePerday = 'd0' . $i;
                $in = 'in0' . $i;
                $out = 'out0' . $i;
            } else {
                $ot01Column = 'ot1_d' . $i;
                $ot02Column = 'ot2_d' . $i;
                $ot03Column = 'ot3_d' . $i;
                $ot04Column = 'ot4_d' . $i;
                $timePerday = 'd' . $i;
                $in = 'in' . $i;
                $out = 'out' . $i;
                // exit();
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];
            $outVal  = $row[$out];

            $strTimePerday = $row[$timePerday];


            $phCodeTmp = substr($strTimePerday, 0, 2);

            $phHoursTmp = substr($strTimePerday, 2, 5);

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS") {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }

            $dateProcessing = str_replace("-", "", $tanggal);

            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $totalHour = $phHoursTmp;
            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            // echo $totalHour .'-'. $ot01Val .'-'. $ot02Val .'-'. $ot03Val .'- '.$ot04Val.'</br>';
            // $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;

            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0;
            }

            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            }
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }

            $malam = ($bsm * $tunjanganMalam) * 0.15;
            $siang = $bsm * 0.10 * $tunjanganSiang;

            $allTunjangan = $malam + $siang;

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;

            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4;

            $dataRpDb = [
                'in_db' => $inVal,
                'out_db' => $outVal,
                'shift_day' => $shift_Day,
                'po_ph' => $roPh,
                'work_day' => $wDay,
                'date_process' => $dateProcessing,
                'biodata_id' => $biodata_id,
                'ts_id' => $ts_id,
                'slip_id' => $slip_id,
                'total_ot' => $totalOt,
                'ot_1' => $ot01Val,
                'ot_2' => $ot02Val,
                'ot_3' => $ot03Val,
                'ot_4' => $ot04Val,
                'normal_time' => $normalTime,
                'dept' => $row['dept'],
                'tunjangan' => $allTunjangan,
                'total_ot_value' => $totalOtValue,
                'tunjangan_malam' => $tunjanganMalam,
                'tunjangan_siang' => $tunjanganSiang,
            ];
            $rpDb->insertData($dataRpDb);
        }
    }

    public function ProsesSolo($id)
    {
        $data_proses = new M_tr_timesheet();
        $row = $data_proses->prosesSolo($id);
        // dd($row);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // dd($data);
        // echo $checkBpjs;
        // exit();    


        $trOvertime = new M_tr_overtime();
        // foreach ($data as $row) {
        $bioId = $row['biodata_id'];
        /*echo $bioId;*/
        $nilai = 0;
        $a = 0;
        $b = 0;
        $daily = 0;
        $off = 0;
        $ppt = 0;
        $sick = 0;
        $alpa = 0;
        $attend = 0;
        $ph = 0;
        $dayIndex = 0;
        $ot1s = 1.5;
        $ot2s = 2.0;
        $ot3s = 3.0;
        $ot4s = 4.0;
        $totall = 0;
        $salary = 0;
        $absen = 0;
        $wd = 0;
        $ot1b = 0;
        $ot2b = 0;
        $ot3b = 0;
        $jkkjkm = 0;
        $ot4b = 0;
        $jp = 0;
        $jht = 0;
        $bpjs = 0;
        $iujht = 0;
        $iujht2 = 0;
        $jkm = 0;
        $jkk = 0;
        $empbpjs = 0;
        $bpjs = 0;
        $empjp = 0;
        $empjht = 0;
        $standByCount = 0;



        $end    = '';
        for ($i = 1; $i <= 31; $i++) {
            $dayIndex++;
            // echo $i;
            if ($i < 10) {
                $cek = 'd0' . $i;
            } else {
                $cek = 'd' . $i;
            }
            $data = trim($row[$cek]);
            $SM = $row['payroll_group'];
            $bioRec = $row['biodata_id'];
            $roster = $row['ts_id'];
            $client = $row['client_name'];
            $year = $row['year_process'];
            $month = $row['month_process'];
            $tsId = $row['ts_id'];
            $SDate = $row['start_date'];
            $dept = $row['dept'];
            $fName = $row['full_name'];
            $monthly = $row['monthly'];
            $bsm = $row['daily'];
            $bs = $bsm / 20;
            $marital = $row['marital_status'];
            $position = $row['emp_position'];
            $salaryHourly = $monthly / 173;
            $status = $row['marital_status'];
            $statusSalary = $row['status'];


            $code = substr($data, 0, 2);
            $hours = substr($data, 2, 5);
            // dd($data.' '.$statusSalary.' '.$row['full_name']);

            if ($hours == null || $hours == '') {
                $hours = 0;
            }

            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($data == 'END') {
                    $standByCount++;
                    $hours = 0;

                    $end    = "END";
                } else if ($data == 'STR') {
                    $standByCount++;
                    $hours = 0;
                }
            }

            if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                $hours = 0;
            }

            if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                $hours = 0;
            }

            if ($code == 'DS') {
                $daily++;
            }

            if ($code == 'AI') {
                $ppt++;
            }

            if ($code == 'SL') {
                $sick++;
            }

            if ($code == 'AB') {
                $alpa++;
            }

            if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                $attend++;
            }

            if ($code == 'HA' || $code == 'HN') {
                $ph++;
            }

            $ot1 = 0;
            $ot2 = 0;
            $ot3 = 0;
            $ot4 = 0;
            $ot5 = 0;
            // dd($hours);
            $ot = $hours - 8;
            $otoff = $hours - 7;

            if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                if ($ot > 0) {
                    if ($ot < 1) {
                        $ot1 = $hours - 8;
                    } else {
                        $ot1 = 1;
                    }
                    $ot2 = $hours - 9;
                    // echo $hours.'</br>';
                } else if ($ot > 0 && $ot < 1) {
                    $ot1 = $ot;
                } else {
                    $ot1 = 0;
                    $ot2 = 0;
                }
            }
            // echo $ot1;
            if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }
            if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }


            if ($code == 'OF') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }

            if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                $nilai++;
            }
            if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                $a++;
            } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                $b++;
            }
            $allowanceAfternoon = $a;
            $allowanceNight = $b;

            if ($ot1 <= 0) {
                $ot1 = 0;
            }
            if ($ot2 <= 0) {
                $ot2 = 0;
            }
            if ($ot3 <= 0) {
                $ot3 = 0;
            }
            if ($ot4 <= 0) {
                $ot4 = 0;
            }
            // echo $hours.'-'.$ot1.'</br>';

            if ($dayIndex < 10) {
                $ot01Column = 'setOt1D0' . $dayIndex;
                $ot02Column = 'setOt2D0' . $dayIndex;
                $ot03Column = 'setOt3D0' . $dayIndex;
                $ot04Column = 'setOt4D0' . $dayIndex;
            } else {
                $ot01Column = 'setOt1D' . $dayIndex;
                $ot02Column = 'setOt2D' . $dayIndex;
                $ot03Column = 'setOt3D' . $dayIndex;
                $ot04Column = 'setOt4D' . $dayIndex;
            }

            $userId = $_SESSION['uId'];
            $currDateTm = date("Y-m-d H:i:s");

            $trOvertime->$ot01Column($ot1);
            $trOvertime->$ot02Column($ot2);
            $trOvertime->$ot03Column($ot3);
            $trOvertime->$ot04Column($ot4);

            if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                $absen = 1;
            } else {
                $absen = 0;
            }
            $ot1b = $ot1 + $ot1b;
            $ot2b = $ot2 + $ot2b;
            $ot3b = $ot3 + $ot3b;
            $ot4b = $ot4 + $ot4b;


            // echo $totall."<br>";
            $wd = $absen + $wd;





            // echo $ot2.'</br>';
        }

        // echo $bioRec.'<br/>'.$end.'<br/><br/><br/>';

        // exit();
        $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
        $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
        $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
        $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
        $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
        $totall = $totalot + $totall;



        $gaji = $bsm * $wd;
        // echo $bsm.' '.$wd.' '.$gaji.'1 <br/>';
        $bsProrate = $gaji;

        // echo $statusSalary.'<br/>';
        if ($statusSalary == 'Monthly' || $statusSalary == 'month') {

            if ($wd >= 20) {
                $wd = 20;
            }

            if ($standByCount != 0) {
                $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                $bsProrate = ($monthly / 20) * ($wd);
            } else {
                $bsProrate = $monthly;
            }
            // $gaji = $bsProrate;
        }
        // echo $bsProrate.' bs_prorate <br/>';
        // echo $gaji.' 2 final <br/>';
        // echo $monthly.' 3 <br/>';
        // exit();

        $bpjs = $monthly * 0.04;
        $empbpjs = $monthly * 0.05;




        $jkk = $monthly * 0.0174;
        $jkm = $monthly * 0.003;
        $jkkjkm = $jkk + $jkm;



        // $iujht = $monthly * 0.03;
        $iujht2 = $monthly * 0.037;
        $empjht = $monthly * 0.02;



        $empjp = $monthly * 0.01;


        $jhtjp = $empjht + $empjp;
        $allow2 = ($bsm * $allowanceNight) * 0.15;
        $allow1 = $bsm * 0.10 * $allowanceAfternoon;
        $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
        // dd($gaji ." + ". $totall ." + ". $allow2 ." + ". $jkkjkm ." + ". $allow1 ." + ". $bpjs);
        $tunjabatan = $totalgaji * 0.05;
        $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;

        $nettoSetahun = 0;
        $nettoSetahun = $totalkotor * 12;
        $ptkpTotal = 0;
        if ($status == "TK0") {
            $ptkpTotal = 54000000;
        } else if ($status == "K0") {
            $ptkpTotal = 58500000;
        } else if ($status == "K1") {
            $ptkpTotal = 63000000;
        } else if ($status == "K2") {
            $ptkpTotal = 67500000;
        } else if ($status == "K3") {
            $ptkpTotal = 72000000;
        } else {
            $ptkpTotal = 0;
        }
        $taxPercent1 = "5%";
        $taxPercent2 = "15%";
        $taxPercent3 = "25%";
        $taxPercent4 = "30%";
        $taxPercent5 = "35%";
        /*echo $ptkpTotal;
            exit();*/
        $penghasilanPajak = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        if ($nettoSetahun >= $ptkpTotal) {
            $penghasilanPajak = $nettoSetahun - $ptkpTotal;
            $pajakNonReg = 0;
            $pajakPlusSebulan = 0;
            $taxVal1 = $penghasilanPajak * 0.05;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
        }

        $maxPajak1 = $penghasilanPajak - 60000000;
        if ($penghasilanPajak > 60000000) {
            $taxVal2 = $maxPajak1 * 0.15;
        }
        if ($penghasilanPajak >= 60000000) {
            $taxVal1 = 3000000;
        }

        $maxPajak2 = $maxPajak1 - 190000000;
        if ($maxPajak1 >= 190000000) {
            $taxVal2 = 28500000;
        }

        if ($maxPajak1 > 190000000) {
            $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
        }

        $maxPajak3 = $maxPajak2 - 250000000;
        if ($maxPajak2 >= 250000000) {
            $taxVal3 = 62500000;
        }
        if ($maxPajak2 > 250000000) {
            $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
        }
        $maxPajak4 = $maxPajak3 - 4500000000;
        if ($maxPajak3 > 4500000000) {
            $taxVal4 = 1350000000;
        }
        if ($maxPajak4 > 4500000000) {
            $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
        }
        $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
        $pajakPlusSebulan = $pajakGajiSthn / 12;





        $ter = round($totalkotor);
        $strTerima = substr($ter, -2);
        $thp = 0;
        if ($strTerima < 50) {
            $thp = $ter - $strTerima;
        }
        if ($strTerima > 50) {
            $thp = $ter - $strTerima + 100;
        }
        $round = $thp - $totalkotor;
        // dd($totalkotor.' '.$strTerima.' '.$thp.' '.$round);

        // echo "biorec = ".$bioRec.' rosterid = '.$tsId.'<br/>';
        // echo 'totalkotor = '.$totalkotor.' <br/>strTerima = '.$strTerima.' <br/>thp = '.$thp.' <br/>round = '.$round.'<br/><br/><br/><br/>';

        // $checkData = $data_proses->cekIdTimesheet($ts_id);

        $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
        // $trOvertime->resetValues();
        $trOvertime->setOvertimeId($id);
        $trOvertime->setBioRecId($bioRec);
        $trOvertime->setRosterId($tsId);
        $trOvertime->setClientName($client);
        $trOvertime->setslipPeriod($SDate);
        $trOvertime->setYearPeriod($year);
        $trOvertime->setMonthPeriod($month);
        $trOvertime->setNightShiftCount($allowanceNight);
        $trOvertime->setDayShiftCount($daily);
        $trOvertime->setOffTotal($off);
        $trOvertime->setPermitTotal($ppt);
        $trOvertime->setSickTotal($sick);
        $trOvertime->setAlpaTotal($alpa);
        $trOvertime->setAttendTotal($attend);
        $trOvertime->setPhTotal($ph);
        $trOvertime->setPicProcess($userId);
        $trOvertime->setProcessTime($currDateTm);
        $trOvertime->ins();


        // dd($monthly.' '.$gaji);
        // exit();

        // if($isEnd=='1'){
        //     $end = 'END';
        // }            


        $allowanceModel = new MtAllowance();
        $allowanceData = $allowanceModel->selectAllowanceBySM($bioRec, 'Agincourt_Martabe', $year, $month, $SM);

        $amountMap  = array_column($allowanceData, 'allowance_amount', 'allowance_name');
        $remarksMap = array_column($allowanceData, 'remarks', 'allowance_name');

        $thrAmount  = (int) ($amountMap['thr'] ?? 0);
        $thrByUserAmount  = (int) ($amountMap['thr_by_user'] ?? 0);
        $adjustmentInAmount  = (int) ($amountMap['adjustment_in'] ?? 0);
        $adjustmentOutAmount  = (int) ($amountMap['adjustment_out'] ?? 0);
        // var_dump($thrAmount);
        $workdayAdjustmentAmount  = (int) ($amountMap['workday_adjustment'] ?? 0);
        $lainLainAmount  = (int) ($amountMap['lain_lain'] ?? 0);
        $adjustmentRemarks = $remarksMap['workday_adjustment'] ?? '';


        $headerId = $trSlip->generateId('slip_id')['doc_id'];


        $trSlip->setSlipId($id);
        $trSlip->setBiodataId($bioId);
        $trSlip->setTsId($tsId);
        $trSlip->setYearPeriod($year);
        $trSlip->setMonthPeriod($month);
        $trSlip->setSlipPeriod($SDate);
        $trSlip->setdateProcess("$year-$month-$SDate");
        $trSlip->setFullName($fName);
        $trSlip->setPosition($position);
        $trSlip->setMaritalStatus($marital);
        $trSlip->setDept($dept);
        $trSlip->setWorkTotal($attend);
        $trSlip->setAllowance01($allow1);
        $trSlip->setAllowance02($allow2);
        $trSlip->setstand_by_count($standByCount);
        $trSlip->setbs_prorate($bsProrate);
        $trSlip->setBpjs($bpjs);
        $trSlip->setJkk($jkk);
        $trSlip->setJkm($jkm);
        $trSlip->setJht($iujht2);
        $trSlip->setEmpBpjs($empbpjs);
        $trSlip->setEmpJp($empjp);
        $trSlip->setEmpJht($empjht);
        $trSlip->setPicInput($userId);
        $trSlip->setInputTime($currDateTm);
        $trSlip->setJkkjkm($jkkjkm);
        $trSlip->setJhtjp($jhtjp);
        $trSlip->settotalot($totall);
        $trSlip->setgaji($gaji);
        $trSlip->setgajipokok($monthly);
        $trSlip->setpph21($pajakPlusSebulan);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setround($round);
        $trSlip->setpayrollGroup($SM);
        $trSlip->setbankId($row['bank_id']);
        $trSlip->setcheckFinal($end);


        $trSlip->setThr($thrAmount);
        $trSlip->setThrByUser($thrByUserAmount);
        $trSlip->setAllowance03($lainLainAmount);
        $trSlip->setAdjustment($workdayAdjustmentAmount);
        $trSlip->setAdjustmentIn($adjustmentInAmount);
        $trSlip->setAdjustmentOut($adjustmentOutAmount);
        $trSlip->setstatusRemarks($adjustmentRemarks);

        // $trSlip->setAllowance03(0);
        // $trSlip->setAdjustment(0);
        // $trSlip->setThr(0);
        $trSlip->ins();
        // }


    }

    public function ProsesSolo_split($id)
    {
        $this->db = \Config\Database::connect('', false);

        $data_proses = new M_tr_timesheet();
        $row = $data_proses->prosesSolo($id);
        // dd($row);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // dd($data);
        // echo $checkBpjs;
        // exit();


        // foreach ($data as $row) {
        $bioRec = $row['biodata_id'];
        /*echo $bioId;*/
        $nilai = 0;
        $a = 0;
        $b = 0;
        $daily = 0;
        $off = 0;
        $ppt = 0;
        $sick = 0;
        $alpa = 0;
        $attend = 0;
        $ph = 0;
        $dayIndex = 0;
        $ot1s = 1.5;
        $ot2s = 2.0;
        $ot3s = 3.0;
        $ot4s = 4.0;
        $totall = 0;
        $salary = 0;
        $absen = 0;
        $wd = 0;
        $ot1b = 0;
        $ot2b = 0;
        $ot3b = 0;
        $jkkjkm = 0;
        $ot4b = 0;
        $jp = 0;
        $jht = 0;
        $bpjs = 0;
        $iujht = 0;
        $iujht2 = 0;
        $jkm = 0;
        $jkk = 0;
        $empbpjs = 0;
        $bpjs = 0;
        $empjp = 0;
        $empjht = 0;
        $standByCount = 0;


        $start_count_date       = $row['year_process'] . "-" . $row['month_process'] . "-" . $row['start_date'];
        $end_month_process      = date('Y-m-t', strtotime($start_count_date));

        // echo $start_count_date.' '.$end_month_process;
        $count_sebelum = 0;
        $count_sesudah = 0;

        $trOvertime = new M_tr_overtime();

        for ($i = 1; $i <= 31; $i++) {

            // echo $start_count_date."<br/>";

            $dayIndex++;
            // echo $i;
            if ($i < 10) {
                $cek = 'd0' . $i;
            } else {
                $cek = 'd' . $i;
            }
            $data = trim($row[$cek]);
            $sm = $row['payroll_group'];
            $bioRec = $row['biodata_id'];
            $roster = $row['ts_id'];
            $client = $row['client_name'];
            $year = $row['year_process'];
            $month = $row['month_process'];
            $tsId = $row['ts_id'];
            $SDate = $row['start_date'];

            $dept = $row['dept'];
            $fName = $row['full_name'];
            $monthly = $row['monthly'];
            $bsm = $row['daily'];
            $bs = $bsm / 20;
            $marital = $row['marital_status'];
            $position = $row['emp_position'];
            $salaryHourly = $monthly / 173;
            $status = $row['marital_status'];
            $statusSalary = $row['status'];


            $code = substr($data, 0, 2);
            $hours = substr($data, 2, 5);

            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($data == 'STR' || $data == 'END') {
                    $standByCount++;
                    $hours = 0;

                    $end    = "END";
                }
            }


            if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                $hours = 0;
            }
            if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                $hours = 0;
            }
            if ($code == 'DS') {
                $daily++;
            }

            if ($code == 'AI') {
                $ppt++;
            }

            if ($code == 'SL') {
                $sick++;
            }

            if ($code == 'AB') {
                $alpa++;
            }

            if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                $attend++;

                if ($start_count_date <= $end_month_process) {
                    $count_sebelum++;
                } else {
                    $count_sesudah++;
                }
            }

            if ($code == 'HA' || $code == 'HN') {
                $ph++;
            }

            $ot1 = 0;
            $ot2 = 0;
            $ot3 = 0;
            $ot4 = 0;
            $ot5 = 0;
            $ot = $hours - 8;
            $otoff = $hours - 7;

            if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                if ($ot > 0) {
                    if ($ot < 1) {
                        $ot1 = $hours - 8;
                    } else {
                        $ot1 = 1;
                    }
                    $ot2 = $hours - 9;
                } else if ($ot > 0 && $ot < 1) {
                    $ot1 = $ot;
                } else {
                    $ot1 = 0;
                    $ot2 = 0;
                }
            }

            // echo $ot1;
            if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }
            if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }


            if ($code == 'OF') {
                if ($otoff > 0) {
                    $ot2 = 7;
                    if ($otoff < 1) {
                        $ot3 = $hours - 7;
                    } else {
                        $ot3 = 1;
                    }
                    $ot4 = $hours - 8;
                } else {
                    $ot2 = $hours;
                }
            }

            if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                $nilai++;
            }
            if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                $a++;
            } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                $b++;
            }
            $allowanceAfternoon = $a;
            $allowanceNight = $b;

            if ($ot1 <= 0) {
                $ot1 = 0;
            }
            if ($ot2 <= 0) {
                $ot2 = 0;
            }
            if ($ot3 <= 0) {
                $ot3 = 0;
            }
            if ($ot4 <= 0) {
                $ot4 = 0;
            }
            // echo $hours.'-'.$ot2.'</br>';

            if ($dayIndex < 10) {
                $ot01Column = 'setOt1D0' . $dayIndex;
                $ot02Column = 'setOt2D0' . $dayIndex;
                $ot03Column = 'setOt3D0' . $dayIndex;
                $ot04Column = 'setOt4D0' . $dayIndex;
            } else {
                $ot01Column = 'setOt1D' . $dayIndex;
                $ot02Column = 'setOt2D' . $dayIndex;
                $ot03Column = 'setOt3D' . $dayIndex;
                $ot04Column = 'setOt4D' . $dayIndex;
            }

            $userId = $_SESSION['uId'];
            $currDateTm = date("Y-m-d H:i:s");

            $trOvertime->$ot01Column($ot1);
            $trOvertime->$ot02Column($ot2);
            $trOvertime->$ot03Column($ot3);
            $trOvertime->$ot04Column($ot4);

            if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                $absen = 1;
            } else {
                $absen = 0;
            }
            $ot1b = $ot1 + $ot1b;
            $ot2b = $ot2 + $ot2b;
            $ot3b = $ot3 + $ot3b;
            $ot4b = $ot4 + $ot4b;


            // echo $totall."<br>";
            $wd = $absen + $wd;


            $start_count_date      = date('Y-m-d', strtotime('+1 days', strtotime($start_count_date)));
        }

        // dd($count_sebelum.' - '.$count_sesudah);
        // exit();

        $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
        $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
        $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
        $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
        $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
        $totall = $totalot + $totall;



        $gaji = $bsm * $wd;

        // dd($gaji.' '.$bsm.' '.$wd);

        $month_process      = $row['month_process'];
        $year_process       = $row['year_process'];
        $biodata_id         = $row['biodata_id'];

        $month_sebelum      = date('m', strtotime('-1 month', strtotime($year_process . '-' . $month_process . '-10')));
        $year_sebelum       = date('Y', strtotime('-1 month', strtotime($year_process . '-' . $month_process . '-10')));

        $stQuerySekarang    = "SELECT b.biodata_id,b.monthly,b.daily FROM mt_salary b WHERE b.biodata_id='" . $biodata_id . "' ";
        $data_sekarang      = $this->db->query($stQuerySekarang)->getRowArray();
        // dd($data_sekarang);

        $stQuerySebelum     = "SELECT a.work_total, a.gajipokok, (a.gajipokok/a.work_total) as daily
                                    FROM tr_slip a 
                                    WHERE a.biodata_id='" . $biodata_id . "' AND a.year_period='" . $year_sebelum . "' AND a.month_period='" . $month_sebelum . "'";
        $data_sebelum       = $this->db->query($stQuerySebelum)->getRowArray();
        // dd($data_sebelum);
        // dd(number_format($data_sebelum['daily'], 0, ".", "").' '.number_format($data_sekarang['daily'], 0, ".", ""));
        if ($data_sebelum) {
            if (number_format($data_sebelum['daily'], 0, ".", "") !== number_format($data_sekarang['daily'], 0, ".", "")) {
                $gaji_sebelum       = $count_sebelum * number_format($data_sebelum['daily'], 0, ".", "");
                $gaji_sesudah       = $count_sesudah * number_format($data_sekarang['daily'], 0, ".", "");

                $gaji               = $gaji_sebelum + $gaji_sesudah;
                // echo $gaji_sebelum.' '.$gaji_sesudah.' = '.$gaji; 
            }
        } else {
            $gaji_sesudah   = $gaji;
            $gaji_sebelum   = 0;
        }

        // dd($gaji_sebelum.' '.$gaji_sesudah.' '.$gaji);
        $bsProrate = $gaji;


        // echo $standByCount;
        // exit();
        // if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
        //     if ($standByCount != 0) {
        //         $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
        //         $bsProrate = ($monthly / 20) * ($wd);
        //     } else {
        //         $bsProrate = $monthly;
        //     }
        //     $gaji = $bsProrate;
        // }

        $bpjs = $monthly * 0.04;
        $empbpjs = $monthly * 0.05;




        $jkk = $monthly * 0.0174;
        $jkm = $monthly * 0.003;
        $jkkjkm = $jkk + $jkm;



        // $iujht = $monthly * 0.03;
        $iujht2 = $monthly * 0.037;
        $empjht = $monthly * 0.02;



        $empjp = $monthly * 0.01;


        $jhtjp = $empjht + $empjp;
        $allow2 = ($bsm * $allowanceNight) * 0.15;
        $allow1 = $bsm * 0.10 * $allowanceAfternoon;
        $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
        $tunjabatan = $totalgaji * 0.05;
        $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;

        $nettoSetahun = 0;
        $nettoSetahun = $totalkotor * 12;
        $ptkpTotal = 0;
        if ($status == "TK0") {
            $ptkpTotal = 54000000;
        } else if ($status == "K0") {
            $ptkpTotal = 58500000;
        } else if ($status == "K1") {
            $ptkpTotal = 63000000;
        } else if ($status == "K2") {
            $ptkpTotal = 67500000;
        } else if ($status == "K3") {
            $ptkpTotal = 72000000;
        } else {
            $ptkpTotal = 0;
        }
        $taxPercent1 = "5%";
        $taxPercent2 = "15%";
        $taxPercent3 = "25%";
        $taxPercent4 = "30%";
        $taxPercent5 = "35%";

        $penghasilanPajak = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        if ($nettoSetahun >= $ptkpTotal) {
            $penghasilanPajak = $nettoSetahun - $ptkpTotal;
            $pajakNonReg = 0;
            $pajakPlusSebulan = 0;
            $taxVal1 = $penghasilanPajak * 0.05;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
        }

        $maxPajak1 = $penghasilanPajak - 60000000;
        if ($penghasilanPajak > 60000000) {
            $taxVal2 = $maxPajak1 * 0.15;
        }
        if ($penghasilanPajak >= 60000000) {
            $taxVal1 = 3000000;
        }

        $maxPajak2 = $maxPajak1 - 190000000;
        if ($maxPajak1 >= 190000000) {
            $taxVal2 = 28500000;
        }

        if ($maxPajak1 > 190000000) {
            $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
        }

        $maxPajak3 = $maxPajak2 - 250000000;
        if ($maxPajak2 >= 250000000) {
            $taxVal3 = 62500000;
        }
        if ($maxPajak2 > 250000000) {
            $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
        }
        $maxPajak4 = $maxPajak3 - 4500000000;
        if ($maxPajak3 > 4500000000) {
            $taxVal4 = 1350000000;
        }
        if ($maxPajak4 > 4500000000) {
            $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
        }
        $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4;
        $pajakPlusSebulan = $pajakGajiSthn / 12;


        // exit();


        $ter = round($totalkotor);
        $strTerima = substr($ter, -3);
        $thp = 0;
        if ($strTerima < 500) {
            $thp = $ter - $strTerima;
        }
        if ($strTerima > 500) {
            $thp = $ter - $strTerima + 1000;
        }
        $round = $thp - $totalkotor;

        $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
        // $trOvertime->resetValues();
        $trOvertime->setOvertimeId($headerId);
        $trOvertime->setBioRecId($bioRec);
        $trOvertime->setRosterId($tsId);
        $trOvertime->setClientName($client);
        $trOvertime->setYearPeriod($year);
        $trOvertime->setMonthPeriod($month);
        $trOvertime->setNightShiftCount($allowanceNight);
        $trOvertime->setDayShiftCount($daily);
        $trOvertime->setOffTotal($off);
        $trOvertime->setPermitTotal($ppt);
        $trOvertime->setSickTotal($sick);
        $trOvertime->setAlpaTotal($alpa);
        $trOvertime->setAttendTotal($attend);
        $trOvertime->setPhTotal($ph);
        $trOvertime->setPicProcess($userId);
        $trOvertime->setProcessTime($currDateTm);
        $trOvertime->ins();




        $headerId = $trSlip->generateId('slip_id')['doc_id'];
        $trSlip->setSlipId($headerId);
        $trSlip->setBiodataId($bioRec);
        $trSlip->setTsId($tsId);
        $trSlip->setYearPeriod($year);
        $trSlip->setMonthPeriod($month);
        $trSlip->setSlipPeriod($SDate);
        $trSlip->setdateProcess("$year-$month-$SDate");
        $trSlip->setFullName($fName);
        $trSlip->setPosition($position);
        $trSlip->setMaritalStatus($marital);
        $trSlip->setbs_prorate($bsProrate);
        $trSlip->setDept($dept);
        $trSlip->setWorkTotal($attend);
        $trSlip->setAllowance01($allow1);
        $trSlip->setAllowance02($allow2);
        $trSlip->setBpjs($bpjs);
        $trSlip->setJkk($jkk);
        $trSlip->setJkm($jkm);
        $trSlip->setJht($iujht2);
        $trSlip->setEmpBpjs($empbpjs);
        $trSlip->setEmpJp($empjp);
        $trSlip->setEmpJht($empjht);
        $trSlip->setPicInput($userId);
        $trSlip->setInputTime($currDateTm);
        $trSlip->setJkkjkm($jkkjkm);
        $trSlip->setJhtjp($jhtjp);
        $trSlip->settotalot($totall);

        $trSlip->setGajiSebelum($gaji_sebelum);
        $trSlip->setGajiSekarang($gaji_sesudah);

        $trSlip->setgaji($gaji);
        $trSlip->setgajipokok($gaji);
        $trSlip->setpph21($pajakPlusSebulan);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setround($round);
        $trSlip->setpayrollGroup($sm);
        $trSlip->setbankId($row['bank_id']);
        $trSlip->ins();


        // }


    }

    /* END GET ALL */
    public function getPayrollList($tahun, $bulan, $startDate, $sm)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $data_sm = $data_proses->baca($sm);
        // echo $this->db->last_query(); exit(0);
        // echo $this->db->last_query(); exit(0);
        /*return json_encode($query);*/
        $data   = array();
        $myData = array();
        foreach ($data_sm as $key => $row) {
            $myData[] = array(
                $row['slip_id'],
                $row['biodata_id'],
                $row['full_name'],
                $row['dept'],
                $row['ts_id'],
                // $row['production_bonus'],         
                // $row['workday_adj'],         
                // $row['adjust_in'],         
                // $row['adjust_out'],  
                // $row['full_name'],  
                $row['thr'],
                $row['allowance_03'],
                $row['adjustment'],
                $row['adjustment_in'],
                $row['adjustment_out'],
                $row['thr_by_user'],

                // $row['attendance_bonus'],         
                // $row['other_allowance1'],         
                // $row['other_allowance2'],         
                // $row['cc_payment'],         
                // $row['thr'],         
                // $row['debt_burden'],
                // $row['debt_explanation']
            );
        }
        $data['due_date']   = count($data_proses->cek_duedate($sm));
        $data['myData']     = $myData;


        echo json_encode($data);
        // echo $this->db->last_query(); 
    }

    public function Excel($ts_id, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $cbEnd, $spreadsheet, $noNewSheet)
    {
        // dd($cbEnd);
        // exit();
        $this->db = \Config\Database::connect('', false);

        $trSlip = new M_tr_slip();
        $rpDb = new M_rp_db();
        $writer = new Xls($spreadsheet);


        $spreadsheet->getProperties()->setCreator('Maurice - Web - Android')
            ->setLastModifiedBy('Maurice - Web - Android')
            ->setTitle('Office 2007 XLSX Test Document')
            ->setSubject('Office 2007 XLSX Test Document')
            ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
            ->setKeywords('office 2007 openxml php')
            ->setCategory('Test result file');
        $boldFont = [
            'font' => [
                'bold' => true
                // 'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyle = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyles = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => 'FFFF0000'],
            ],
        ];

        $allBorderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $outlineBorderStyle = [
            'borders' => [
                'outline' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $topBorderStyle = [
            'borders' => [
                'top' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $bottomBorderStyle = [
            'borders' => [
                'bottom' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];
        $center = array();
        $center['alignment'] = array();
        $center['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER;
        $center['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $right = array();
        $right['alignment'] = array();
        $right['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_RIGHT;
        $right['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $left = array();
        $left['alignment'] = array();
        $left['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_LEFT;
        $left['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;




        $spreadsheet->getActiveSheet()->getColumnDimension('A')->setWidth(9);
        $spreadsheet->getActiveSheet()->getColumnDimension('B')->setWidth(9);
        $spreadsheet->getActiveSheet()->getColumnDimension('C')->setWidth(7);
        $spreadsheet->getActiveSheet()->getColumnDimension('D')->setWidth(8);
        $spreadsheet->getActiveSheet()->getColumnDimension('E')->setWidth(7);
        $spreadsheet->getActiveSheet()->getColumnDimension('F')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('G')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('H')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('I')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('J')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('K')->setWidth(3);
        $spreadsheet->getActiveSheet()->getColumnDimension('M')->setWidth(8);

        $rowIdx = 0;
        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $allTimeTotal = 0;
        $normalTotal = 0;
        $wDayTotal = 0;
        $rowIdx = 8;
        $rowIdx_new = 8;
        $totalTitle_sum = 0;
        $attendStatus = 0;
        $bonusTotal = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        $penghasilanPajak = 0;
        $pajakNonReg = 0;
        $pajakPlusSebulan = 0;
        $pajakGajiSthn = 0;
        $pajakSebulan = 0;
        $tTimePerday = 0;
        $wdAttendCount = 0;
        $alpa = 0;
        $bsProrate = 0;
        $end = 0;
        $end_var = '';





        $trTimesheet = new M_tr_timesheet();
        $row = $trTimesheet->Print($ts_id);
        // dd($row);
        $roster_format = $row['roster_format'];
        $biodataId =  $row['biodata_id'];
        $row['bank_id'];
        $nama = $row['full_name'];
        $jabatan = $row['position'];
        $status = $row['marital_status'];
        $id = $row['biodata_id'];
        $dept = $row['dept'];
        $bpjs = $row['bpjs'];
        $monthly = $row['real_gajipokok'];
        // $monthly = $row['monthly']; //Perubahan 12-03-2025
        $siang = $row['allowance_01'];
        $malam = $row['allowance_02'];
        $jk = $row['jk'];
        $jkk = $row['jkk'];
        $jkm = $row['jkm'];
        $bpjstk = $row['emp_bpjs'];
        $empjht = $row['emp_jht'];
        $jkkjkm = $row['jkkjkm'];
        $jptk = $row['emp_jp'];
        $adjustment = $row['adjustment'];
        $adjustmentIn = $row['adjustment_in'];
        $adjustmentOut = $row['adjustment_out'];
        $thrByUser = $row['thr_by_user'];
        $keterangan = $row['status_remarks'];
        $client_display = 'PT. Agincourt Resources Martabe Gold Mine';
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $npwp = $row['tax_no'];
        $sPayroll = $row['status_payroll'];
        $alpa = $row['alpa_total'];
        $izin = $row['permit_total'];
        $bsProrate = $row['bs_prorate'];
        $statusBPJS = $row['bpjs_status'];
        $tanggal = $tDate3 . '-' . $tDate1 . '-' . $startDate;
        $Thr        = $row['thr'];
        $date_process = $row['date_process'];
        $due_date = $row['due_date'];
        // $due_date= "2025-05-16";
        // $due_dateTime = strtotime($due_date);


        // echo $due_date.'<br/>';
        // echo $start_periode_1.' '.$end_periode_1.'<br/><br/>';
        // echo $start_periode_2.' '.$end_periode_2.'<br/><br/>';
        // echo $start_day.' '.$end_day;
        // exit();

        $day_bsProrate  = 0;
        $day_siang  = 0;
        $day_malam  = 0;
        $day_alpa  = 0;
        $day_izin  = 0;
        $day_Thr  = 0;
        $day_bonusdll  = 0;
        $day_total_ot = 0;
        $day_adjustment = 0;
        $day_jkkjkm = 0;
        $day_bpjs = 0;
        // dd($sPayroll);
        if ($sPayroll == "Daily") {

            $start_periode_1      = date('Y-m-06', strtotime('+0 month', strtotime($due_date)));
            $end_periode_1        = date('Y-m-05', strtotime('+1 month', strtotime($due_date)));

            $start_periode_2        = date('Y-m-06', strtotime('-1 month', strtotime($due_date)));
            $end_periode_2        = date('Y-m-05', strtotime('+0 month', strtotime($due_date)));


            if (strtotime($due_date) >= strtotime($start_periode_1) && strtotime($due_date) <= strtotime($end_periode_1)) {
                // echo "Due date berada dalam periode satu.</br>";
                $startDateDay      = $start_periode_1;
                $endDateDay        = $end_periode_1;
            } else {
                // echo "Due date berada dalam periode dua.</br>";
                $startDateDay      = $start_periode_2;
                $endDateDay        = $end_periode_2;
            }
            // echo "SELECT COUNT(*) total FROM tr_timesheet a1, tr_slip b1 
            //                     WHERE a1.ts_id = b1.ts_id AND a1.biodata_id = '" . $biodataId . "'
            //                     AND b1.due_date BETWEEN '" . $startDateDay . "' AND '" . $endDateDay . "'";
            // exit();
            $limit_data     = $this->db->query("SELECT COUNT(*) total FROM tr_timesheet a1, tr_slip b1 
                                WHERE a1.ts_id = b1.ts_id AND a1.biodata_id = '" . $biodataId . "'
                                AND b1.due_date BETWEEN '" . $startDateDay . "' AND '" . $endDateDay . "' ")->getRowArray()['total'] - 1;

            if ($limit_data >= 1) {
                $total_daily    = $this->db->query("SELECT  b.payroll_group, b.input_time, b.month_period, b.year_period, b.ts_id,b.bs_prorate,b.jkkjkm,
                                    b.totalot AS total_ot,b.thr,b.allowance_01 AS siang, b.allowance_02 AS malam,b.allowance_03 AS lain2,b.adjustment,b.bpjs,
                                    c.alpa_total,c.permit_total
                                    FROM 
                                      tr_timesheet a,tr_slip b,tr_overtime c,mt_salary d,mt_biodata_01 e,mt_bank f 
                                    WHERE 
                                      a.ts_id = b.ts_id 
                                      AND a.biodata_id = d.biodata_id 
                                      AND a.ts_id = c.roster_id 
                                      AND a.biodata_id = e.biodata_id 
                                      AND f.bank_id = d.bank_id
                                      AND a.biodata_id = '" . $biodataId . "' 
                                      AND b.due_date BETWEEN '" . $startDateDay . "' AND '" . $endDateDay . "' AND due_date < '" . $due_date . "'
                                      /*AND b.date_process < '" . $date_process . "'*/
                                    ORDER BY b.input_time ASC 
                                    LIMIT $limit_data")->getResultArray();

                foreach ($total_daily as $key => $value) {
                    $day_bsProrate  = $value['bs_prorate'] + $day_bsProrate;
                    $day_siang      = $value['siang'] + $day_siang;
                    $day_malam      = $value['malam'] + $day_malam;
                    $day_alpa       = $value['alpa_total'] + $day_alpa;
                    $day_izin       = $value['permit_total'] + $day_izin;
                    $day_Thr        = $value['thr'] + $day_Thr;
                    $day_bonusdll   = $value['lain2'] + $day_bonusdll;
                    $day_total_ot   = $value['total_ot'] + $day_total_ot;
                    $day_adjustment = $value['adjustment'] + $day_adjustment;
                    $day_jkkjkm     = $value['jkkjkm'] + $day_jkkjkm;
                    $day_bpjs       = $value['bpjs'] + $day_bpjs;

                    // echo 'day_bsProrate '.$day_bsProrate.' | <br/>day_siang '.$day_siang.' | <br/>day_malam '.$day_malam.' | <br/>day_alpa '.$day_alpa.' | <br/>day_izin '.$day_izin.' | <br/>day_Thr '.$day_Thr.' | <br/>day_bonusdll '.$day_bonusdll.' | <br/>day_total_ot '.$day_total_ot.' | <br/>day_adjustment '.$day_adjustment.' |<br/><br/><br/>';
                }

                // echo 'day_bsProrate '.$day_bsProrate.' | <br/>day_siang '.$day_siang.' | <br/>day_malam '.$day_malam.' | <br/>day_alpa '.$day_alpa.' | <br/>day_izin '.$day_izin.' | <br/>day_Thr '.$day_Thr.' | <br/>day_bonusdll '.$day_bonusdll.' | <br/>day_total_ot '.$day_total_ot.' | <br/>day_adjustment '.$day_adjustment.' |';
                // exit();
            }
        }


        // dd($row_sum);

        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);

        $tanggal1 = $tanggal;

        // if($roster_format){

        //     $segments = explode('-', $roster_format); 
        //     $workOffPairs = [];

        //     foreach ($segments as $segment) {
        //         $parts = str_split($segment);
        //         $workOffPairs[] = intval($parts[0]); // Hari kerja
        //         $workOffPairs[] = intval($parts[1]); // Hari libur
        //     }

        //     for ($x = 0; $x < count($workOffPairs); $x += 2) {

        //         $workDay = $workOffPairs[$x];
        //         $offDay = $workOffPairs[$x + 1];

        //         $harike     = 0;
        //         $tunjanganMalam = 0;
        //         $tunjanganSiang = 0;

        //         for ($wd = 1; $wd <= $workDay; $wd++) {
        //             $harike++;

        //         }

        //         for ($od = 1; $od <= $offDay; $od++) {
        //             $harike++;

        //         }

        //     }

        // }else{

        for ($i = 1; $i <= $dayCountInMonth; $i++) {
            // echo $i.'<br/>';
            $tunjanganMalam = 0;
            $tunjanganSiang = 0;
            /* START NUMBER TITLE */
            $rowIdx++;
            $rowIdx_new++;
            $in = '';

            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if ($i < 10) {
                $ot01Column = 'ot1_d0' . $i;
                $ot02Column = 'ot2_d0' . $i;
                $ot03Column = 'ot3_d0' . $i;
                $ot04Column = 'ot4_d0' . $i;
                $timePerday = 'd0' . $i;
                $in = 'in0' . $i;
            } else {
                $ot01Column = 'ot1_d' . $i;
                $ot02Column = 'ot2_d' . $i;
                $ot03Column = 'ot3_d' . $i;
                $ot04Column = 'ot4_d' . $i;
                $timePerday = 'd' . $i;
                $in = 'in' . $i;
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];

            $strTimePerday = $row[$timePerday];


            $phCodeTmp = substr($strTimePerday, 0, 2);

            $phHoursTmp = substr($strTimePerday, 2, 5);



            if (($phCodeTmp == 'OA' || $phCodeTmp == 'HA' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN' || $phCodeTmp == 'PH' || $phCodeTmp == 'RO') && ($phHoursTmp == 0 || empty($phHoursTmp))) {
                $phHoursTmp = 0;
            }
            $outVal = (float)$inVal + (float)$phHoursTmp + 1;
            // echo $outVal.'</br>';
            // if ($outVal > 24) {
            //     $outVal = $outVal - 24;
            // } 
            // if ((double)$inVal == 0) {
            //     $outVal = 0;
            // }
            if ($strTimePerday == "STR" || $strTimePerday == "END") {
                $phHoursTmp = 0;
                $phCodeTmp = $strTimePerday;
            }

            if ($phHoursTmp == null || $phHoursTmp == '') {
                $phHoursTmp = 0;
            }



            if ($phCodeTmp == "SL" || $phCodeTmp == "AI" || $phCodeTmp == "AB" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $phHoursTmp = 0;
            }
            $totalHour = $phHoursTmp;
            if ($phCodeTmp == "AS" || $phCodeTmp == "OA" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "ON" || $phCodeTmp == "NS" || $phCodeTmp == 'DS' || $phCodeTmp == "PH" || $phCodeTmp == 'RO') {
                $tTimePerday = $phHoursTmp;
            } else {
                $tTimePerday = $row[$timePerday];
            }
            if (is_numeric($tTimePerday)) {
                $timeTotal = $tTimePerday;
                if ($tTimePerday > 1) {
                    $attendStatus = 1;
                }
            }
            // if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AB" || $phCodeTmp == "AI" || $phCodeTmp == "AL") {
            //     $absen = 1;
            // } else {
            //     $absen = 0;
            // }

            if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $absen = 1;
            } else if ($phCodeTmp == "AB" || $phCodeTmp == "AI") {
                $absen = 0;
            } else {
                $absen = 0;
            }

            if ($phCodeTmp == "END") {
                $end = 1;
                $end_var = "END";
            }

            $totalTitle = $rowIdx_new + 2;
            $wdAttendCount = $wdAttendCount + $absen;
            $timeTotal = $tTimePerday++;

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS") {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }

            $day = date('D', strtotime($tanggal));
            $dayList = array(
                'Sun' => 'Minggu',
                'Mon' => 'Senin',
                'Tue' => 'Selasa',
                'Wed' => 'Rabu',
                'Thu' => 'Kamis',
                'Fri' => 'Jumat',
                'Sat' => 'Sabtu'
            );
            $rdData =  $dayList[$day];


            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;
            // echo $normalTime." === ".$totalHour." - ".$ot01Val." - ".$ot02Val." - ".$ot03Val." - ".$ot04Val."</br>";
            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0;
            }
            $normalTotal = $normalTotal + $normalTime;
            $wDayTotal = $wDayTotal + $wDay;

            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            }
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }


            $tanggal    = date('d-M-y', strtotime($tanggal));
            $spreadsheet->getActiveSheet()->getStyle('A' . $rowIdx . ':A' . $rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('A' . $rowIdx . ':A' . $rowIdx)->applyFromArray($right);
            $spreadsheet->getActiveSheet()->setCellValue('A' . $rowIdx, $tanggal);


            $spreadsheet->getActiveSheet()
                ->setCellValue('B' . $rowIdx, $rdData)
                ->setCellValue('C' . $rowIdx, $phCodeTmp)
                ->setCellValue('D' . $rowIdx, $timeTotal)
                ->setCellValue('E' . $rowIdx, $wDay)
                ->setCellValue('F' . $rowIdx, $normalTime)
                ->setCellValue('G' . $rowIdx, $ot01Val)
                ->setCellValue('H' . $rowIdx, $ot02Val)
                ->setCellValue('I' . $rowIdx, $ot03Val)
                ->setCellValue('J' . $rowIdx, $ot04Val)
                // ->setCellValue('K' . $rowIdx, $timePerday)
            ;

            $spreadsheet->getActiveSheet()->getStyle("B" . $rowIdx . ":J" . $rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle("B" . $rowIdx . ":J" . $rowIdx)->applyFromArray($center);

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;
            $dayss = $wdAttendCount - 1;
            $dateProcessing = str_replace("-", "", $tanggal);

            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $allTimeTotal = $allTimeTotal + $phHoursTmp;
            $biodata_id = $row['biodata_id'];
            $ts_id = $row['ts_id'];
            $slip_id = $row['slip_id'];
            $allTunjangan = $malam + $siang;
            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4;
        }
        // }            

        if ($cbEnd == 1) {
            $end = 1;
            $end_var = "END";
        }

        $endDate = date('Y-m-d', strtotime('-1 Days', strtotime(date('Y-m-d', strtotime('+1 Month', strtotime($tanggal1))))));
        $startDate_tampil   = date('d F Y', strtotime($tanggal1));
        $endDate_tampil     = date('d F Y', strtotime('-1 Days', strtotime(date('Y-m-d', strtotime('+1 Month', strtotime($tanggal1))))));
        // dd($endDate);


        $spreadsheet->getActiveSheet()
            ->setCellValue('A1', 'PT. SANGATI SOERYA SEJAHTERA')
            ->setCellValue('A2', 'Slip Gaji Karyawan')
            ->setCellValue('A4', 'PT : ' . $client_display)
            ->setCellValue('A5', 'STARTDATE : ' . $startDate_tampil . ' to ' . $endDate_tampil);

        $spreadsheet->getActiveSheet()->getStyle("A1:D1")->getFont()->setBold(true)->setSize(16);
        $spreadsheet->getActiveSheet()->getStyle("A2:D2")->getFont()->setBold(true)->setSize(14)->setUnderline(true);
        $spreadsheet->getActiveSheet()->getStyle("A4:G4")->getFont()->setBold(true)->setSize(12);

        $spreadsheet->getActiveSheet()->mergeCells("A6:A7");
        $spreadsheet->getActiveSheet()->mergeCells("B6:B7");
        $spreadsheet->getActiveSheet()->mergeCells("C6:C7");
        $spreadsheet->getActiveSheet()->mergeCells("D6:D7");
        $spreadsheet->getActiveSheet()->mergeCells("E6:E7");
        $spreadsheet->getActiveSheet()->mergeCells("F6:F7");
        $spreadsheet->getActiveSheet()->mergeCells("G6:J6");

        $spreadsheet->getActiveSheet()->getStyle("A6:F7")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("G6:J7")->applyFromArray($allBorderStyle);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($center);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()
            ->setCellValue('A6', 'DATE')
            ->setCellValue('B6', 'ROSTER DAY')
            ->setCellValue('C6', 'SHIFT DAY')
            ->setCellValue('D6', 'HOURS TOTAL')
            ->setCellValue('E6', 'WORK DAY')
            ->setCellValue('F6', 'NT')
            ->setCellValue('G6', 'OVERTIME')
            ->setCellValue('G7', '1')
            ->setCellValue('H7', '2')
            ->setCellValue('I7', '3')
            ->setCellValue('J7', '4');

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($boldFont);


        $totalTitle = $rowIdx + 1;
        $spreadsheet->getActiveSheet()
            ->setCellValue('A' . $totalTitle, 'TOTAL')
            ->setCellValue('C' . $totalTitle, $wdAttendCount)
            ->setCellValue('D' . $totalTitle, $allTimeTotal)
            ->setCellValue('E' . $totalTitle, $wDayTotal)
            ->setCellValue('F' . $totalTitle, $normalTotal)
            ->setCellValue('G' . $totalTitle, $ot01Count)
            ->setCellValue('H' . $totalTitle, $ot02Count)
            ->setCellValue('I' . $totalTitle, $ot03Count)
            ->setCellValue('J' . $totalTitle, $ot04Count);

        $totalTitle_sum         = $totalTitle;
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle)->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle)->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $totalTitle = $totalTitle + 1;
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $spreadsheet->getActiveSheet()->setCellValue('A' . $totalTitle, 'TOTAL OT');
        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle . "")->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle . "")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->mergeCells("C" . $totalTitle . ":J" . $totalTitle . "");
        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle . "")->getFont()->setBold(true)->setSize(13);
        $spreadsheet->getActiveSheet()->setCellValue('C' . $totalTitle, '=SUM(G' . $totalTitle_sum . ':J' . $totalTitle_sum . ')');


        $spreadsheet->getActiveSheet()->getStyle("A43:J59")->applyFromArray($outlineBorderStyle);

        $bankName = $row['bank_name'];
        $bankNo = $row['account_no'];
        $spreadsheet->getActiveSheet()
            ->setCellValue('C43', 'Dibayarkan Oleh')
            ->setCellValue('C48', 'Payroll/ Accounting')
            ->setCellValue('C52', 'Diterima Oleh Karyawan')
            ->setCellValue('C57', $row['full_name'])
            ->setCellValue('C58', $bankName . " : " . $bankNo);

        $spreadsheet->getActiveSheet()->getStyle("L4:M4")->applyFromArray($left);
        $spreadsheet->getActiveSheet()->getStyle("L4:R43")->getFont()->setSize(13);

        $basicSalary = $monthly;
        $salaryHourly = $monthly / 173;
        $salaryDay = $basicSalary / 20;
        $upah = 0;

        if ($sPayroll == 'daily' || $sPayroll == 'Daily') {
            $upah = ($salaryDay * $wdAttendCount);
        } else if ($sPayroll == 'daily p' || $sPayroll == 'Daily p') {
            $upah = ($salaryDay * $wdAttendCount);
        } else if ($sPayroll == 'month' || $sPayroll == 'Monthly') {
            $upah = $bsProrate;
        }
        // dd($sPayroll);
        $absensi = (($alpa + $izin) * $salaryDay);

        $total_bulan_Sebelum = $day_bsProrate + ($day_siang  + $day_malam + $day_Thr + $day_bonusdll) + (($day_alpa + $day_izin) * $salaryDay) + $day_jkkjkm + $day_bpjs + $day_total_ot/* + $day_adjustment)*/;

        // echo $day_bsProrate." + 
        //         <br/>".($day_siang ." + ".$day_malam." + ".$day_Thr." + ".$day_bonusdll)." + 
        //         <br/>".(($day_alpa." + ".$day_izin) ." * ". $salaryDay)." + 
        //         <br/>".$day_jkkjkm." + ".$day_bpjs." + ".$day_total_ot;
        // exit();

        $spreadsheet->getActiveSheet()
            ->setCellValue('L4', 'NAMA')
            ->setCellValue('N4', $row['full_name'])
            ->setCellValue('O4', 'Id')
            ->setCellValue('P4', $id)
            ->setCellValue('L5', 'JABATAN')
            ->setCellValue('N5', $row['position'])
            ->setCellValue('O5', 'DEPT ')
            ->setCellValue('P5', $dept)
            ->setCellValue('L6', 'STATUS')
            ->setCellValue('N6', $row['marital_status'])
            ->setCellValue('O6', 'NPWP ')
            ->setCellValue('P6', $npwp)
            ->setCellValue('L7', 'UMK')
            ->setCellValue('N7', $basicSalary)
            ->setCellValue('O7', 'RATE/DAY')
            ->setCellValue('P7', $salaryDay)
            ->setCellValue('L8', 'RATE/HOUR')
            ->setCellValue('N8', $salaryHourly)
            ->setCellValue('L10', 'UPAH')
            ->setCellValue('P10', $upah)
            ->setCellValue('L11', 'OT 1')
            ->setCellValue('L12', 'OT 2')
            ->setCellValue('L13', 'OT 3')
            ->setCellValue('L14', 'OT 4')
        ;

        $spreadsheet->getActiveSheet()->getStyle('N7:N8')->applyFromArray($totalStyle);


        $ot1 = 1.5;
        $ot2 = 2.0;
        $ot3 = 3.0;
        $ot4 = 4.0;


        $hasilOt1 = $ot01Count * $ot1 * $salaryHourly;
        $hasilOt2 = $ot02Count * $ot2 * $salaryHourly;
        $hasilOt3 = $ot03Count * $ot3 * $salaryHourly;
        $hasilOt4 = $ot04Count * $ot4 * $salaryHourly;
        $allottotal = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4; // Total $total_ot untuk daily



        $strOT1 = number_format($ot01Count, 1) . " x " . number_format($ot1, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT2 = number_format($ot02Count, 1) . " x " . number_format($ot2, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT3 = number_format($ot03Count, 1) . " x " . number_format($ot3, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT4 = number_format($ot04Count, 1) . " x " . number_format($ot4, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";

        $spreadsheet->getActiveSheet()
            ->setCellValue('N11', $strOT1)
            ->setCellValue('O11', $hasilOt1)
            ->setCellValue('N12', $strOT2)
            ->setCellValue('O12', $hasilOt2)
            ->setCellValue('N13', $strOT3)
            ->setCellValue('O13', $hasilOt3)
            ->setCellValue('N14', $strOT4)
            ->setCellValue('O14', $hasilOt4)
            ->setCellValue('L15', 'OT TOTAL')
            ->setCellValue('P15', $allottotal);

        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($totalStyle);

        $bonusIdx = 17;
        // $Thr = $row['thr'];
        $bonusdll = $row['allowance_03'];
        $bonusTotal = $malam + $siang + $Thr + $bonusdll;

        // dd($bonusTotal);
        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $bonusIdx, 'Shift Malam')
            ->setCellValue('O' . $bonusIdx, $malam)
            ->setCellValue('L' . ($bonusIdx + 1), 'Shift Siang')
            ->setCellValue('O' . ($bonusIdx + 1), $siang)
            ->setCellValue('L' . ($bonusIdx + 2), 'THR')
            ->setCellValue('O' . ($bonusIdx + 2), $Thr)
            ->setCellValue('L' . ($bonusIdx + 3), 'Lain-lain')
            ->setCellValue('O' . ($bonusIdx + 3), $bonusdll)
            ->setCellValue('L' . ($bonusIdx + 4), 'BONUS TOTAL')
            ->setCellValue('P' . ($bonusIdx + 4), $bonusTotal);

        $spreadsheet->getActiveSheet()->getStyle('L' . ($bonusIdx + 4) . ':P' . ($bonusIdx + 4))->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . ($bonusIdx + 4) . ':P' . ($bonusIdx + 4))->applyFromArray($totalStyle);

        $govRegIdx = 23;
        $Bpjs = $basicSalary * 0.04;
        // echo $Bpjs.' '.$basicSalary;
        // exit();
        $JkkJkm = $basicSalary * 0.0204;
        $JHT2 = $basicSalary * 0.037;
        $JHT = $basicSalary * 0.02;
        $Bpjs1 = $basicSalary * 0.05;
        $JP = $basicSalary * 0.01;
        // $JkkJkm = $row['jkkjkm'];
        // $Bpjs = $row['bpjs'];
        // $JHT = $row['emp_jht'];
        // $JP = $row['emp_jp'];
        // $JHT2 = $row['jht'];
        // $Bpjs1 = $row['emp_bpjs'];
        $check = $trSlip->validasiBpjs($biodataId, $tDate1, $tDate3, $row['slip_period']);

        if (!isset($check['BPJS'])) {
            $checkBpjs1 = 0;
        } else {
            $checkBpjs1 = $check['BPJS'];
        }
        if (!isset($check['JHT'])) {
            $checkJHT1 = 0;
        } else {
            $checkJHT1 = $check['JHT'];
        }
        if (!isset($check['JP'])) {
            $checkJP1 = 0;
        } else {
            $checkJP1 = $check['JP'];
        }
        if (!isset($check['JKKJKM'])) {
            $checkJKKJKM1 = 0;
        } else {
            $checkJKKJKM1 = $check['JKKJKM'];
        }

        if ($checkBpjs == 0 || $checkBpjs1 > 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        if ($checkJHT == 0 || $checkJHT1 > 0) {
            $JHT = 0;
            $JHT2 = 0;
            // $JhtJp =0;
        }
        if ($checkJP == 0 || $checkJP1 > 0) {
            $JP = 0;
            // $JhtJp = 0;
        }
        if ($checkJKKJKM == 0 || $checkJKKJKM1 > 0) {
            $JkkJkm = 0;
        }

        if ($statusBPJS == 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        $JhtJp = $JHT + $JP;

        $trSlip->setBpjs($Bpjs);
        $trSlip->setJkkjkm($JkkJkm);
        $trSlip->setEmpJht($JHT);
        $trSlip->setEmpBpjs($Bpjs1);
        $trSlip->setEmpJp($JP);

        $trSlip->setJht($JHT2);
        $trSlip->setJhtjp($JhtJp);
        $trSlip->UpdTunjangan($ts_id);



        //   $checkBpjs = $_POST['cbHealthBPJS'];
        // $checkJHT = $_POST['cbJHT'];
        // $checkJP = $_POST['cbJP'];
        // $checkJKKJKM = $_POST['cbJKKM'];
        $subTotalVal = $JkkJkm + $Bpjs - $absensi + $adjustmentIn + $adjustmentOut;
        $brutto = $upah + $allottotal + $bonusTotal  + $subTotalVal;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $govRegIdx, 'JKK & JKM')
            ->setCellValue('O' . $govRegIdx, $JkkJkm)
            ->setCellValue('L' . ($govRegIdx + 1), 'Iuran BPJS Kesehatan(4%)')
            ->setCellValue('O' . ($govRegIdx + 1), $Bpjs)
            ->setCellValue('L' . ($govRegIdx + 2), 'Potongan Absensi')
            ->setCellValue('O' . ($govRegIdx + 2), '-' . $absensi)
            ->setCellValue('L' . ($govRegIdx + 3), 'Adjustment In')
            ->setCellValue('O' . ($govRegIdx + 3),  $adjustmentIn)
            ->setCellValue('L' . ($govRegIdx + 4), 'Adjustment Out')
            ->setCellValue('O' . ($govRegIdx + 4),  $adjustmentOut)
            ->setCellValue('L' . ($govRegIdx + 5), 'Subtotal')
            ->setCellValue('P' . ($govRegIdx + 5), $subTotalVal);
        $spreadsheet->getActiveSheet()->getStyle('L' . ($govRegIdx + 5) . ':P' . ($govRegIdx + 5))->applyFromArray($totalStyle);

        $bruttoCoordinate = $govRegIdx + 6;
        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $bruttoCoordinate, 'TOTAL KOTOR')
            ->setCellValue('P' . $bruttoCoordinate, $brutto);

        $spreadsheet->getActiveSheet()->getStyle('L' . $bruttoCoordinate . ':P' . $bruttoCoordinate)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $bruttoCoordinate . ':P' . $bruttoCoordinate)->applyFromArray($totalStyle);

        // echo $biodataId.'-'.$brutto.'-'.$status.'-'.$end.'-'.$tDate1.'-'.$tDate3;
        // exit();
        $total_bruto = $total_bulan_Sebelum + $brutto;
        // echo $noNewSheet.'<br/>';
        // dd($nama.' ||| '.$total_bulan_Sebelum ." + ". $brutto.' = '.$total_bruto);
        // exit();

        // if ($noNewSheet == 0) {
        //     $dataTax = $this->taxApi($biodataId, $total_bruto, $status, $end, $tDate1, $tDate3);
        // } else {
        $dataTax = $this->taxNoApi($biodataId, $total_bruto, $status, $end, $tDate1, $tDate3, $sPayroll);
        // }
        // dd($dataTax->tax_pinalty);
        // exit();

        /* DATA PAJAK DARI API */

        // dd($dataTax);
        $taxPinalty       = $dataTax->tax_pinalty;
        $TJabatan         = $dataTax->tunjangan_jabatan;
        $taxTot           = $dataTax->tax;
        $bruttoSetahun    = $dataTax->brutto_setahun;
        $nettoSetahun     = $dataTax->netto_setahun;
        $jpSetahun        = $dataTax->jp_setahun;
        $jhtSetahun       = $dataTax->jht_setahun;
        $ptkpTotal        = $dataTax->nilai_ptkp;
        $penghasilanPajak = $dataTax->penghasilan_pajak;
        $taxPercent1      = $dataTax->tax_percent_1;
        $taxPercent2      = $dataTax->tax_percent_2;
        $taxPercent3      = $dataTax->tax_percent_3;
        $taxPercent4      = $dataTax->tax_percent_4;
        $taxPercent5      = $dataTax->tax_percent_5;
        $taxVal1          = $dataTax->tax_val_1;
        $taxVal2          = $dataTax->tax_val_2;
        $taxVal3          = $dataTax->tax_val_3;
        $taxVal4          = $dataTax->tax_val_4;
        $taxVal5          = $dataTax->tax_val_5;
        $pembulatan       = $dataTax->pembulatan;
        $golongan         = $dataTax->golongan;
        $tarif            = $dataTax->tarif;
        $netto            = 0;
        $bonusNonReg      = 0;
        // dd($tDate1);
        if (($tDate1 == 11 or $end == 1) and $sPayroll != "Daily") { // Perubahan tanggal 16/01/2025 Karena Final di martabel bulan 11
            $taxCoordinate = 41; /* TAX ROWS COORDINATE  */
            $tmpCoordinate1 = $taxCoordinate + 17;
            $tmpCoordinate2 = 0;

            $spreadsheet->getActiveSheet()->getStyle("L" . $taxCoordinate . ":P" . ($tmpCoordinate1 - 1))->applyFromArray($outlineBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . $taxCoordinate . ':P' . ($taxCoordinate))->applyFromArray($totalStyle);
            // $tmpCoordinate1 = $taxCoordinate + 19;
            $spreadsheet->getActiveSheet()->getStyle("L" . $taxCoordinate . ":P" . $tmpCoordinate1)->getFont()->setSize(13);
            // dd($bruttoSetahun);




            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . $taxCoordinate, 'PERHITUNGAN PAJAK PENGHASILAN')
                ->setCellValue('L' . ($taxCoordinate + 1), 'Penghasilan Kotor')
                ->setCellValue('P' . ($taxCoordinate + 1), $bruttoSetahun)
                ->setCellValue('L' . ($taxCoordinate + 2), 'Iuran JHT JP')
                ->setCellValue('P' . ($taxCoordinate + 2), '-' . $jpSetahun)
                ->setCellValue('L' . ($taxCoordinate + 3), 'Iuran JHT')
                ->setCellValue('P' . ($taxCoordinate + 3), '-' . $jhtSetahun)
                ->setCellValue('L' . ($taxCoordinate + 4), 'Tunjangan Jabatan')
                ->setCellValue('P' . ($taxCoordinate + 4), '-' . $TJabatan);

            $spreadsheet->getActiveSheet()->getStyle("L" . $taxCoordinate . ":L" . $taxCoordinate)->applyFromArray($center);
            $spreadsheet->getActiveSheet()->mergeCells("L" . $taxCoordinate . ":P" . $taxCoordinate);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($taxCoordinate + 1) . ':P' . ($taxCoordinate + 1))->applyFromArray($topBorderStyle);

            // $nettoCoordinate = 45;
            // echo $netto;
            // exit();

            // $spreadsheet->getActiveSheet()->getStyle('L'.$nettoCoordinate.':P'.($nettoCoordinate))->applyFromArray($totalStyle);
            // $spreadsheet->getActiveSheet()
            //     ->setCellValue('L'.$nettoCoordinate, 'Netto')
            //     ->setCellValue('P'.$nettoCoordinate, $netton);

            $yearNettoCoordinate = 46;
            // $ptkpTotal = 0;
            $spreadsheet->getActiveSheet()->getStyle('L' . $yearNettoCoordinate . ':P' . ($yearNettoCoordinate))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . $yearNettoCoordinate, 'Netto Disetahunkan(Tetap)')
                ->setCellValue('P' . $yearNettoCoordinate, $nettoSetahun)
                ->setCellValue('L' . ($yearNettoCoordinate + 1), 'PTKP ' . $row['marital_status'])
                ->setCellValue('P' . ($yearNettoCoordinate + 1), $ptkpTotal)
                ->setCellValue('L' . ($yearNettoCoordinate + 2), 'PENGHASILAN KENA PAJAK')
                ->setCellValue('P' . ($yearNettoCoordinate + 2), $penghasilanPajak);

            $spreadsheet->getActiveSheet()->getStyle('L' . ($yearNettoCoordinate + 2) . ':P' . ($yearNettoCoordinate + 2))->applyFromArray($topBorderStyle);

            // $spreadsheet->getActiveSheet()->getStyle('L' . ($yearNettoCoordinate + 2) . ':P' . ($yearNettoCoordinate + 2))->applyFromArray($topBorderStyle);

            $tarifTaxCoordinate = $taxCoordinate + 8;
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 8) . ':P' . ($tarifTaxCoordinate + 8))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 6) . ':P' . ($tarifTaxCoordinate + 6))->applyFromArray($topBorderStyle);
            // $tarifTaxCoordinate = $taxCoordinate + 12; /* TAX ROWS COORDINATE  */

            $total_pembulatan   = $pembulatan + $penghasilanPajak;
            $total_tarif = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . ($tarifTaxCoordinate), 'Pembulatan')
                ->setCellValue('P' . ($tarifTaxCoordinate), intval($total_pembulatan))
                ->setCellValue('L' . ($tarifTaxCoordinate + 1), 'Tarif Pajak I    ' . $taxPercent1)
                ->setCellValue('P' . ($tarifTaxCoordinate + 1), $taxVal1)
                ->setCellValue('L' . ($tarifTaxCoordinate + 2), 'Tarif Pajak II    ' . $taxPercent2)
                ->setCellValue('P' . ($tarifTaxCoordinate + 2), $taxVal2)
                ->setCellValue('L' . ($tarifTaxCoordinate + 3), 'Tarif Pajak III    ' . $taxPercent3)
                ->setCellValue('P' . ($tarifTaxCoordinate + 3), $taxVal3)
                ->setCellValue('L' . ($tarifTaxCoordinate + 4), 'Tarif Pajak IV    ' . $taxPercent4)
                ->setCellValue('P' . ($tarifTaxCoordinate + 4), $taxVal4)
                ->setCellValue('L' . ($tarifTaxCoordinate + 5), 'Tarif Pajak V    ' . $taxPercent5)
                ->setCellValue('P' . ($tarifTaxCoordinate + 5), $taxVal5)
                ->setCellValue('L' . ($tarifTaxCoordinate + 6), 'Total Tarif')
                ->setCellValue('P' . ($tarifTaxCoordinate + 6), $total_tarif)
                ->setCellValue('L' . ($tarifTaxCoordinate + 7), 'Total Pajak Sebelumnya')
                ->setCellValue('P' . ($tarifTaxCoordinate + 7), $dataTax->totalTaxSebelum)
                ->setCellValue('L' . ($tarifTaxCoordinate + 8), 'Pajak Akhir')
                ->setCellValue('P' . ($tarifTaxCoordinate + 8), $taxTot);

            // $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 6) . ':P' . ($tarifTaxCoordinate + 6))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 1) . ':P' . ($tarifTaxCoordinate + 1))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 9) . ':P' . ($tarifTaxCoordinate + 9))->applyFromArray($topBorderStyle);
        }

        $outCoordinate = 31;
        $taxtotDisplay = $taxTot * (-1);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $outCoordinate, 'Pajak Penghasilan')
            ->setCellValue('N' . $outCoordinate, $golongan)
            ->setCellValue('O' . $outCoordinate, $tarif . '%')
            ->setCellValue('P' . $outCoordinate, $taxtotDisplay)
            ->setCellValue('L' . ($outCoordinate + 1), 'JKK & JKM')
            ->setCellValue('P' . ($outCoordinate + 1), '-' . $JkkJkm)
            ->setCellValue('L' . ($outCoordinate + 2), 'Iuran JHT JP')
            ->setCellValue('P' . ($outCoordinate + 2), '-' . $JhtJp)
            ->setCellValue('L' . ($outCoordinate + 3), 'Iuran BPJS Kesehatan')
            ->setCellValue('P' . ($outCoordinate + 3), '-' . $Bpjs1);

        $outCoordinate2 = $outCoordinate + 4;
        $spreadsheet->getActiveSheet()->getStyle("N" . $outCoordinate . ":O" . $outCoordinate)->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle('L' . $outCoordinate2 . ':P' . $outCoordinate2)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $outCoordinate2 . ':P' . $outCoordinate2)->applyFromArray($totalStyle);

        $cutCoordinate = 34;
        $terima = $brutto - ($taxTot + $JkkJkm + $Bpjs1 + $JhtJp);
        // echo 
        $terima_new = $terima  + $adjustment + $thrByUser;
        // dd($terima  ." + ". $adjustment ." + ". $day_adjustment);
        $ter = round($terima_new, 2);
        $number = round($ter);
        $strTerima = substr($number, -2, 6);
        // $thp = 0;
        if ($strTerima > 50) {
            $thp = $number - $strTerima + 100;
            $bulat = $thp - $ter;
        } else if ($strTerima < 50) {
            $thp = $number - $strTerima;
            $bulat = $thp - $ter;
        } else if ($strTerima == 50) {
            $thp = $number;
            $bulat = 0;
        }

        $thp = $thp;

        /* END POTONGAN */
        $cutCoordinate2 = $cutCoordinate + 5;
        $cutCoordinate3 = $cutCoordinate + 5;

        $v_adjust       = $adjustment;

        $spreadsheet->getActiveSheet()->getStyle("L" . $cutCoordinate . ":P" . $cutCoordinate3)->getFont()->setSize(13);
        $spreadsheet->getActiveSheet()->getStyle('L' . $cutCoordinate3 . ':P' . $cutCoordinate3)->applyFromArray($totalStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $cutCoordinate2 . ':P' . $cutCoordinate2)->applyFromArray($topBorderStyle);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $outCoordinate2, 'Potong Pajak')
            ->setCellValue('P' . $outCoordinate2, $terima)
            ->setCellValue('L' . ($cutCoordinate + 3), 'Adjustment/Deduction')
            ->setCellValue('N' . ($cutCoordinate + 3), '(' . $keterangan . ')')
            ->setCellValue('P' . ($cutCoordinate + 3), $v_adjust)
            ->setCellValue('L' . ($cutCoordinate + 4), 'Thr By User')
            ->setCellValue('P' . ($cutCoordinate + 4), $thrByUser)

            ->setCellValue('L' . ($cutCoordinate + 5), 'Pembulatan')
            ->setCellValue('P' . ($cutCoordinate + 5), $bulat);

        $totalgaji = round($thp);
        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . ($cutCoordinate2), 'TOTAL TERIMA')
            ->setCellValue('P' . ($cutCoordinate2), round($thp));
        $spreadsheet->getActiveSheet()
            ->getStyle('L7:P68')->getNumberFormat()
            ->setFormatCode('#,##0.00');

        $gajipokok = $upah;
        $tunjangan = $bonusTotal;
        $wdTotal = $wdAttendCount;
        $unpaid = 0;
        $taxreg = $pajakPlusSebulan;
        $taxnonreg = $pajakNonReg;
        $taxpenalty = $taxPinalty;


        $trSlip->settotalot($allottotal);
        $trSlip->setgaji($terima);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setpph21($taxTot);
        $trSlip->setwdTotal($wdTotal);
        $trSlip->setround($bulat);
        // $trSlip->setround($round);
        $trSlip->settunjangan($tunjangan);
        // $trSlip->setgajipokok($gajipokok); 
        $trSlip->setunpaid($unpaid);
        $trSlip->settaxreg($taxreg);
        $trSlip->settaxnonreg($taxnonreg);
        $trSlip->settaxpenalty($taxpenalty);
        $trSlip->setpotonganAbsensi($absensi);
        $trSlip->settunjanganJabatan($TJabatan);
        $trSlip->setnetto($netto);
        $trSlip->setbonusNonReg($bonusNonReg);
        $trSlip->setBrutto($brutto);
        $trSlip->setcheckFinal($end_var);
        $trSlip->Rep($ts_id);
        $spreadsheet->getActiveSheet()->setTitle($row['full_name']);


        $spreadsheet->getActiveSheet()->getColumnDimension('L')->setWidth(19);
        $spreadsheet->getActiveSheet()->getColumnDimension('N')->setWidth(29);
        $spreadsheet->getActiveSheet()->getColumnDimension('O')->setWidth(14);
        $spreadsheet->getActiveSheet()->getColumnDimension('P')->setWidth(23);

        $spreadsheet->setActiveSheetIndex($noNewSheet);

        unset($allBorderStyle);
        unset($center);
        unset($right);
        unset($left);




        /*s*/
        // $spreadsheet->setActiveSheetIndex(0);
        $str = $row['full_name'] . $row['bio_rec_id'] . '-' . $row['month_process'] . $row['year_process'];
        $fileName = preg_replace('/\s+/', '', $str);

        // $spreadsheet->createSheet();
        return $fileName;

        // Redirect output to a clients web browser (Xlsx)

    }

    public function Excel_split($ts_id, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $spreadsheet, $noNewSheet)
    {
        $trSlip = new M_tr_slip();
        $rpDb = new M_rp_db();
        $writer = new Xls($spreadsheet);


        $spreadsheet->getProperties()->setCreator('Maurice - Web - Android')
            ->setLastModifiedBy('Maurice - Web - Android')
            ->setTitle('Office 2007 XLSX Test Document')
            ->setSubject('Office 2007 XLSX Test Document')
            ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
            ->setKeywords('office 2007 openxml php')
            ->setCategory('Test result file');
        $boldFont = [
            'font' => [
                'bold' => true
                // 'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyle = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyles = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => 'FFFF0000'],
            ],
        ];

        $allBorderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $outlineBorderStyle = [
            'borders' => [
                'outline' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $topBorderStyle = [
            'borders' => [
                'top' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $bottomBorderStyle = [
            'borders' => [
                'bottom' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];
        $center = array();
        $center['alignment'] = array();
        $center['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER;
        $center['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $right = array();
        $right['alignment'] = array();
        $right['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_RIGHT;
        $right['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $left = array();
        $left['alignment'] = array();
        $left['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_LEFT;
        $left['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;
        $rowIdx = 0;
        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $allTimeTotal = 0;
        $normalTotal = 0;
        $wDayTotal = 0;
        $rowIdx = 8;
        $rowIdx_new = 8;
        $totalTitle_sum = 0;
        $attendStatus = 0;
        $bonusTotal = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        $penghasilanPajak = 0;
        $pajakNonReg = 0;
        $pajakPlusSebulan = 0;
        $pajakGajiSthn = 0;
        $pajakSebulan = 0;
        $tTimePerday = 0;
        $wdAttendCount = 0;
        $alpa = 0;
        $bsProrate = 0;
        $end = 0;





        $trTimesheet = new M_tr_timesheet();
        $row = $trTimesheet->Print($ts_id);
        $biodataId =  $row['biodata_id'];
        $row['bank_id'];
        $nama = $row['full_name'];
        $jabatan = $row['position'];
        $status = $row['marital_status'];
        $id = $row['biodata_id'];
        $dept = $row['dept'];
        $bpjs = $row['bpjs'];
        $monthly = $row['monthly'];
        $siang = $row['allowance_01'];
        $malam = $row['allowance_02'];
        $jk = $row['jk'];
        $jkk = $row['jkk'];
        $jkm = $row['jkm'];
        $bpjstk = $row['emp_bpjs'];
        $empjht = $row['emp_jht'];
        $jkkjkm = $row['jkkjkm'];
        $jptk = $row['emp_jp'];
        $adjustment = $row['adjustment'];
        $keterangan = $row['status_remarks'];
        $client_display = 'PT. Agincourt Resources Martabe Gold Mine';
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $npwp = $row['tax_no'];
        $sPayroll = $row['status_payroll'];
        $alpa = $row['alpa_total'];
        $izin = $row['permit_total'];
        $bsProrate = $row['real_gajipokok'];
        $statusBPJS = $row['bpjs_status'];
        $tanggal = $tDate3 . '-' . $tDate1 . '-' . $startDate;
        // echo $nama;
        // exit();
        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);
        $tanggal1 = $tanggal;
        for ($i = 1; $i <= $dayCountInMonth; $i++) {
            // echo $i.'<br/>';
            $tunjanganMalam = 0;
            $tunjanganSiang = 0;
            /* START NUMBER TITLE */
            $rowIdx++;
            $rowIdx_new++;
            $in = '';

            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if ($i < 10) {
                $ot01Column = 'ot1_d0' . $i;
                $ot02Column = 'ot2_d0' . $i;
                $ot03Column = 'ot3_d0' . $i;
                $ot04Column = 'ot4_d0' . $i;
                $timePerday = 'd0' . $i;
                $in = 'in0' . $i;
            } else {
                $ot01Column = 'ot1_d' . $i;
                $ot02Column = 'ot2_d' . $i;
                $ot03Column = 'ot3_d' . $i;
                $ot04Column = 'ot4_d' . $i;
                $timePerday = 'd' . $i;
                $in = 'in' . $i;
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];

            $strTimePerday = $row[$timePerday];


            $phCodeTmp = substr($strTimePerday, 0, 2);

            $phHoursTmp = substr($strTimePerday, 2, 5);



            if (($phCodeTmp == 'OA' || $phCodeTmp == 'HA' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN' || $phCodeTmp == 'PH' || $phCodeTmp == 'RO') && ($phHoursTmp == 0 || empty($phHoursTmp))) {
                $phHoursTmp = 0;
            }
            $outVal = (float)$inVal + (float)$phHoursTmp + 1;
            // echo $outVal.'</br>';
            // if ($outVal > 24) {
            //     $outVal = $outVal - 24;
            // } 
            // if ((double)$inVal == 0) {
            //     $outVal = 0;
            // }
            if ($strTimePerday == "STR" || $strTimePerday == "END") {
                $phHoursTmp = 0;
                $phCodeTmp = $strTimePerday;
            }

            if ($phHoursTmp == null || $phHoursTmp == '') {
                $phHoursTmp = 0;
            }



            if ($phCodeTmp == "SL" || $phCodeTmp == "AI" || $phCodeTmp == "AB" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $phHoursTmp = 0;
            }
            $totalHour = $phHoursTmp;
            if ($phCodeTmp == "AS" || $phCodeTmp == "OA" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "ON" || $phCodeTmp == "NS" || $phCodeTmp == 'DS' || $phCodeTmp == "PH" || $phCodeTmp == 'RO') {
                $tTimePerday = $phHoursTmp;
            } else {
                $tTimePerday = $row[$timePerday];
            }
            if (is_numeric($tTimePerday)) {
                $timeTotal = $tTimePerday;
                if ($tTimePerday > 1) {
                    $attendStatus = 1;
                }
            }
            // if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AB" || $phCodeTmp == "AI" || $phCodeTmp == "AL") {
            //     $absen = 1;
            // } else {
            //     $absen = 0;
            // }

            if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $absen = 1;
            } else if ($phCodeTmp == "AB" || $phCodeTmp == "AI") {
                $absen = 0;
            } else {
                $absen = 0;
            }

            if ($phCodeTmp == "END") {
                $end = 1;
            }

            $totalTitle = $rowIdx_new + 2;
            $wdAttendCount = $wdAttendCount + $absen;
            $timeTotal = $tTimePerday++;

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS") {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }

            $day = date('D', strtotime($tanggal));
            $dayList = array(
                'Sun' => 'Minggu',
                'Mon' => 'Senin',
                'Tue' => 'Selasa',
                'Wed' => 'Rabu',
                'Thu' => 'Kamis',
                'Fri' => 'Jumat',
                'Sat' => 'Sabtu'
            );
            $rdData =  $dayList[$day];


            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;

            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0;
            }
            $normalTotal = $normalTotal + $normalTime;
            $wDayTotal = $wDayTotal + $wDay;

            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            }
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }



            $spreadsheet->getActiveSheet()->getStyle('A' . $rowIdx . ':A' . $rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('A' . $rowIdx . ':A' . $rowIdx)->applyFromArray($right);
            $spreadsheet->getActiveSheet()->setCellValue('A' . $rowIdx, $tanggal);


            $spreadsheet->getActiveSheet()
                ->setCellValue('B' . $rowIdx, $rdData)
                ->setCellValue('C' . $rowIdx, $phCodeTmp)
                ->setCellValue('D' . $rowIdx, $timeTotal)
                ->setCellValue('E' . $rowIdx, $wDay)
                ->setCellValue('F' . $rowIdx, $normalTime)
                ->setCellValue('G' . $rowIdx, $ot01Val)
                ->setCellValue('H' . $rowIdx, $ot02Val)
                ->setCellValue('I' . $rowIdx, $ot03Val)
                ->setCellValue('J' . $rowIdx, $ot04Val);

            $spreadsheet->getActiveSheet()->getStyle("B" . $rowIdx . ":J" . $rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle("B" . $rowIdx . ":J" . $rowIdx)->applyFromArray($center);

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;
            $dayss = $wdAttendCount - 1;
            $dateProcessing = str_replace("-", "", $tanggal);

            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $allTimeTotal = $allTimeTotal + $phHoursTmp;
            $biodata_id = $row['biodata_id'];
            $ts_id = $row['ts_id'];
            $slip_id = $row['slip_id'];
            $allTunjangan = $malam + $siang;
            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4;
        }

        $endDate = date('Y-m-d', strtotime('-1 Days', strtotime(date('Y-m-d', strtotime('+1 Month', strtotime($tanggal1))))));
        $startDate_tampil   = date('d F Y', strtotime($tanggal1));
        $endDate_tampil     = date('d F Y', strtotime('-1 Days', strtotime(date('Y-m-d', strtotime('+1 Month', strtotime($tanggal1))))));


        $spreadsheet->getActiveSheet()->getColumnDimension('A')->setWidth(6);
        $spreadsheet->getActiveSheet()->getColumnDimension('B')->setWidth(9);
        $spreadsheet->getActiveSheet()->getColumnDimension('C')->setWidth(7);
        $spreadsheet->getActiveSheet()->getColumnDimension('D')->setWidth(8);
        $spreadsheet->getActiveSheet()->getColumnDimension('E')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('F')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('G')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('H')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('I')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('J')->setWidth(5);
        $spreadsheet->getActiveSheet()->getColumnDimension('K')->setWidth(3);
        $spreadsheet->getActiveSheet()->getColumnDimension('M')->setWidth(8);

        $spreadsheet->getActiveSheet()
            ->setCellValue('A1', 'PT. SANGATI SOERYA SEJAHTERA')
            ->setCellValue('A2', 'Slip Gaji Karyawan')
            ->setCellValue('A4', 'PT : ' . $client_display)
            ->setCellValue('A5', 'STARTDATE : ' . $startDate_tampil . ' to ' . $endDate_tampil);

        $spreadsheet->getActiveSheet()->getStyle("A1:D1")->getFont()->setBold(true)->setSize(16);
        $spreadsheet->getActiveSheet()->getStyle("A2:D2")->getFont()->setBold(true)->setSize(14)->setUnderline(true);
        $spreadsheet->getActiveSheet()->getStyle("A4:G4")->getFont()->setBold(true)->setSize(12);

        $spreadsheet->getActiveSheet()->mergeCells("A6:A7");
        $spreadsheet->getActiveSheet()->mergeCells("B6:B7");
        $spreadsheet->getActiveSheet()->mergeCells("C6:C7");
        $spreadsheet->getActiveSheet()->mergeCells("D6:D7");
        $spreadsheet->getActiveSheet()->mergeCells("E6:E7");
        $spreadsheet->getActiveSheet()->mergeCells("F6:F7");
        $spreadsheet->getActiveSheet()->mergeCells("G6:J6");

        $spreadsheet->getActiveSheet()->getStyle("A6:F7")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("G6:J7")->applyFromArray($allBorderStyle);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($center);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()
            ->setCellValue('A6', 'DATE')
            ->setCellValue('B6', 'ROSTER DAY')
            ->setCellValue('C6', 'SHIFT DAY')
            ->setCellValue('D6', 'HOURS TOTAL')
            ->setCellValue('E6', 'WORK DAY')
            ->setCellValue('F6', 'NT')
            ->setCellValue('G6', 'OVERTIME')
            ->setCellValue('G7', '1')
            ->setCellValue('H7', '2')
            ->setCellValue('I7', '3')
            ->setCellValue('J7', '4');

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($boldFont);


        $totalTitle = $rowIdx + 1;
        $spreadsheet->getActiveSheet()
            ->setCellValue('A' . $totalTitle, 'TOTAL')
            ->setCellValue('C' . $totalTitle, $wdAttendCount)
            ->setCellValue('D' . $totalTitle, $allTimeTotal)
            ->setCellValue('E' . $totalTitle, $wDayTotal)
            ->setCellValue('F' . $totalTitle, $normalTotal)
            ->setCellValue('G' . $totalTitle, $ot01Count)
            ->setCellValue('H' . $totalTitle, $ot02Count)
            ->setCellValue('I' . $totalTitle, $ot03Count)
            ->setCellValue('J' . $totalTitle, $ot04Count);

        $totalTitle_sum         = $totalTitle;
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle)->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle)->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $totalTitle = $totalTitle + 1;
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":A" . $totalTitle)->getFont()->setBold(true)->setSize(13);

        $spreadsheet->getActiveSheet()->setCellValue('A' . $totalTitle, 'TOTAL OT');
        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle . "")->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A" . $totalTitle . ":J" . $totalTitle . "")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->mergeCells("C" . $totalTitle . ":J" . $totalTitle . "");
        $spreadsheet->getActiveSheet()->getStyle("C" . $totalTitle . ":J" . $totalTitle . "")->getFont()->setBold(true)->setSize(13);
        $spreadsheet->getActiveSheet()->setCellValue('C' . $totalTitle, '=SUM(G' . $totalTitle_sum . ':J' . $totalTitle_sum . ')');


        $spreadsheet->getActiveSheet()->getStyle("A43:J59")->applyFromArray($outlineBorderStyle);

        $bankName = $row['bank_name'];
        $bankNo = $row['account_no'];
        $spreadsheet->getActiveSheet()
            ->setCellValue('C43', 'Dibayarkan Oleh')
            ->setCellValue('C48', 'Payroll/ Accounting')
            ->setCellValue('C52', 'Diterima Oleh Karyawan')
            ->setCellValue('C57', $row['full_name'])
            ->setCellValue('C58', $bankName . " : " . $bankNo);

        $spreadsheet->getActiveSheet()->getStyle("L4:M4")->applyFromArray($left);
        $spreadsheet->getActiveSheet()->getStyle("L4:R43")->getFont()->setSize(13);

        $basicSalary = $monthly;
        $salaryHourly = $monthly / 173;
        $salaryDay = $basicSalary / 20;
        $upah = 0;
        // if ($sPayroll == 'daily' || $sPayroll == 'Daily') {
        // $upah = $salaryDay * $wdAttendCount;
        // } 
        // else if ($sPayroll == 'daily p' || $sPayroll == 'Daily p') {
        // $upah = $salaryDay * $wdAttendCount;
        // }
        // else if ($sPayroll == 'month' || $sPayroll == 'Monthly') {
        $upah = $bsProrate;
        // }
        // dd($salaryDay);
        $absensi = ($alpa + $izin) * $salaryDay;

        $month_sekarang      = date('F', strtotime('+1 month', strtotime($row['year_process'] . '-' . $row['month_process'] . '-10')));
        $month_kemarin     = date('F', strtotime($row['year_process'] . '-' . $row['month_process'] . '-10'));

        // dd($row['year_process'].'-'.$row['month_process'].'-10'.' -> '.$month_kemarin.' '.$month_sekarang);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L4', 'NAMA')
            ->setCellValue('N4', $row['full_name'])
            ->setCellValue('O4', 'Id')
            ->setCellValue('P4', $id)
            ->setCellValue('L5', 'JABATAN')
            ->setCellValue('N5', $row['position'])
            ->setCellValue('O5', 'DEPT ')
            ->setCellValue('P5', $dept)
            ->setCellValue('L6', 'STATUS')
            ->setCellValue('N6', $row['marital_status'])
            ->setCellValue('O6', 'NPWP ')
            ->setCellValue('P6', $npwp)
            ->setCellValue('L7', 'UMK')
            ->setCellValue('N7', $basicSalary)
            ->setCellValue('O7', 'RATE/DAY')
            ->setCellValue('P7', $salaryDay)
            ->setCellValue('L8', 'RATE/HOUR')
            ->setCellValue('N8', $salaryHourly)
            ->setCellValue('L10', 'UPAH')

            ->setCellValue('N9', 'Periode ' . $month_kemarin)
            ->setCellValue('O9', 'Periode ' . $month_sekarang)

            ->setCellValue('N10', $row['gajisebelum'])
            ->setCellValue('O10', $row['gajisesudah'])

            ->setCellValue('P10', $upah)
            ->setCellValue('L11', 'OT 1')
            ->setCellValue('L12', 'OT 2')
            ->setCellValue('L13', 'OT 3')
            ->setCellValue('L14', 'OT 4')
        ;

        $spreadsheet->getActiveSheet()->getStyle('N7:N8')->applyFromArray($totalStyle);


        $ot1 = 1.5;
        $ot2 = 2.0;
        $ot3 = 3.0;
        $ot4 = 4.0;


        $hasilOt1 = $ot01Count * $ot1 * $salaryHourly;
        $hasilOt2 = $ot02Count * $ot2 * $salaryHourly;
        $hasilOt3 = $ot03Count * $ot3 * $salaryHourly;
        $hasilOt4 = $ot04Count * $ot4 * $salaryHourly;
        $allottotal = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;



        $strOT1 = number_format($ot01Count, 1) . " x " . number_format($ot1, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT2 = number_format($ot02Count, 1) . " x " . number_format($ot2, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT3 = number_format($ot03Count, 1) . " x " . number_format($ot3, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";
        $strOT4 = number_format($ot04Count, 1) . " x " . number_format($ot4, 1) . " x " . number_format($salaryHourly, 2) . " = Rp.";

        $spreadsheet->getActiveSheet()
            ->setCellValue('N11', $strOT1)
            ->setCellValue('O11', $hasilOt1)
            ->setCellValue('N12', $strOT2)
            ->setCellValue('O12', $hasilOt2)
            ->setCellValue('N13', $strOT3)
            ->setCellValue('O13', $hasilOt3)
            ->setCellValue('N14', $strOT4)
            ->setCellValue('O14', $hasilOt4)
            ->setCellValue('L15', 'OT TOTAL')
            ->setCellValue('P15', $allottotal);

        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($totalStyle);

        $bonusIdx = 17;
        $Thr = $row['thr'];
        $bonusdll = $row['allowance_03'];
        $bonusTotal = $malam + $siang + $Thr + $bonusdll;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $bonusIdx, 'Shift Malam')
            ->setCellValue('O' . $bonusIdx, $malam)
            ->setCellValue('L' . ($bonusIdx + 1), 'Shift Siang')
            ->setCellValue('O' . ($bonusIdx + 1), $siang)
            ->setCellValue('L' . ($bonusIdx + 2), 'THR')
            ->setCellValue('O' . ($bonusIdx + 2), $Thr)
            ->setCellValue('L' . ($bonusIdx + 3), 'Lain-lain')
            ->setCellValue('O' . ($bonusIdx + 3), $bonusdll)
            ->setCellValue('L' . ($bonusIdx + 4), 'BONUS TOTAL')
            ->setCellValue('P' . ($bonusIdx + 4), $bonusTotal);

        $spreadsheet->getActiveSheet()->getStyle('L' . ($bonusIdx + 4) . ':P' . ($bonusIdx + 4))->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . ($bonusIdx + 4) . ':P' . ($bonusIdx + 4))->applyFromArray($totalStyle);

        $govRegIdx = 23;
        $Bpjs = $basicSalary * 0.04;
        // echo $Bpjs.' '.$basicSalary;
        // exit();
        $JkkJkm = $basicSalary * 0.0204;
        $JHT2 = $basicSalary * 0.037;
        $JHT = $basicSalary * 0.02;
        $Bpjs1 = $basicSalary * 0.05;
        $JP = $basicSalary * 0.01;
        // $JkkJkm = $row['jkkjkm'];
        // $Bpjs = $row['bpjs'];
        // $JHT = $row['emp_jht'];
        // $JP = $row['emp_jp'];
        // $JHT2 = $row['jht'];
        // $Bpjs1 = $row['emp_bpjs'];
        $check = $trSlip->validasiBpjs($biodataId, $tDate1, $tDate3, $row['slip_period']);

        if (!isset($check['BPJS'])) {
            $checkBpjs1 = 0;
        } else {
            $checkBpjs1 = $check['BPJS'];
        }
        if (!isset($check['JHT'])) {
            $checkJHT1 = 0;
        } else {
            $checkJHT1 = $check['JHT'];
        }
        if (!isset($check['JP'])) {
            $checkJP1 = 0;
        } else {
            $checkJP1 = $check['JP'];
        }
        if (!isset($check['JKKJKM'])) {
            $checkJKKJKM1 = 0;
        } else {
            $checkJKKJKM1 = $check['JKKJKM'];
        }

        if ($checkBpjs == 0 || $checkBpjs1 > 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        if ($checkJHT == 0 || $checkJHT1 > 0) {
            $JHT = 0;
            $JHT2 = 0;
            // $JhtJp =0;
        }
        if ($checkJP == 0 || $checkJP1 > 0) {
            $JP = 0;
            // $JhtJp = 0;
        }
        if ($checkJKKJKM == 0 || $checkJKKJKM1 > 0) {
            $JkkJkm = 0;
        }

        if ($statusBPJS == 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        $JhtJp = $JHT + $JP;

        $trSlip->setBpjs($Bpjs);
        $trSlip->setJkkjkm($JkkJkm);
        $trSlip->setEmpJht($JHT);
        $trSlip->setEmpBpjs($Bpjs1);
        $trSlip->setEmpJp($JP);

        $trSlip->setJht($JHT2);
        $trSlip->setJhtjp($JhtJp);
        $trSlip->UpdTunjangan($ts_id);



        //   $checkBpjs = $_POST['cbHealthBPJS'];
        // $checkJHT = $_POST['cbJHT'];
        // $checkJP = $_POST['cbJP'];
        // $checkJKKJKM = $_POST['cbJKKM'];
        $subTotalVal = $JkkJkm + $Bpjs - $absensi;
        $brutto = $upah + $allottotal + $bonusTotal  + $subTotalVal;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $govRegIdx, 'JKK & JKM')
            ->setCellValue('O' . $govRegIdx, $JkkJkm)
            ->setCellValue('L' . ($govRegIdx + 1), 'Iuran BPJS Kesehatan(4%)')
            ->setCellValue('O' . ($govRegIdx + 1), $Bpjs)
            ->setCellValue('L' . ($govRegIdx + 2), 'Potongan Absensi')
            ->setCellValue('O' . ($govRegIdx + 2), '-' . $absensi)
            ->setCellValue('L' . ($govRegIdx + 3), 'Subtotal')
            ->setCellValue('P' . ($govRegIdx + 3), $subTotalVal);
        $spreadsheet->getActiveSheet()->getStyle('L' . ($govRegIdx + 3) . ':P' . ($govRegIdx + 3))->applyFromArray($totalStyle);

        $bruttoCoordinate = $govRegIdx + 4;
        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $bruttoCoordinate, 'TOTAL KOTOR')
            ->setCellValue('P' . $bruttoCoordinate, $brutto);

        $spreadsheet->getActiveSheet()->getStyle('L' . $bruttoCoordinate . ':P' . $bruttoCoordinate)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $bruttoCoordinate . ':P' . $bruttoCoordinate)->applyFromArray($totalStyle);

        // echo $biodataId.'-'.$brutto.'-'.$status.'-'.$end.'-'.$tDate1.'-'.$tDate3;
        // exit();

        $dataTax = $this->taxApi($biodataId, $brutto, $status, $end, $tDate1, $tDate3);
        // dd($dataTax);

        /* DATA PAJAK DARI API */

        $taxPinalty       = $dataTax->tax_pinalty;
        $TJabatan         = $dataTax->tunjangan_jabatan;
        $taxTot           = $dataTax->tax;
        $bruttoSetahun    = $dataTax->brutto_setahun;
        $nettoSetahun     = $dataTax->netto_setahun;
        $jpSetahun        = $dataTax->jp_setahun;
        $jhtSetahun       = $dataTax->jht_setahun;
        $ptkpTotal        = $dataTax->nilai_ptkp;
        $penghasilanPajak = $dataTax->penghasilan_pajak;
        $taxPercent1      = $dataTax->tax_percent_1;
        $taxPercent2      = $dataTax->tax_percent_2;
        $taxPercent3      = $dataTax->tax_percent_3;
        $taxPercent4      = $dataTax->tax_percent_4;
        $taxPercent5      = $dataTax->tax_percent_5;
        $taxVal1          = $dataTax->tax_val_1;
        $taxVal2          = $dataTax->tax_val_2;
        $taxVal3          = $dataTax->tax_val_3;
        $taxVal4          = $dataTax->tax_val_4;
        $taxVal5          = $dataTax->tax_val_5;
        $pembulatan       = $dataTax->pembulatan;
        $golongan         = $dataTax->golongan;
        $tarif            = $dataTax->tarif;
        $netto            = 0;
        $bonusNonReg      = 0;

        if ($tDate1 == 12) {
            $taxCoordinate = 39; /* TAX ROWS COORDINATE  */
            $tmpCoordinate1 = $taxCoordinate + 16;
            $tmpCoordinate2 = 0;

            $spreadsheet->getActiveSheet()->getStyle("L" . $taxCoordinate . ":P" . ($tmpCoordinate1 - 1))->applyFromArray($outlineBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . $taxCoordinate . ':P' . ($taxCoordinate))->applyFromArray($totalStyle);
            // $tmpCoordinate1 = $taxCoordinate + 19;
            $spreadsheet->getActiveSheet()->getStyle("L" . $taxCoordinate . ":P" . $tmpCoordinate1)->getFont()->setSize(13);





            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . $taxCoordinate, 'PERHITUNGAN PAJAK PENGHASILAN')
                ->setCellValue('L' . ($taxCoordinate + 1), 'Penghasilan Kotor')
                ->setCellValue('P' . ($taxCoordinate + 1), $bruttoSetahun)
                ->setCellValue('L' . ($taxCoordinate + 2), 'Iuran JHT JP')
                ->setCellValue('P' . ($taxCoordinate + 2), '-' . $jpSetahun)
                ->setCellValue('L' . ($taxCoordinate + 3), 'Iuran JHT')
                ->setCellValue('P' . ($taxCoordinate + 3), '-' . $jhtSetahun)
                ->setCellValue('L' . ($taxCoordinate + 4), 'Tunjangan Jabatan')
                ->setCellValue('P' . ($taxCoordinate + 4), '-' . $TJabatan);

            // $nettoCoordinate = 45;
            // echo $netto;
            // exit();

            // $spreadsheet->getActiveSheet()->getStyle('L'.$nettoCoordinate.':P'.($nettoCoordinate))->applyFromArray($totalStyle);
            // $spreadsheet->getActiveSheet()
            //     ->setCellValue('L'.$nettoCoordinate, 'Netto')
            //     ->setCellValue('P'.$nettoCoordinate, $netton);

            $yearNettoCoordinate = 44;
            // $ptkpTotal = 0;
            $spreadsheet->getActiveSheet()->getStyle('L' . $yearNettoCoordinate . ':P' . ($yearNettoCoordinate))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($yearNettoCoordinate + 3) . ':P' . ($yearNettoCoordinate + 3))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . $yearNettoCoordinate, 'Netto Disetahunkan(Tetap)')
                ->setCellValue('P' . $yearNettoCoordinate, $nettoSetahun)
                ->setCellValue('L' . ($yearNettoCoordinate + 1), 'PTKP ' . $row['marital_status'])
                ->setCellValue('P' . ($yearNettoCoordinate + 1), $ptkpTotal)
                ->setCellValue('L' . ($yearNettoCoordinate + 2), 'PENGHASILAN KENA PAJAK')
                ->setCellValue('P' . ($yearNettoCoordinate + 2), $penghasilanPajak);
            $tarifTaxCoordinate = $taxCoordinate + 8;
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 7) . ':P' . ($tarifTaxCoordinate + 7))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 6) . ':P' . ($tarifTaxCoordinate + 7))->applyFromArray($topBorderStyle);
            // $tarifTaxCoordinate = $taxCoordinate + 12; /* TAX ROWS COORDINATE  */
            $spreadsheet->getActiveSheet()
                ->setCellValue('L' . ($tarifTaxCoordinate), 'Pembulatan')
                ->setCellValue('P' . ($tarifTaxCoordinate), $pembulatan)
                ->setCellValue('L' . ($tarifTaxCoordinate + 1), 'Tarif Pajak I    ' . $taxPercent1)
                ->setCellValue('P' . ($tarifTaxCoordinate + 1), $taxVal1)
                ->setCellValue('L' . ($tarifTaxCoordinate + 2), 'Tarif Pajak II    ' . $taxPercent2)
                ->setCellValue('P' . ($tarifTaxCoordinate + 2), $taxVal2)
                ->setCellValue('L' . ($tarifTaxCoordinate + 3), 'Tarif Pajak III    ' . $taxPercent3)
                ->setCellValue('P' . ($tarifTaxCoordinate + 3), $taxVal3)
                ->setCellValue('L' . ($tarifTaxCoordinate + 4), 'Tarif Pajak IV    ' . $taxPercent4)
                ->setCellValue('P' . ($tarifTaxCoordinate + 4), $taxVal4)
                ->setCellValue('L' . ($tarifTaxCoordinate + 5), 'Tarif Pajak V    ' . $taxPercent5)
                ->setCellValue('P' . ($tarifTaxCoordinate + 5), $taxVal5)
                ->setCellValue('L' . ($tarifTaxCoordinate + 6), 'Tax Pinalty')
                ->setCellValue('P' . ($tarifTaxCoordinate + 6), $pajakGajiSthn)
                ->setCellValue('L' . ($tarifTaxCoordinate + 7), 'Pajak Akhir')
                ->setCellValue('P' . ($tarifTaxCoordinate + 7), $taxTot);

            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 6) . ':P' . ($tarifTaxCoordinate + 6))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L' . ($tarifTaxCoordinate + 6) . ':P' . ($tarifTaxCoordinate + 6))->applyFromArray($topBorderStyle);
        }

        $outCoordinate = 29;
        $taxtotDisplay = $taxTot * (-1);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $outCoordinate, 'Pajak Penghasilan')
            ->setCellValue('N' . $outCoordinate, $golongan)
            ->setCellValue('O' . $outCoordinate, $tarif . '%')
            ->setCellValue('P' . $outCoordinate, $taxtotDisplay)
            ->setCellValue('L' . ($outCoordinate + 1), 'JKK & JKM')
            ->setCellValue('P' . ($outCoordinate + 1), '-' . $JkkJkm)
            ->setCellValue('L' . ($outCoordinate + 2), 'Iuran JHT JP')
            ->setCellValue('P' . ($outCoordinate + 2), '-' . $JhtJp)
            ->setCellValue('L' . ($outCoordinate + 3), 'Iuran BPJS Kesehatan')
            ->setCellValue('P' . ($outCoordinate + 3), '-' . $Bpjs1);

        $outCoordinate2 = $outCoordinate + 4;
        $spreadsheet->getActiveSheet()->getStyle("N" . $outCoordinate . ":O" . $outCoordinate)->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle('L' . $outCoordinate2 . ':P' . $outCoordinate2)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $outCoordinate2 . ':P' . $outCoordinate2)->applyFromArray($totalStyle);

        $cutCoordinate = 32;
        $terima = $brutto - $taxTot - $JkkJkm - $Bpjs1 - $JhtJp;



        $ter = round($terima, 2);
        $number = round($ter);
        $strTerima = substr($number, -3, 6);
        // $thp = 0;
        if ($strTerima > 500) {
            $thp = $number - $strTerima + 1000;
            $bulat = $thp - $ter;
        } else if ($strTerima < 500) {
            $thp = $number - $strTerima;
            $bulat = $thp - $ter;
        } else if ($strTerima == 500) {
            $thp = $number;
            $bulat = 0;
        }

        $thp = $thp + $adjustment;

        /* END POTONGAN */
        $cutCoordinate2 = $cutCoordinate + 5;
        $cutCoordinate3 = $cutCoordinate + 5;

        $spreadsheet->getActiveSheet()->getStyle("L" . $cutCoordinate . ":P" . $cutCoordinate3)->getFont()->setSize(13);
        $spreadsheet->getActiveSheet()->getStyle('L' . $cutCoordinate3 . ':P' . $cutCoordinate3)->applyFromArray($totalStyle);
        $spreadsheet->getActiveSheet()->getStyle('L' . $cutCoordinate2 . ':P' . $cutCoordinate2)->applyFromArray($topBorderStyle);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . $outCoordinate2, 'Potong Pajak')
            ->setCellValue('P' . $outCoordinate2, $terima)
            ->setCellValue('L' . ($cutCoordinate + 3), 'Adjustment/Deduction')
            ->setCellValue('N' . ($cutCoordinate + 3), '(' . $keterangan . ')')
            ->setCellValue('P' . ($cutCoordinate + 3), $adjustment)
            ->setCellValue('L' . ($cutCoordinate + 4), 'Pembulatan')
            ->setCellValue('P' . ($cutCoordinate + 4), $bulat);

        $totalgaji = round($thp);
        $spreadsheet->getActiveSheet()
            ->setCellValue('L' . ($cutCoordinate2), 'TOTAL TERIMA')
            ->setCellValue('P' . ($cutCoordinate2), round($thp));
        $spreadsheet->getActiveSheet()
            ->getStyle('L7:P66')->getNumberFormat()
            ->setFormatCode('#,##0.00');

        $gajipokok = $upah;
        $tunjangan = $bonusTotal;
        $wdTotal = $wdAttendCount;
        $unpaid = 0;
        $taxreg = $pajakPlusSebulan;
        $taxnonreg = $pajakNonReg;
        $taxpenalty = $taxPinalty;


        $trSlip->settotalot($allottotal);
        $trSlip->setgaji($terima);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setpph21($taxTot);
        $trSlip->setwdTotal($wdTotal);
        $trSlip->setround($bulat);
        $trSlip->settunjangan($tunjangan);
        $trSlip->setgajipokok($gajipokok);
        $trSlip->setunpaid($unpaid);
        $trSlip->settaxreg($taxreg);
        $trSlip->settaxnonreg($taxnonreg);
        $trSlip->settaxpenalty($taxpenalty);
        $trSlip->setpotonganAbsensi($absensi);
        $trSlip->settunjanganJabatan($TJabatan);
        $trSlip->setnetto($netto);
        $trSlip->setbonusNonReg($bonusNonReg);
        $trSlip->setBrutto($brutto);
        $trSlip->Rep($ts_id);
        $spreadsheet->getActiveSheet()->setTitle($row['full_name']);

        $spreadsheet->setActiveSheetIndex($noNewSheet);
        /*s*/
        // $spreadsheet->setActiveSheetIndex(0);
        $str = $row['full_name'] . $row['bio_rec_id'] . '-' . $row['month_process'] . $row['year_process'];
        $fileName = preg_replace('/\s+/', '', $str);

        $spreadsheet->createSheet();
        return $fileName;

        // Redirect output to a clients web browser (Xlsx)

    }

    public function getSlipByIid($slipId)
    {
        $slip = new M_tr_slip();
        $row = $slip->getSlipById($slipId);
        $myData = array();
        // dd($row);
        // echo $slipId;
        // exit();
        $myData[0] = $row['slip_id'];
        $myData[1] = $row['full_name'];
        $myData[2] = $row['thr'];
        $myData[3] = $row['allowance_03'];
        $myData[4] = $row['adjustment'];
        $myData[5] = $row['status_remarks'];
        $myData[6] = $row['adjustment_in'];
        $myData[7] = $row['adjustment_out'];
        $myData[8] = $row['thr_by_user'];
        echo json_encode($myData);
    }

    public function printAllSM($tahun, $bulan, $startDate, $sm, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $isEnd)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $query = $data_proses->getTs_Id($sm);

        ini_set('max_execution_time', 2400); //300 seconds = 5 minutes
        ini_set('memory_limit', '512M');

        $spreadsheet = new Spreadsheet();
        $spreadsheet->setActiveSheetIndex(0);
        $spreadsheet->createSheet();
        $noNewSheet = 1;
        $count = 0;
        foreach ($query as $row) {
            // $count++;
            $ts_id = $row['ts_id'];
            // buat sheet baru hanya untuk iterasi ke-1 ke atas
            if ($noNewSheet > 0) {
                $spreadsheet->createSheet();
            }

            // AGAR MATCH BIODATA_ID-NIE DI SLIP & SALARY DENGAN BIODATA_ID-NIE DI ROSTER
            $this->Excel($ts_id, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $isEnd, $spreadsheet, $noNewSheet);
            unset($row);
            $noNewSheet++;
            // echo $noNewSheet;
        }
        // echo $count;
        // exit();
        // $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet'));
        // $spreadsheet->removeSheetByIndex($sheetIndex);
        // $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet 1'));
        // $spreadsheet->removeSheetByIndex($sheetIndex);
        // Redirect output to a client?s web browser (Xlsx)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="' . $sm . $tahun . $bulan . $startDate . '.Xlsx"');
        // header('Content-Disposition: attachment;filename="Report Excel.xlsx"');
        header('Cache-Control: max-age=0');
        // If you're serving to IE 9, then the following may be needed
        header('Cache-Control: max-age=1');

        // If you're serving to IE over SSL, then the following may be needed
        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
        header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT'); // always modified
        header('Cache-Control: cache, must-revalidate'); // HTTP/1.1
        header('Pragma: public'); // HTTP/1.0
        /* BY COMPOSER */
        $writer = new Xlsx($spreadsheet);
        /* OFFLINE/ BY COPY EXCEL FOLDER  */
        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');
        $writer->save('php://output');
        exit(0);
    }

    public function toExcel($tsId, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $cbEnd)
    {
        $spreadsheet = new Spreadsheet();
        $spreadsheet->createSheet();
        $fileName = $this->Excel($tsId, $checkBpjs, $checkJHT, $checkJP, $checkJKKJKM, $cbEnd, $spreadsheet, 0);
        $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet 1'));
        $spreadsheet->removeSheetByIndex($sheetIndex);
        // Redirect output to a client?s web browser (Xlsx)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="' . $fileName . '.Xlsx"');
        // header('Content-Disposition: attachment;filename="Report Excel.xlsx"');
        header('Cache-Control: max-age=0');
        // If you're serving to IE 9, then the following may be needed
        header('Cache-Control: max-age=1');

        // If you're serving to IE over SSL, then the following may be needed
        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
        header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT'); // always modified
        header('Cache-Control: cache, must-revalidate'); // HTTP/1.1
        header('Pragma: public'); // HTTP/1.0
        /* BY COMPOSER */
        $writer = new Xlsx($spreadsheet);
        /* OFFLINE/ BY COPY EXCEL FOLDER  */
        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');
        $writer->save('php://output');
        // $writer->save('./mobile_file/'.$fileName.'.xlsx');
        exit(0);
    }

    public function taxApi($biodata_id, $brutto, $marital, $end, $month, $year)
    {
        // Mengambil instance dari HTTP Request
        $request = service('request');

        // URL API yang akan dipanggil
        // $apiUrl = 'http://localhost:81/api-tax-martabe/public/api/posts';
        // $apiUrl = 'http://192.168.10.12/api-tax-test-local/public/api/posts';

        // Data yang akan dikirim sebagai body request
        $postData = [
            'biodata_id' => $biodata_id,
            'brutto'     => $brutto,
            'marital'    => $marital,
            'end'        => $end,
            'month'      => $month,
            'year'       => $year,
        ];
        // dd($postData);
        // exit();
        // Inisialisasi Curl
        $ch = curl_init();

        // Set konfigurasi Curl
        curl_setopt($ch, CURLOPT_URL, $apiUrl);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        // Eksekusi Curl dan dapatkan respons
        $response = curl_exec($ch);

        // Menutup koneksi Curl
        curl_close($ch);

        // Menampilkan hasil response dari API
        $response = json_decode($response);

        return $response->data;
    }

    public function taxNoApi($biodata_id, $brutto, $marital, $end, $bulan, $tahun, $sPayroll)
    {
        // $biodata_id = $biodata_id;
        // // dd($biodata_id);
        // $brutto     = $brutto;
        // $marital    = $marital;
        // $end        = $end;
        // $bulan      = $month;
        // $tahun      = $year;

        $penghasilanPajak      = 0;
        $penghasilanPajakBulat = 0;
        $taxVal1               = 0;
        $taxVal2               = 0;
        $taxVal3               = 0;
        $taxVal4               = 0;
        $taxVal5               = 0;

        $taxPercent1           = "5%";
        $taxPercent2           = "15%";
        $taxPercent3           = "25%";
        $taxPercent4           = "30%";
        $taxPercent5           = "35%";

        /* PTKP SESUAI MARITAL */
        if ($marital == "TK0") {
            $ptkpTotal = 54000000;
        } else if ($marital == "K0") {
            $ptkpTotal = 58500000;
        } else if ($marital == "K1") {
            $ptkpTotal = 63000000;
        } else if ($marital == "K2") {
            $ptkpTotal = 67500000;
        } else if ($marital == "K3") {
            $ptkpTotal = 72000000;
        } else {
            $ptkpTotal = 0;
        }

        $taxPinalty       = 0;
        $nettoSetahun     = 0;
        $tunjanganJabatan = 0;
        $bruttoSetahuan   = 0;
        $netto            = 0;
        $jp               = 0;
        $jht              = 0;
        $bulat            = 0;
        $tarif            = 0;
        $golongan         = '';

        if (($bulan == 11 or $end == 1) and $sPayroll != "Daily") { // Untuk daily tidak ada perhitungan final. (2025/11/20)
            // if ($bulan == 11 OR $end==1) { // Perubahan tanggal 16/01/2025 Karena Final di martabel bulan 11
            $model     = new m_tr_slip();
            // $modelBio  = new m_biodata();

            $data                  = $model->getDataTax($biodata_id, $bulan, $tahun);
            $data_bpjs             = $model->getDataBpjs($biodata_id, $bulan, $tahun); // Penambahan Query untuk BPJS 23-12-2025
            // dd($data->total_jht);
            // $dataBPJS              = $model->getDataBpjs($biodata_id, $bulan, $tahun);
            // $dataBio               = $modelBio->getDataBio($biodata_id);

            // dd($data->total_kotor." + ".$brutto);
            $bruttoSetahuan        = $data->total_kotor + $brutto;
            $tax                   = $data->total_pph21;
            $totalTaxSebelumFinal  = $data->total_pph21;
            if ($bulan == 12) {
                $bruttoSetahuan        = $data->total_kotor;
                $totalTaxSebelumFinal  = 0;
                $tax                   = 0;
            }
            $jp                    = $data_bpjs->total_jp;
            $jht                   = $data_bpjs->total_jht;
            // $npwp                  = isset($dataBio['tax_no']) ? $dataBio['tax_no'] : 0;
            $tunjanganJabatan      = $bruttoSetahuan * (5 / 100);

            if ($tunjanganJabatan >= 6000000) {
                $tunjanganJabatan = 6000000;
            }

            $nettoSetahun     = $bruttoSetahuan - $jp - $jht - $tunjanganJabatan;


            if ($nettoSetahun >= $ptkpTotal) {

                $penghasilanPajak           = $nettoSetahun - $ptkpTotal;
                $penghasilanPajakBulatTer   = round($penghasilanPajak, 2);
                $penghasilanPajakBulat      = round($penghasilanPajak);
                $strTerima                  = substr($penghasilanPajakBulat, -3, 6);

                if ($strTerima > 500) {
                    $totalPembulatan = $penghasilanPajakBulat - $strTerima + 1000;
                    $bulat           = $totalPembulatan - $penghasilanPajakBulatTer;
                } else if ($strTerima < 500) {
                    $totalPembulatan = $penghasilanPajakBulat - $strTerima;
                    $bulat           = $totalPembulatan - $penghasilanPajakBulatTer;
                } else if ($strTerima == 500) {
                    $totalPembulatan = $penghasilanPajakBulatTer;
                    $bulat           = 0;
                }

                // $penghasilanPajakPembulatan     = $penghasilanPajakBulat - $bulat;
                $maxPajak1 = $totalPembulatan - 60000000;
                if ($totalPembulatan > 60000000) {
                    $taxVal2 = $maxPajak1 * 0.15;
                }
                if ($totalPembulatan >= 60000000) {
                    $taxVal1 = 3000000;
                }

                $maxPajak2 = $maxPajak1 - 190000000;
                if ($maxPajak1 >= 190000000) {
                    $taxVal2 = 28500000;
                }

                if ($maxPajak1 > 190000000) {
                    $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
                }

                $maxPajak3 = $maxPajak2 - 250000000;
                if ($maxPajak2 >= 250000000) {
                    $taxVal3 = 62500000;
                }
                if ($maxPajak2 > 250000000) {
                    $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
                }
                $maxPajak4 = $maxPajak3 - 4500000000;
                if ($maxPajak3 > 4500000000) {
                    $taxVal4 = 1350000000;
                }
                if ($maxPajak4 > 4500000000) {
                    $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
                }
            }


            // $penghasilanPajakPembulatan     = $penghasilanPajakBulat - $bulat;
            // dd($penghasilanPajakPembulatan.' '.$penghasilanPajakBulat.' '.$bulat.' '.$totalPembulatan);


            $pajakGajiSthn  = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            // dd($pajakGajiSthn);
            $pajakSebulan   = $pajakGajiSthn - $tax;
            $taxPinalty     = 0;
            // if ($npwp == '' || $npwp == 0 || $npwp == 'None') {
            //     $taxPinalty = $pajakSebulan * 0.20;
            // }

            $pajak                 = floor($pajakSebulan);


            $disini = 1;
        } else {
            // $model                 = new m_tax(); 
            $getDataTer            = "SELECT mst_tax_golongan.marital AS STATUS, mst_tax_config.tarif, mst_tax_golongan.golongan FROM mst_tax_golongan
                                        JOIN mst_tax_config ON mst_tax_golongan.golongan = mst_tax_config.golongan
                                        WHERE " . $brutto . " BETWEEN mst_tax_config.start_brutto AND mst_tax_config.end_brutto
                                        AND mst_tax_golongan.marital = '" . $marital . "' LIMIT 1";

            $data                  = $this->db->query($getDataTer)->getRowArray();
            // dd($data);
            $pajak                 = floor($brutto * ($data['tarif'] / 100));
            $tarif                 = $data['tarif'];
            $golongan              = $data['golongan'];
            $totalTaxSebelumFinal  = 0;
            $disini = 2;
        }

        $json['data']              = $data;
        $json['totalTaxSebelum']   = $totalTaxSebelumFinal;
        $json['tax']               = $pajak;
        $json['tax_pinalty']       = $taxPinalty;
        $json['netto_setahun']     = $nettoSetahun;
        $json['marital']           = $marital;
        $json['golongan']          = $golongan;
        $json['tunjangan_jabatan'] = $tunjanganJabatan;
        $json['brutto_setahun']    = $bruttoSetahuan;
        $json['jp_setahun']        = $jp;
        $json['jht_setahun']       = $jht;
        $json['penghasilan_pajak'] = $penghasilanPajakBulat;
        $json['pembulatan']        = $bulat;
        $json['tax_val_1']         = $taxVal1;
        $json['tax_val_2']         = $taxVal2;
        $json['tax_val_3']         = $taxVal3;
        $json['tax_val_4']         = $taxVal4;
        $json['tax_val_5']         = $taxVal5;
        $json['tax_percent_1']     = $taxPercent1;
        $json['tax_percent_2']     = $taxPercent2;
        $json['tax_percent_3']     = $taxPercent3;
        $json['tax_percent_4']     = $taxPercent4;
        $json['tax_percent_5']     = $taxPercent5;
        $json['nilai_ptkp']        = $ptkpTotal;
        $json['tarif']             = $tarif;
        // dd($json);
        return (object)$json;
    }

    function checkClosingPayrollByPeriod()
    {
        $month      = $this->request->getPost('monthPeriod');
        $year       = $this->request->getPost('yearPeriod');
        $client     = $this->request->getPost('client');


        $trTimesheet = new M_tr_timesheet();
        $dataCount  = $trTimesheet->getDataClosing($client, $year, $month);

        $data_array = array(
            "data_count" => count($dataCount)
        );

        echo json_encode($data_array);
    }
}
