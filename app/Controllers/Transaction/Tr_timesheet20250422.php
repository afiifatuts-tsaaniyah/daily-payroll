<?php namespace App\Controllers\Transaction; 
/*********************************************************************
 *  Created By       : Generator Version 1.0.23                      *
 *  Created Date     : Apr 06, 2022                                  *
 *  Description      : All code generated by controller generator    *
 *  Generator Author : Tommy Maurice(tommy_maurice@yahoo.com)        *
 *********************************************************************/
use CodeIgniter\Controller;
use App\Controllers\BaseController;



use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\Writer\Xls;
use PhpOffice\PhpSpreadsheet\IOFactory;
use App\Models\Transaction\M_tr_timesheet;
use App\Models\Transaction\M_upload;
use App\Models\Transaction\M_proses;
use App\Models\Transaction\M_tr_overtime;
use App\Models\Transaction\M_tr_slip;
use App\Models\Transaction\M_rp_db;

class Tr_timesheet extends BaseController
{
    // public function __construct()
    // {
    //     parent::__construct();
    //     $this->db = \Config\Database::connect('', false);
    // }

    /* START INDEX FUNCTION */
    public function index(){
         /* ***Using Valid Path */
         $data['actView'] = 'Transaction/v_tr_timesheet';
         return view('home', $data);
    }
    /* END INDEX FUNCTION */
    /* START INPUT FUNCTION */
    public function ins_view(){
        /* ***Using Valid Path */
        $data['actView'] = '../ins_tr_timesheet';
        return view('home', $data);
    }
    /* END INPUT FUNCTION */
    /* START UPDATE FUNCTION */
    public function upd_view(){
        $trTimesheet = new M_tr_timesheet();
        $data['trTimesheet'] = $trTimesheet->getById($ts_id);
        /* ***Using Valid Path */
        $data['actView'] = '../upd_tr_timesheet';
        return view('home', $data);
    }
    /* END UPDATE FUNCTION */
    /* START INSERT */
    public function ins(){

        $trTimesheet = new M_tr_timesheet();
        $trTimesheet->resetValues();
        $trTimesheet->setTsId($_POST['tsId']);
        $trTimesheet->setBiodataId($_POST['biodataId']);
        $trTimesheet->setBadgeNo($_POST['badgeNo']);
        $trTimesheet->setFullName($_POST['fullName']);
        $trTimesheet->setPayrollBase($_POST['payrollBase']);
        $trTimesheet->setClientName($_POST['clientName']);
        $trTimesheet->setDept($_POST['dept']);
        $trTimesheet->setMonthProcess($_POST['monthProcess']);
        $trTimesheet->setYearProcess($_POST['yearProcess']);
        $trTimesheet->setPeriodNo($_POST['periodNo']);
        $trTimesheet->setPassDay($_POST['passDay']);
        $trTimesheet->setD01($_POST['d01']);
        $trTimesheet->setD02($_POST['d02']);
        $trTimesheet->setD03($_POST['d03']);
        $trTimesheet->setD04($_POST['d04']);
        $trTimesheet->setD05($_POST['d05']);
        $trTimesheet->setD06($_POST['d06']);
        $trTimesheet->setD07($_POST['d07']);
        $trTimesheet->setD08($_POST['d08']);
        $trTimesheet->setD09($_POST['d09']);
        $trTimesheet->setD10($_POST['d10']);
        $trTimesheet->setD11($_POST['d11']);
        $trTimesheet->setD12($_POST['d12']);
        $trTimesheet->setD13($_POST['d13']);
        $trTimesheet->setD14($_POST['d14']);
        $trTimesheet->setD15($_POST['d15']);
        $trTimesheet->setD16($_POST['d16']);
        $trTimesheet->setD17($_POST['d17']);
        $trTimesheet->setD18($_POST['d18']);
        $trTimesheet->setD19($_POST['d19']);
        $trTimesheet->setD20($_POST['d20']);
        $trTimesheet->setD21($_POST['d21']);
        $trTimesheet->setD22($_POST['d22']);
        $trTimesheet->setD23($_POST['d23']);
        $trTimesheet->setD24($_POST['d24']);
        $trTimesheet->setD25($_POST['d25']);
        $trTimesheet->setD26($_POST['d26']);
        $trTimesheet->setD27($_POST['d27']);
        $trTimesheet->setD28($_POST['d28']);
        $trTimesheet->setD29($_POST['d29']);
        $trTimesheet->setD30($_POST['d30']);
        $trTimesheet->setD31($_POST['d31']);
        $trTimesheet->setIsActive($_POST['isActive']);
        $trTimesheet->setPicProcess($_POST['picProcess']);
        $trTimesheet->setProcessTime($_POST['processTime']);
        $trTimesheet->ins();
    }
    /* END INSERT */
    /* START UPDATE */
    public function upd(){

        $id = $_POST['tsId'];
        $trTimesheet = new M_tr_timesheet();
        $trTimesheet->setObjectById($id);
        $trTimesheet->setTsId($_POST['tsId']);
        $trTimesheet->setBiodataId($_POST['biodataId']);
        $trTimesheet->setBadgeNo($_POST['badgeNo']);
        $trTimesheet->setFullName($_POST['fullName']);
        $trTimesheet->setPayrollBase($_POST['payrollBase']);
        $trTimesheet->setClientName($_POST['clientName']);
        $trTimesheet->setDept($_POST['dept']);
        $trTimesheet->setMonthProcess($_POST['monthProcess']);
        $trTimesheet->setYearProcess($_POST['yearProcess']);
        $trTimesheet->setPeriodNo($_POST['periodNo']);
        $trTimesheet->setPassDay($_POST['passDay']);
        $trTimesheet->setD01($_POST['d01']);
        $trTimesheet->setD02($_POST['d02']);
        $trTimesheet->setD03($_POST['d03']);
        $trTimesheet->setD04($_POST['d04']);
        $trTimesheet->setD05($_POST['d05']);
        $trTimesheet->setD06($_POST['d06']);
        $trTimesheet->setD07($_POST['d07']);
        $trTimesheet->setD08($_POST['d08']);
        $trTimesheet->setD09($_POST['d09']);
        $trTimesheet->setD10($_POST['d10']);
        $trTimesheet->setD11($_POST['d11']);
        $trTimesheet->setD12($_POST['d12']);
        $trTimesheet->setD13($_POST['d13']);
        $trTimesheet->setD14($_POST['d14']);
        $trTimesheet->setD15($_POST['d15']);
        $trTimesheet->setD16($_POST['d16']);
        $trTimesheet->setD17($_POST['d17']);
        $trTimesheet->setD18($_POST['d18']);
        $trTimesheet->setD19($_POST['d19']);
        $trTimesheet->setD20($_POST['d20']);
        $trTimesheet->setD21($_POST['d21']);
        $trTimesheet->setD22($_POST['d22']);
        $trTimesheet->setD23($_POST['d23']);
        $trTimesheet->setD24($_POST['d24']);
        $trTimesheet->setD25($_POST['d25']);
        $trTimesheet->setD26($_POST['d26']);
        $trTimesheet->setD27($_POST['d27']);
        $trTimesheet->setD28($_POST['d28']);
        $trTimesheet->setD29($_POST['d29']);
        $trTimesheet->setD30($_POST['d30']);
        $trTimesheet->setD31($_POST['d31']);
        $trTimesheet->setIsActive($_POST['isActive']);
        $trTimesheet->setPicProcess($_POST['picProcess']);
        $trTimesheet->setProcessTime($_POST['processTime']);
        $trTimesheet->upd($id);

        
    }
    /* END UPDATE */

    public function validasiCheck($tahun,$bulan,$startDate,$sm)
    {
        $model = new M_tr_slip();
        $data = $model->getValidasiData($startDate,$tahun,$bulan,$sm);
        if (!empty($data)) {
            echo 'true';
        } else {
            echo 'false';
        }
    }

    /* START DELETE */
    public function del(){
        $trTimesheet = new M_tr_timesheet();
        $id = $_POST['tsId'];
        $trTimesheet->del($id);
    }
    public function Proses_split($tahun,$bulan,$startDate,$sm)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $data = $data_proses->proses($sm);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // dd($data);
        // echo $checkBpjs;
        // exit();
        

        $trOvertime = new M_tr_overtime();
        foreach ($data as $row) {
            $bioId = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0; 
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall=0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;



            for ($i=1; $i <= 31 ; $i++){
                $dayIndex++;
                // echo $i;
                if ($i < 10){
                    $cek = 'd0'.$i;
                }else{
                    $cek = 'd'.$i;
                }     
                $data = trim($row[$cek]);
                $SM = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];
                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm/20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];
                    

                $code = substr($data,0,2);
                $hours = substr($data,2,5);

                if ($hours == null || $hours == '') {
                    $hours = 0;
                }

                $end    = '';
                if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                    if ($data == 'STR' || $data == 'END') {
                        $standByCount++;
                        $hours = 0;

                        $end    = "END";
                    }
                }

                if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                    $hours = 0;
                }

                if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                    $hours = 0;
                }

                if ($code == 'DS') {
                  $daily++;
                }

                if ($code == 'AI') {
                  $ppt++;
                }

                if ($code == 'SL') {
                  $sick++;
                }

                if ($code == 'AB') {
                  $alpa++;             
                }

                if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                  $attend++;
                }

                if ($code == 'HA' || $code == 'HN') {
                 $ph++;
                }

                $ot1 = 0;
                $ot2 = 0;
                $ot3 = 0;
                $ot4 = 0;
                $ot5 = 0;
                // dd($hours);
                $ot = $hours - 8;
                $otoff = $hours - 7;

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    if ($ot > 0) {
                        if ($ot < 1) {
                            $ot1 = $hours - 8;
                        } else {
                            $ot1 = 1;
                        }
                        $ot2 = $hours - 9;
                        // echo $hours.'</br>';
                    } 
                    else if ($ot > 0 && $ot < 1) {
                        $ot1 = $ot;
                    }
                    else {
                        $ot1 = 0;
                        $ot2 = 0;
                    }
                }
                // echo $ot1;
                if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }
                if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }


                if ($code == 'OF') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;  
                    }
                }

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {  
                 $nilai++;
                }
                if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                    $a++;
                } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                    $b++;
                }
                $allowanceAfternoon = $a;     
                $allowanceNight = $b;

                if ($ot1 <= 0) {
                    $ot1 = 0 ;
                } 
                if ($ot2 <= 0) {
                    $ot2 = 0 ;
                }
                if ($ot3 <= 0) {
                    $ot3 = 0 ;
                }
                if ($ot4 <= 0) {
                    $ot4 = 0 ;
                }
               // echo $hours.'-'.$ot1.'</br>';
                
                if ($dayIndex < 10) {
                    $ot01Column = 'setOt1D0'.$dayIndex;    
                    $ot02Column = 'setOt2D0'.$dayIndex;    
                    $ot03Column = 'setOt3D0'.$dayIndex;    
                    $ot04Column = 'setOt4D0'.$dayIndex;
                } else {
                    $ot01Column = 'setOt1D'.$dayIndex;    
                    $ot02Column = 'setOt2D'.$dayIndex;    
                    $ot03Column = 'setOt3D'.$dayIndex;    
                    $ot04Column = 'setOt4D'.$dayIndex; 
                }   
        
                    $userId = $_SESSION['uId'];
                    $currDateTm = date("Y-m-d H:i:s");
                 
                    $trOvertime->$ot01Column($ot1);
                    $trOvertime->$ot02Column($ot2);
                    $trOvertime->$ot03Column($ot3);
                    $trOvertime->$ot04Column($ot4);

                if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                    $absen = 1;
                } else {
                    $absen = 0;
                }
                    $ot1b = $ot1 + $ot1b;
                    $ot2b = $ot2 + $ot2b;
                    $ot3b = $ot3 + $ot3b;
                    $ot4b = $ot4 + $ot4b;   

                    
                    // echo $totall."<br>";
                    $wd = $absen + $wd;

                    
                              
             

            // echo $ot2.'</br>';
            }   

            if($wd>=20){
                $wd=20;
            }

            // exit();
            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot+$totall;


                
            $gaji = $bsm * $wd;

            $month_process      = $row['month_process'];
            $year_process       = $row['year_process'];
            $biodata_id         = $row['biodata_id'];

            $month_sebelum      = date('m', strtotime('-1 month', strtotime($year_process.'-'.$month_process.'-10')));
            $year_sebelum       = date('Y', strtotime('-1 month', strtotime($year_process.'-'.$month_process.'-10')));

            $stQuerySekarang    = "SELECT b.biodata_id,b.monthly,b.daily FROM mt_salary b WHERE b.biodata_id='".$biodata_id."' ";
            $data_sekarang      = $this->db->query($stQuerySekarang)->getRowArray(); 
            // dd($data_sekarang);

            $stQuerySebelum     = "SELECT a.work_total, a.gajipokok, (a.gajipokok/a.work_total) as daily
                                    FROM tr_slip a 
                                    WHERE a.biodata_id='".$biodata_id."' AND a.year_period='".$year_sebelum."' AND a.month_period='".$month_sebelum."'";
            $data_sebelum       = $this->db->query($stQuerySebelum)->getRowArray(); 
            // dd($data_sebelum);
            // dd(number_format($data_sebelum['daily'], 0, ".", "").' '.number_format($data_sekarang['daily'], 0, ".", ""));
            // if($data_sebelum){
            //     if(number_format($data_sebelum['daily'], 0, ".", "") !== number_format($data_sekarang['daily'], 0, ".", "")){
            //         $gaji_sebelum       = $count_sebelum * number_format($data_sebelum['daily'], 0, ".", "");
            //         $gaji_sesudah       = $count_sesudah * number_format($data_sekarang['daily'], 0, ".", "");

            //         $gaji               = $gaji_sebelum + $gaji_sesudah;
            //         // echo $gaji_sebelum.' '.$gaji_sesudah.' = '.$gaji; 
            //     }
            // }else{
            //     $gaji_sesudah   = $gaji;
            //     $gaji_sebelum   = 0;
            // }

            $bsProrate = $gaji;
            
            
            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($standByCount != 0) {
                    $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    $bsProrate = ($monthly / 20) * ($wd); 
                } else {
                    $bsProrate = $monthly;
                }
                $gaji = $bsProrate;
            }
            
            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;
        

        
           
            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;
        

        
            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;
        

        
            $empjp = $monthly * 0.01;
            
            
            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            $tunjabatan = $totalgaji * 0.05;           
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;
            
            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            }else if ($status == "K0") {
                $ptkpTotal = 58500000;
            }else if ($status == "K1") {
                $ptkpTotal = 63000000;
            }else if ($status == "K2") {
                $ptkpTotal = 67500000;
            }else if ($status == "K3") {
                $ptkpTotal = 72000000;
            }else{
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";
            /*echo $ptkpTotal;
            exit();*/
            $penghasilanPajak = 0 ;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0;
                $taxVal5 = 0;
            }
            
            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15 ;
            }
            if ($penghasilanPajak >= 60000000 ) {
                $taxVal1 = 3000000;     
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }       
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000 ) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            $pajakPlusSebulan = $pajakGajiSthn / 12;

            
               
               
            
            $ter = round($totalkotor);
            $strTerima = substr($ter,-3);
            $thp = 0;
            if ($strTerima < 500) {
                $thp = $ter - $strTerima;
            } 
            if ($strTerima > 500){
                $thp = $ter - $strTerima + 1000;
            }
            $round = $thp - $totalkotor;
            // $checkData = $data_proses->cekIdTimesheet($ts_id);
           
            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setslipPeriod($SDate);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();
            

                
            
            
            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioId);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setstand_by_count($standByCount);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($gaji);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($SM);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->setcheckFinal($end);
            $trSlip->ins();
        }
        

          
                // echo "Process Succeed...";
        echo $this->getPayrollList($tahun,$bulan,$startDate,$sm);
           

    }

    public function Proses($tahun,$bulan,$startDate,$sm)
    {
      $data_proses = new M_tr_timesheet();
      $data_proses->setMonthProcess($bulan);
      $data_proses->setYearProcess($tahun);
      $data_proses->setstartDate($startDate);
      $data = $data_proses->proses($sm);
      $trSlip = new M_tr_slip();
      $trSlip->resetValues();
      
      // dd($data);
      // echo $checkBpjs;
      // exit();
        

        $trOvertime = new M_tr_overtime();
        foreach ($data as $row) {
            $bioId = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0; 
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall=0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;



            $end    = '';
            for ($i=1; $i <= 31 ; $i++){
                $dayIndex++;
                // echo $i;
                if ($i < 10){
                    $cek = 'd0'.$i;
                }else{
                    $cek = 'd'.$i;
                }     
                $data = trim($row[$cek]);
                $SM = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];
                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm/20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];
                    

                $code = substr($data,0,2);
                $hours = substr($data,2,5);
                // dd($data.' '.$statusSalary.' '.$row['full_name']);

                if ($hours == null || $hours == '') {
                    $hours = 0;
                }

                if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                    if ($data == 'END') {
                        $standByCount++;
                        $hours = 0;

                        $end    = "END";
                    }else if($data == 'STR'){
                        $standByCount++;
                        $hours = 0;
                    }
                }

                if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                    $hours = 0;
                }

                if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                    $hours = 0;
                }

                if ($code == 'DS') {
                  $daily++;
                }

                if ($code == 'AI') {
                  $ppt++;
                }

                if ($code == 'SL') {
                  $sick++;
                }

                if ($code == 'AB') {
                  $alpa++;             
                }

                if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                  $attend++;
                }

                if ($code == 'HA' || $code == 'HN') {
                 $ph++;
                }

                $ot1 = 0;
                $ot2 = 0;
                $ot3 = 0;
                $ot4 = 0;
                $ot5 = 0;
                // dd($hours);
                $ot = $hours - 8;
                $otoff = $hours - 7;

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    if ($ot > 0) {
                        if ($ot < 1) {
                            $ot1 = $hours - 8;
                        } else {
                            $ot1 = 1;
                        }
                        $ot2 = $hours - 9;
                        // echo $hours.'</br>';
                    } 
                    else if ($ot > 0 && $ot < 1) {
                        $ot1 = $ot;
                    }
                    else {
                        $ot1 = 0;
                        $ot2 = 0;
                    }
                }
                // echo $ot1;
                if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }
                if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }


                if ($code == 'OF') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;  
                    }
                }

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {  
                 $nilai++;
                }
                if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                    $a++;
                } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                    $b++;
                }
                $allowanceAfternoon = $a;     
                $allowanceNight = $b;

                if ($ot1 <= 0) {
                    $ot1 = 0 ;
                } 
                if ($ot2 <= 0) {
                    $ot2 = 0 ;
                }
                if ($ot3 <= 0) {
                    $ot3 = 0 ;
                }
                if ($ot4 <= 0) {
                    $ot4 = 0 ;
                }
               // echo $hours.'-'.$ot1.'</br>';
                
                if ($dayIndex < 10) {
                    $ot01Column = 'setOt1D0'.$dayIndex;    
                    $ot02Column = 'setOt2D0'.$dayIndex;    
                    $ot03Column = 'setOt3D0'.$dayIndex;    
                    $ot04Column = 'setOt4D0'.$dayIndex;
                } else {
                    $ot01Column = 'setOt1D'.$dayIndex;    
                    $ot02Column = 'setOt2D'.$dayIndex;    
                    $ot03Column = 'setOt3D'.$dayIndex;    
                    $ot04Column = 'setOt4D'.$dayIndex; 
                }   
        
                    $userId = $_SESSION['uId'];
                    $currDateTm = date("Y-m-d H:i:s");
                 
                    $trOvertime->$ot01Column($ot1);
                    $trOvertime->$ot02Column($ot2);
                    $trOvertime->$ot03Column($ot3);
                    $trOvertime->$ot04Column($ot4);

                if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                    $absen = 1;
                } else {
                    $absen = 0;
                }
                    $ot1b = $ot1 + $ot1b;
                    $ot2b = $ot2 + $ot2b;
                    $ot3b = $ot3 + $ot3b;
                    $ot4b = $ot4 + $ot4b;   

                    
                    // echo $totall."<br>";
                    $wd = $absen + $wd;

                    
                              
             

            // echo $ot2.'</br>';
            }   

            // echo $bioRec.'<br/>'.$end.'<br/><br/><br/>';

            if($wd>=20){
                $wd=20;
            }

            // exit();
            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot+$totall;


                
            $gaji = $bsm * $wd;
            // echo $bsm.' '.$wd.' '.$gaji.'1 <br/>';
            $bsProrate = $gaji;
            
            // echo $statusSalary.'<br/>';
            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($standByCount != 0) {
                    $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    $bsProrate = ($monthly / 20) * ($wd); 
                } else {
                    $bsProrate = $monthly;
                }
                // $gaji = $bsProrate;
            }
            // echo $bsProrate.' bs_prorate <br/>';
            // echo $gaji.' 2 final <br/>';
            // echo $monthly.' 3 <br/>';
            // exit();

            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;
        

        
           
            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;
        

        
            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;
        

        
            $empjp = $monthly * 0.01;
            
            
            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            $tunjabatan = $totalgaji * 0.05;           
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;
            
            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            }else if ($status == "K0") {
                $ptkpTotal = 58500000;
            }else if ($status == "K1") {
                $ptkpTotal = 63000000;
            }else if ($status == "K2") {
                $ptkpTotal = 67500000;
            }else if ($status == "K3") {
                $ptkpTotal = 72000000;
            }else{
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";
            /*echo $ptkpTotal;
            exit();*/
            $penghasilanPajak = 0 ;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0;
                $taxVal5 = 0;
            }
            
            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15 ;
            }
            if ($penghasilanPajak >= 60000000 ) {
                $taxVal1 = 3000000;     
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }       
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000 ) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 + $taxVal5;
            $pajakPlusSebulan = $pajakGajiSthn / 12;

            
               
               
            
            $ter = round($totalkotor);
            $strTerima = substr($ter,-3);
            $thp = 0;
            if ($strTerima < 500) {
                $thp = $ter - $strTerima;
            } 
            if ($strTerima > 500){
                $thp = $ter - $strTerima + 1000;
            }
            $round = $thp - $totalkotor;

            // echo "biorec = ".$bioRec.' rosterid = '.$tsId.'<br/>';
            // echo 'totalkotor = '.$totalkotor.' <br/>strTerima = '.$strTerima.' <br/>thp = '.$thp.' <br/>round = '.$round.'<br/><br/><br/><br/>';

            // $checkData = $data_proses->cekIdTimesheet($ts_id);
           
            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setslipPeriod($SDate);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();
            

            // dd($monthly.' '.$gaji);
            // exit();
            
            
            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioId);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setstand_by_count($standByCount);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($monthly);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($SM);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->setcheckFinal($end);
            $trSlip->ins();
        }
        

          
                // echo "Process Succeed...";
        echo $this->getPayrollList($tahun,$bulan,$startDate,$sm);
           

    }

    public function processDB($tahun,$bulan,$startDate,$sm)
    {
        ini_set('max_execution_time', 1200); //300 seconds = 5 minutes
        $model = new M_tr_timesheet();
        $data  = $model->getTsIdByProces($tahun,$bulan,$startDate,$sm);
        $rpDb = new M_rp_db();
        $dataRpDb = array();
        foreach ($data as $tsId) {
            $this->insertDataDb($tsId['ts_id'], $model, $rpDb);
        }
    }

    public function insertDataDb($tsId, $trTimesheet, $rpDb)
    {
        $row = $trTimesheet->dbInser($tsId);
        // echo $row['ts_id'];
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $biodata_id = $row['biodata_id'];
        $ts_id = $row['ts_id'];
        $bsm = $row['daily'];
        $slip_id = $row['slip_id'];
        $monthly = $row['monthly'];
        $tanggal = $tDate3.'-'.$tDate1.'-'.$startDate;
        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);
        $tanggal1 = $tanggal;


        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $normalTime = 0;
        $ot01Val = 0;
        $ot02Val = 0;
        $ot03Val = 0;
        $ot04Val = 0;
        $tunjanganSiang = 0;
        $tunjanganMalam = 0;
        // $dataRpDb = array();
        for ($i=1; $i <= $dayCountInMonth; $i++) {

            $in  = '';
            $out = '';
            
            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if($i < 10){
                $ot01Column = 'ot1_d0'.$i;
                $ot02Column = 'ot2_d0'.$i;
                $ot03Column = 'ot3_d0'.$i;
                $ot04Column = 'ot4_d0'.$i;
                $timePerday = 'd0'.$i;
                $in = 'in0'.$i;
                $out = 'out0'.$i;
            }else{
                $ot01Column = 'ot1_d'.$i;
                $ot02Column = 'ot2_d'.$i;
                $ot03Column = 'ot3_d'.$i;
                $ot04Column = 'ot4_d'.$i;
                $timePerday = 'd'.$i;
                $in = 'in'.$i;
                $out = 'out'.$i;
        // exit();
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];
            $outVal  = $row[$out];

            $strTimePerday = $row[$timePerday] ;


            $phCodeTmp = substr($strTimePerday,0,2);
            
            $phHoursTmp = substr($strTimePerday,2,5);

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS")
            {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }

            $dateProcessing = str_replace("-","",$tanggal);
            
            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $totalHour = $phHoursTmp;
            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            // echo $totalHour .'-'. $ot01Val .'-'. $ot02Val .'-'. $ot03Val .'- '.$ot04Val.'</br>';
            // $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;

            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0 ;
            }
           
            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            } 
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }

            $malam = ($bsm * $tunjanganMalam) * 0.15;
            $siang = $bsm * 0.10 * $tunjanganSiang;

            $allTunjangan = $malam + $siang;

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;

            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4; 

            $dataRpDb = [
                'in_db' => $inVal,
                'out_db' => $outVal,
                'shift_day' => $shift_Day,
                'po_ph' => $roPh,
                'work_day' => $wDay,
                'date_process' => $dateProcessing,
                'biodata_id' => $biodata_id,
                'ts_id' => $ts_id,
                'slip_id' => $slip_id,
                'total_ot' => $totalOt,
                'ot_1' => $ot01Val,
                'ot_2' => $ot02Val,
                'ot_3' => $ot03Val,
                'ot_4' => $ot04Val,
                'normal_time' => $normalTime,
                'dept' => $row['dept'],
                'tunjangan' => $allTunjangan,
                'total_ot_value' => $totalOtValue,
                'tunjangan_malam' => $tunjanganMalam,
                'tunjangan_siang' => $tunjanganSiang,
            ];
        $rpDb->insertData($dataRpDb);
        }
    }

    public function ProsesSolo($id)
    {
      $data_proses = new M_tr_timesheet();
      $row = $data_proses->prosesSolo($id);
      // dd($row);
      $trSlip = new M_tr_slip();
      $trSlip->resetValues();
      
      // dd($data);
      // echo $checkBpjs;
      // exit();
        

        // foreach ($data as $row) {
            $bioRec = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0; 
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall=0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;



            $trOvertime = new M_tr_overtime();
            for ($i=1; $i <= 31 ; $i++){
                $dayIndex++;
                // echo $i;
                if ($i < 10){
                    $cek = 'd0'.$i;
                }else{
                    $cek = 'd'.$i;
                }     
                $data = trim($row[$cek]);
                $sm = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];
                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm/20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];
                    

                $code = substr($data,0,2);
                $hours = substr($data,2,5);

                if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                    if ($data == 'STR' || $data == 'END') {
                        $standByCount++;
                        $hours = 0;

                        $end    = "END";
                    }
                }


                if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                    $hours = 0;
                }
                if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                    $hours = 0;
                }
                if ($code == 'DS') {
                  $daily++;
                }

                if ($code == 'AI') {
                  $ppt++;
                }

                if ($code == 'SL') {
                  $sick++;
                }

                if ($code == 'AB') {
                  $alpa++;             
                }

                if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                  $attend++;
                }

                if ($code == 'HA' || $code == 'HN') {
                 $ph++;
                }

                $ot1 = 0;
                $ot2 = 0;
                $ot3 = 0;
                $ot4 = 0;
                $ot5 = 0;
                $ot = $hours - 8;
                $otoff = $hours - 7;

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    if ($ot > 0) {
                        if ($ot < 1) {
                            $ot1 = $hours - 8;
                        } else {
                            $ot1 = 1;
                        }
                        $ot2 = $hours - 9;
                    } 
                    else if ($ot > 0 && $ot < 1) {
                        $ot1 = $ot;
                    }
                    else {
                        $ot1 = 0;
                        $ot2 = 0;
                    }
                }

                // echo $ot1;
                if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }
                if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }


                if ($code == 'OF') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;  
                    }
                }

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {  
                 $nilai++;
                }
                if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                    $a++;
                } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                    $b++;
                }
                $allowanceAfternoon = $a;     
                $allowanceNight = $b;

                if ($ot1 <= 0) {
                    $ot1 = 0 ;
                } 
                if ($ot2 <= 0) {
                    $ot2 = 0 ;
                }
                if ($ot3 <= 0) {
                    $ot3 = 0 ;
                }
                if ($ot4 <= 0) {
                    $ot4 = 0 ;
                }
               // echo $hours.'-'.$ot2.'</br>';
                
                if ($dayIndex < 10) {
                    $ot01Column = 'setOt1D0'.$dayIndex;    
                    $ot02Column = 'setOt2D0'.$dayIndex;    
                    $ot03Column = 'setOt3D0'.$dayIndex;    
                    $ot04Column = 'setOt4D0'.$dayIndex;
                } else {
                    $ot01Column = 'setOt1D'.$dayIndex;    
                    $ot02Column = 'setOt2D'.$dayIndex;    
                    $ot03Column = 'setOt3D'.$dayIndex;    
                    $ot04Column = 'setOt4D'.$dayIndex; 
                }   
        
                $userId = $_SESSION['uId'];
                $currDateTm = date("Y-m-d H:i:s");
             
                $trOvertime->$ot01Column($ot1);
                $trOvertime->$ot02Column($ot2);
                $trOvertime->$ot03Column($ot3);
                $trOvertime->$ot04Column($ot4);

                if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                    $absen = 1;
                } else {
                    $absen = 0;
                }
                    $ot1b = $ot1 + $ot1b;
                    $ot2b = $ot2 + $ot2b;
                    $ot3b = $ot3 + $ot3b;
                    $ot4b = $ot4 + $ot4b;   

                    
                    // echo $totall."<br>";
                    $wd = $absen + $wd;

                    
                              
             

            }   
            // exit();

            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot+$totall;


                
            $gaji = $bsm * $wd;
            $bsProrate = $gaji;
            
            // echo $standByCount;
            // exit();
            if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                if ($standByCount != 0) {
                    $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    $bsProrate = ($monthly / 20) * ($wd);
                } else {
                    $bsProrate = $monthly;
                }
                $gaji = $bsProrate;
            }
            
            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;
        

        
            
            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;
        

        
            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;
        

        
            $empjp = $monthly * 0.01;
            
            
            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            $tunjabatan = $totalgaji * 0.05;           
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;
            
            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            }else if ($status == "K0") {
                $ptkpTotal = 58500000;
            }else if ($status == "K1") {
                $ptkpTotal = 63000000;
            }else if ($status == "K2") {
                $ptkpTotal = 67500000;
            }else if ($status == "K3") {
                $ptkpTotal = 72000000;
            }else{
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";

            $penghasilanPajak = 0 ;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0; 
                $taxVal5 = 0;
            }
            
            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15 ;
            }
            if ($penghasilanPajak >= 60000000 ) {
                $taxVal1 = 3000000;     
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }       
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000 ) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 ;
            $pajakPlusSebulan = $pajakGajiSthn / 12;

            
               // exit();
               
            
            $ter = round($totalkotor);
            $strTerima = substr($ter,-3);
            $thp = 0;
            if ($strTerima < 500) {
                $thp = $ter - $strTerima;
            } 
            if ($strTerima > 500){
                $thp = $ter - $strTerima + 1000;
            }
            $round = $thp - $totalkotor;
           
            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();

                
            
            
            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioRec);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($gaji);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($sm);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->ins();
            

        // }
           

    }

    public function ProsesSolo_split($id)
    {
        $this->db = \Config\Database::connect('', false);

        $data_proses = new M_tr_timesheet();
        $row = $data_proses->prosesSolo($id);
        // dd($row);
        $trSlip = new M_tr_slip();
        $trSlip->resetValues();

        // dd($data);
        // echo $checkBpjs;
        // exit();
        

        // foreach ($data as $row) {
            $bioRec = $row['biodata_id'];
            /*echo $bioId;*/
            $nilai = 0;
            $a = 0;
            $b = 0;
            $daily = 0;
            $off = 0; 
            $ppt = 0;
            $sick = 0;
            $alpa = 0;
            $attend = 0;
            $ph = 0;
            $dayIndex = 0;
            $ot1s = 1.5;
            $ot2s = 2.0;
            $ot3s = 3.0;
            $ot4s = 4.0;
            $totall=0;
            $salary = 0;
            $absen = 0;
            $wd = 0;
            $ot1b = 0;
            $ot2b = 0;
            $ot3b = 0;
            $jkkjkm = 0;
            $ot4b = 0;
            $jp = 0;
            $jht = 0;
            $bpjs = 0;
            $iujht = 0;
            $iujht2 = 0;
            $jkm = 0;
            $jkk = 0;
            $empbpjs = 0;
            $bpjs = 0;
            $empjp = 0;
            $empjht = 0;
            $standByCount = 0;


            $start_count_date       = $row['year_process']."-".$row['month_process']."-".$row['start_date'];
            $end_month_process      = date('Y-m-t', strtotime($start_count_date));

            // echo $start_count_date.' '.$end_month_process;
            $count_sebelum = 0;
            $count_sesudah = 0;

            $trOvertime = new M_tr_overtime();

            for ($i=1; $i <= 31 ; $i++){

                // echo $start_count_date."<br/>";

                $dayIndex++;
                // echo $i;
                if ($i < 10){
                    $cek = 'd0'.$i;
                }else{
                    $cek = 'd'.$i;
                }     
                $data = trim($row[$cek]);
                $sm = $row['payroll_group'];
                $bioRec = $row['biodata_id'];
                $roster = $row['ts_id'];
                $client = $row['client_name'];
                $year = $row['year_process'];
                $month = $row['month_process'];
                $tsId = $row['ts_id'];
                $SDate = $row['start_date'];

                $dept = $row['dept'];
                $fName = $row['full_name'];
                $monthly = $row['monthly'];
                $bsm = $row['daily'];
                $bs = $bsm/20;
                $marital = $row['marital_status'];
                $position = $row['emp_position'];
                $salaryHourly = $monthly / 173;
                $status = $row['marital_status'];
                $statusSalary = $row['status'];
                    

                $code = substr($data,0,2);
                $hours = substr($data,2,5);

                if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
                    if ($data == 'STR' || $data == 'END') {
                        $standByCount++;
                        $hours = 0;

                        $end    = "END";
                    }
                }


                if (($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'PH' || $code == 'RO') && ($hours == 0 || empty($hours))) {
                    $hours = 0;
                }
                if ($data == "SL" || $data == "AI" || $data == "AB" || $data == "MD" || $data == "AL") {
                    $hours = 0;
                }
                if ($code == 'DS') {
                  $daily++;
                }

                if ($code == 'AI') {
                  $ppt++;
                }

                if ($code == 'SL') {
                  $sick++;
                }

                if ($code == 'AB') {
                  $alpa++;             
                }

                if ($code == 'OA' || $code == 'HA' || $code == 'ON' || $code == 'HN' || $code == 'AS' || $code == 'NS' || $code == 'DS') {
                    $attend++;

                    if($start_count_date<=$end_month_process){
                        $count_sebelum++;
                    }else{
                        $count_sesudah++;
                    }
                }

                if ($code == 'HA' || $code == 'HN') {
                    $ph++;
                }

                $ot1 = 0;
                $ot2 = 0;
                $ot3 = 0;
                $ot4 = 0;
                $ot5 = 0;
                $ot = $hours - 8;
                $otoff = $hours - 7;

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {
                    if ($ot > 0) {
                        if ($ot < 1) {
                            $ot1 = $hours - 8;
                        } else {
                            $ot1 = 1;
                        }
                        $ot2 = $hours - 9;
                    } 
                    else if ($ot > 0 && $ot < 1) {
                        $ot1 = $ot;
                    }
                    else {
                        $ot1 = 0;
                        $ot2 = 0;
                    }
                }

                // echo $ot1;
                if ($code == 'OA' || $code == 'ON' || $code == 'RO') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }
                if ($code == 'HA' || $code == 'HN' || $code == 'PH') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;
                    }   
                }


                if ($code == 'OF') {
                    if ($otoff > 0) {
                        $ot2 = 7;
                        if ($otoff < 1) {
                            $ot3 = $hours - 7;
                        } else {
                            $ot3 = 1;
                        }
                        $ot4 = $hours - 8;
                    } else {
                        $ot2 = $hours;  
                    }
                }

                if ($code == 'AS' || $code == 'NS' || $code == 'DS') {  
                 $nilai++;
                }
                if ($code == 'AS' || $code == 'OA' || $code == 'HA') {
                    $a++;
                } else if ($code == 'NS' || $code == 'ON' || $code == 'HN') {
                    $b++;
                }
                $allowanceAfternoon = $a;     
                $allowanceNight = $b;

                if ($ot1 <= 0) {
                    $ot1 = 0 ;
                } 
                if ($ot2 <= 0) {
                    $ot2 = 0 ;
                }
                if ($ot3 <= 0) {
                    $ot3 = 0 ;
                }
                if ($ot4 <= 0) {
                    $ot4 = 0 ;
                }
               // echo $hours.'-'.$ot2.'</br>';
                
                if ($dayIndex < 10) {
                    $ot01Column = 'setOt1D0'.$dayIndex;    
                    $ot02Column = 'setOt2D0'.$dayIndex;    
                    $ot03Column = 'setOt3D0'.$dayIndex;    
                    $ot04Column = 'setOt4D0'.$dayIndex;
                } else {
                    $ot01Column = 'setOt1D'.$dayIndex;    
                    $ot02Column = 'setOt2D'.$dayIndex;    
                    $ot03Column = 'setOt3D'.$dayIndex;    
                    $ot04Column = 'setOt4D'.$dayIndex; 
                }   
        
                $userId = $_SESSION['uId'];
                $currDateTm = date("Y-m-d H:i:s");
             
                $trOvertime->$ot01Column($ot1);
                $trOvertime->$ot02Column($ot2);
                $trOvertime->$ot03Column($ot3);
                $trOvertime->$ot04Column($ot4);

                if ($code == "DS" || $code == "NS" || $code == "AS" || $code == "SL" || $code == "MD" || $code == "AL") {
                    $absen = 1;
                } else {
                    $absen = 0;
                }
                    $ot1b = $ot1 + $ot1b;
                    $ot2b = $ot2 + $ot2b;
                    $ot3b = $ot3 + $ot3b;
                    $ot4b = $ot4 + $ot4b;   

                    
                    // echo $totall."<br>";
                    $wd = $absen + $wd;

                    
                $start_count_date      = date('Y-m-d', strtotime('+1 days', strtotime($start_count_date)));             
             

            }   

            // dd($count_sebelum.' - '.$count_sesudah);
            // exit();

            $hasilOt1 = $ot1b * $ot1s * $salaryHourly;
            $hasilOt2 = $ot2b * $ot2s * $salaryHourly;
            $hasilOt3 = $ot3b * $ot3s * $salaryHourly;
            $hasilOt4 = $ot4b * $ot4s * $salaryHourly;
            $totalot = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
            $totall = $totalot+$totall;


                
            $gaji = $bsm * $wd;

            // dd($gaji.' '.$bsm.' '.$wd);

            $month_process      = $row['month_process'];
            $year_process       = $row['year_process'];
            $biodata_id         = $row['biodata_id'];

            $month_sebelum      = date('m', strtotime('-1 month', strtotime($year_process.'-'.$month_process.'-10')));
            $year_sebelum       = date('Y', strtotime('-1 month', strtotime($year_process.'-'.$month_process.'-10')));

            $stQuerySekarang    = "SELECT b.biodata_id,b.monthly,b.daily FROM mt_salary b WHERE b.biodata_id='".$biodata_id."' ";
            $data_sekarang      = $this->db->query($stQuerySekarang)->getRowArray(); 
            // dd($data_sekarang);

            $stQuerySebelum     = "SELECT a.work_total, a.gajipokok, (a.gajipokok/a.work_total) as daily
                                    FROM tr_slip a 
                                    WHERE a.biodata_id='".$biodata_id."' AND a.year_period='".$year_sebelum."' AND a.month_period='".$month_sebelum."'";
            $data_sebelum       = $this->db->query($stQuerySebelum)->getRowArray(); 
            // dd($data_sebelum);
            // dd(number_format($data_sebelum['daily'], 0, ".", "").' '.number_format($data_sekarang['daily'], 0, ".", ""));
            if($data_sebelum){
                if(number_format($data_sebelum['daily'], 0, ".", "") !== number_format($data_sekarang['daily'], 0, ".", "")){
                    $gaji_sebelum       = $count_sebelum * number_format($data_sebelum['daily'], 0, ".", "");
                    $gaji_sesudah       = $count_sesudah * number_format($data_sekarang['daily'], 0, ".", "");

                    $gaji               = $gaji_sebelum + $gaji_sesudah;
                    // echo $gaji_sebelum.' '.$gaji_sesudah.' = '.$gaji; 
                }
            }else{
                $gaji_sesudah   = $gaji;
                $gaji_sebelum   = 0;
            }
            
            // dd($gaji_sebelum.' '.$gaji_sesudah.' '.$gaji);
            $bsProrate = $gaji;

            
            // echo $standByCount;
            // exit();
            // if ($statusSalary == 'Monthly' || $statusSalary == 'month') {
            //     if ($standByCount != 0) {
            //         $jmlHari = cal_days_in_month(CAL_GREGORIAN, $month, $year);
            //         $bsProrate = ($monthly / 20) * ($wd);
            //     } else {
            //         $bsProrate = $monthly;
            //     }
            //     $gaji = $bsProrate;
            // }
            
            $bpjs = $monthly * 0.04;
            $empbpjs = $monthly * 0.05;
        

        
            
            $jkk = $monthly * 0.0174;
            $jkm = $monthly * 0.003;
            $jkkjkm = $jkk + $jkm;
        

        
            // $iujht = $monthly * 0.03;
            $iujht2 = $monthly * 0.037;
            $empjht = $monthly * 0.02;
        

        
            $empjp = $monthly * 0.01;
            
            
            $jhtjp = $empjht + $empjp;
            $allow2 = ($bsm * $allowanceNight) * 0.15;
            $allow1 = $bsm * 0.10 * $allowanceAfternoon;
            $totalgaji = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs;
            $tunjabatan = $totalgaji * 0.05;           
            $totalkotor = $gaji + $totall + $allow2 + $jkkjkm + $allow1 + $bpjs - $iujht - $iujht2 - $tunjabatan;
            
            $nettoSetahun = 0;
            $nettoSetahun = $totalkotor * 12;
            $ptkpTotal = 0;
            if ($status == "TK0") {
                $ptkpTotal = 54000000;
            }else if ($status == "K0") {
                $ptkpTotal = 58500000;
            }else if ($status == "K1") {
                $ptkpTotal = 63000000;
            }else if ($status == "K2") {
                $ptkpTotal = 67500000;
            }else if ($status == "K3") {
                $ptkpTotal = 72000000;
            }else{
                $ptkpTotal = 0;
            }
            $taxPercent1 = "5%";
            $taxPercent2 = "15%";
            $taxPercent3 = "25%";
            $taxPercent4 = "30%";
            $taxPercent5 = "35%";

            $penghasilanPajak = 0 ;
            $taxVal1 = 0;
            $taxVal2 = 0;
            $taxVal3 = 0;
            $taxVal4 = 0;
            $taxVal5 = 0;
            if ($nettoSetahun >= $ptkpTotal) {
                $penghasilanPajak = $nettoSetahun - $ptkpTotal;
                $pajakNonReg = 0;
                $pajakPlusSebulan = 0;
                $taxVal1 = $penghasilanPajak * 0.05;
                $taxVal2 = 0;
                $taxVal3 = 0;
                $taxVal4 = 0; 
                $taxVal5 = 0;
            }
            
            $maxPajak1 = $penghasilanPajak - 60000000;
            if ($penghasilanPajak > 60000000) {
                $taxVal2 = $maxPajak1 * 0.15 ;
            }
            if ($penghasilanPajak >= 60000000 ) {
                $taxVal1 = 3000000;     
            }

            $maxPajak2 = $maxPajak1 - 190000000;
            if ($maxPajak1 >= 190000000) {
                $taxVal2 = 28500000;
            }

            if ($maxPajak1 > 190000000) {
                $taxVal3 = ($maxPajak1 - 190000000) * 0.25;
            }

            $maxPajak3 = $maxPajak2 - 250000000;
            if ($maxPajak2 >= 250000000) {
                $taxVal3 = 62500000;
            }       
            if ($maxPajak2 > 250000000) {
                $taxVal4 = ($maxPajak2 - 250000000) * 0.30;
            }
            $maxPajak4 = $maxPajak3 - 4500000000;
            if ($maxPajak3 > 4500000000 ) {
                $taxVal4 = 1350000000;
            }
            if ($maxPajak4 > 4500000000) {
                $taxVal5 = ($maxPajak3 - 4500000000) * 0.35;
            }
            $pajakGajiSthn = $taxVal1 + $taxVal2 + $taxVal3 + $taxVal4 ;
            $pajakPlusSebulan = $pajakGajiSthn / 12;

            
               // exit();
               
            
            $ter = round($totalkotor);
            $strTerima = substr($ter,-3);
            $thp = 0;
            if ($strTerima < 500) {
                $thp = $ter - $strTerima;
            } 
            if ($strTerima > 500){
                $thp = $ter - $strTerima + 1000;
            }
            $round = $thp - $totalkotor;
           
            $headerId = $trOvertime->generateId('overtime_id')['doc_id'];
            // $trOvertime->resetValues();
            $trOvertime->setOvertimeId($headerId);
            $trOvertime->setBioRecId($bioRec);
            $trOvertime->setRosterId($tsId);
            $trOvertime->setClientName($client);
            $trOvertime->setYearPeriod($year);
            $trOvertime->setMonthPeriod($month);
            $trOvertime->setNightShiftCount($allowanceNight);
            $trOvertime->setDayShiftCount($daily);
            $trOvertime->setOffTotal($off);
            $trOvertime->setPermitTotal($ppt);
            $trOvertime->setSickTotal($sick);
            $trOvertime->setAlpaTotal($alpa);
            $trOvertime->setAttendTotal($attend);
            $trOvertime->setPhTotal($ph);
            $trOvertime->setPicProcess($userId);
            $trOvertime->setProcessTime($currDateTm);
            $trOvertime->ins();

                
            
            
            $headerId = $trSlip->generateId('slip_id')['doc_id'];
            $trSlip->setSlipId($headerId);
            $trSlip->setBiodataId($bioRec);
            $trSlip->setTsId($tsId);
            $trSlip->setYearPeriod($year);
            $trSlip->setMonthPeriod($month);
            $trSlip->setSlipPeriod($SDate);
            $trSlip->setdateProcess("$year-$month-$SDate");
            $trSlip->setFullName($fName);
            $trSlip->setPosition($position);
            $trSlip->setMaritalStatus($marital);
            $trSlip->setbs_prorate($bsProrate);
            $trSlip->setDept($dept);
            $trSlip->setWorkTotal($attend);
            $trSlip->setAllowance01($allow1);
            $trSlip->setAllowance02($allow2);
            $trSlip->setBpjs($bpjs);
            $trSlip->setJkk($jkk);
            $trSlip->setJkm($jkm);
            $trSlip->setJht($iujht2);
            $trSlip->setEmpBpjs($empbpjs);
            $trSlip->setEmpJp($empjp);
            $trSlip->setEmpJht($empjht);
            $trSlip->setPicInput($userId);
            $trSlip->setInputTime($currDateTm);
            $trSlip->setJkkjkm($jkkjkm);
            $trSlip->setJhtjp($jhtjp);
            $trSlip->settotalot($totall);

            $trSlip->setGajiSebelum($gaji_sebelum);
            $trSlip->setGajiSekarang($gaji_sesudah);
            
            $trSlip->setgaji($gaji);
            $trSlip->setgajipokok($gaji);
            $trSlip->setpph21($pajakPlusSebulan);
            $trSlip->settotalgaji($totalgaji);
            $trSlip->setround($round);
            $trSlip->setpayrollGroup($sm);
            $trSlip->setbankId($row['bank_id']);
            $trSlip->ins();
            

        // }
           

    }
     
     /* END GET ALL */
     public function getPayrollList($tahun,$bulan,$startDate,$sm)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $data_sm = $data_proses->baca($sm);
        // echo $this->db->last_query(); exit(0);
        // echo $this->db->last_query(); exit(0);
        /*return json_encode($query);*/
        $data   = array();
        $myData = array();
        foreach ($data_sm as $key => $row) 
        {
               $myData[] = array(
                $row['slip_id'],
                $row['biodata_id'],
                $row['full_name'], 
                $row['dept'],        
                $row['ts_id'],        
                // $row['production_bonus'],         
                // $row['workday_adj'],         
                // $row['adjust_in'],         
                // $row['adjust_out'],  
                // $row['full_name'],  
                $row['thr'],
                $row['allowance_03'],
                $row['adjustment']     
                        
                // $row['attendance_bonus'],         
                // $row['other_allowance1'],         
                // $row['other_allowance2'],         
                // $row['cc_payment'],         
                // $row['thr'],         
                // $row['debt_burden'],
                // $row['debt_explanation']
            );            
        }
        $data['due_date']   = count($data_proses->cek_duedate($sm));
        $data['myData']     = $myData;
          

        echo json_encode($data);  
        // echo $this->db->last_query(); 
    } 

    public function Excel($ts_id,$checkBpjs,$checkJHT,$checkJP,$checkJKKJKM,$spreadsheet, $noNewSheet)
    {
        $trSlip = new M_tr_slip();
        $rpDb = new M_rp_db();
        $writer = new Xls($spreadsheet);


        $spreadsheet->getProperties()->setCreator('Maurice - Web - Android')
            ->setLastModifiedBy('Maurice - Web - Android')
            ->setTitle('Office 2007 XLSX Test Document')
            ->setSubject('Office 2007 XLSX Test Document')
            ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
            ->setKeywords('office 2007 openxml php')
            ->setCategory('Test result file');
        $boldFont = [
            'font' => [
                'bold' => true
                // 'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyle = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyles = [
            'font' => [
                'bold' => true ,
                'color' => ['argb' => 'FFFF0000'],
            ],
        ];

        $allBorderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $outlineBorderStyle = [
            'borders' => [
                'outline' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $topBorderStyle = [
            'borders' => [
                'top' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $bottomBorderStyle = [
            'borders' => [
                'bottom' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];
        $center = array();
        $center['alignment'] = array();
        $center['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER; 
        $center['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER; 

        $right = array();
        $right['alignment'] = array();
        $right['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_RIGHT; 
        $right['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $left = array();
        $left['alignment'] = array();
        $left['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_LEFT; 
        $left['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;
        $rowIdx = 0;
        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $allTimeTotal = 0;
        $normalTotal = 0;
        $wDayTotal = 0;
        $rowIdx = 8;
        $rowIdx_new = 8;
        $totalTitle_sum = 0;
        $attendStatus = 0;
        $bonusTotal = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        $penghasilanPajak = 0;
        $pajakNonReg = 0;
        $pajakPlusSebulan = 0;
        $pajakGajiSthn = 0;
        $pajakSebulan = 0;
        $tTimePerday = 0;
        $wdAttendCount = 0;
        $alpa = 0;
        $bsProrate = 0;
        $end = 0;
        
        



        $trTimesheet = new M_tr_timesheet();
        $row = $trTimesheet->Print($ts_id);
        // dd($row);
        $biodataId =  $row['biodata_id'];
        $row['bank_id'];
        $nama = $row['full_name'];
        $jabatan = $row['position'];
        $status = $row['marital_status'];
        $id = $row['biodata_id'];
        $dept = $row['dept'];
        $bpjs = $row['bpjs'];
        $monthly = $row['real_gajipokok'];
        // $monthly = $row['monthly']; //Perubahan 12-03-2025
        $siang = $row['allowance_01'];
        $malam = $row['allowance_02'];
        $jk = $row['jk'];
        $jkk = $row['jkk'];
        $jkm = $row['jkm'];
        $bpjstk = $row['emp_bpjs'];
        $empjht = $row['emp_jht'];
        $jkkjkm = $row['jkkjkm'];
        $jptk = $row['emp_jp'];
        $adjustment = $row['adjustment'];
        $keterangan = $row['status_remarks'];
        $client_display = 'PT. Agincourt Resources Martabe Gold Mine';
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $npwp = $row['tax_no'];
        $sPayroll = $row['status_payroll'];
        $alpa = $row['alpa_total'];
        $izin = $row['permit_total'];
        $bsProrate = $row['bs_prorate'];
        $statusBPJS = $row['bpjs_status'];
        $tanggal = $tDate3.'-'.$tDate1.'-'.$startDate;
        // echo $nama;
        // exit();
        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);

        $tanggal1 = $tanggal;
        for ($i=1; $i <= $dayCountInMonth; $i++) { 
            // echo $i.'<br/>';
            $tunjanganMalam = 0;
            $tunjanganSiang = 0;
            /* START NUMBER TITLE */
            $rowIdx++;
            $rowIdx_new++;
            $in = '';
            
            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if($i < 10){
                $ot01Column = 'ot1_d0'.$i;
                $ot02Column = 'ot2_d0'.$i;
                $ot03Column = 'ot3_d0'.$i;
                $ot04Column = 'ot4_d0'.$i;
                $timePerday = 'd0'.$i;
                $in = 'in0'.$i;
            }else{
                $ot01Column = 'ot1_d'.$i;
                $ot02Column = 'ot2_d'.$i;
                $ot03Column = 'ot3_d'.$i;
                $ot04Column = 'ot4_d'.$i;
                $timePerday = 'd'.$i;
                $in = 'in'.$i;
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];

            $strTimePerday = $row[$timePerday] ;


            $phCodeTmp = substr($strTimePerday,0,2);
            
            $phHoursTmp = substr($strTimePerday,2,5);

            

            if (($phCodeTmp == 'OA' || $phCodeTmp == 'HA' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN' || $phCodeTmp == 'PH' || $phCodeTmp == 'RO') && ($phHoursTmp == 0 || empty($phHoursTmp))) {
                $phHoursTmp = 0;
            } 
            $outVal = (double)$inVal + (double)$phHoursTmp +1;
            // echo $outVal.'</br>';
            // if ($outVal > 24) {
            //     $outVal = $outVal - 24;
            // } 
            // if ((double)$inVal == 0) {
            //     $outVal = 0;
            // }
            if ($strTimePerday == "STR" || $strTimePerday == "END") {
                $phHoursTmp = 0;
                $phCodeTmp = $strTimePerday;
            }

            if ($phHoursTmp == null || $phHoursTmp == '') {
                $phHoursTmp = 0;
            }


            
            if ($phCodeTmp == "SL" || $phCodeTmp == "AI" || $phCodeTmp == "AB" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $phHoursTmp = 0;
            }
            $totalHour = $phHoursTmp;
            if ($phCodeTmp == "AS" || $phCodeTmp == "OA" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "ON" || $phCodeTmp == "NS" || $phCodeTmp == 'DS' || $phCodeTmp == "PH" || $phCodeTmp == 'RO') {
                $tTimePerday = $phHoursTmp;
            }
            else
            {
                $tTimePerday = $row[$timePerday];
            }
            if(is_numeric($tTimePerday))
            {
                $timeTotal = $tTimePerday;
                if($tTimePerday > 1) {
                    $attendStatus = 1;
                }
            }
            // if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AB" || $phCodeTmp == "AI" || $phCodeTmp == "AL") {
            //     $absen = 1;
            // } else {
            //     $absen = 0;
            // }

            if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $absen = 1;
            } else if($phCodeTmp == "AB" || $phCodeTmp == "AI"){
                $absen = 0;
            } else {
                $absen = 0;
            }

            if ($phCodeTmp == "END") {
                $end = 1;
            }

            $totalTitle = $rowIdx_new+2;
            $wdAttendCount = $wdAttendCount + $absen;
            $timeTotal = $tTimePerday++;

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS")
            {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }
            
            $day = date('D', strtotime($tanggal));
            $dayList = array(
                'Sun' => 'Minggu',
                'Mon' => 'Senin',
                'Tue' => 'Selasa',
                'Wed' => 'Rabu',
                'Thu' => 'Kamis',
                'Fri' => 'Jumat',
                'Sat' => 'Sabtu'
            );
            $rdData =  $dayList[$day];


            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;

            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0 ;
            }
            $normalTotal = $normalTotal + $normalTime;
            $wDayTotal = $wDayTotal + $wDay;
           
            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            } 
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }
           


            $spreadsheet->getActiveSheet()->getStyle('A'.$rowIdx.':A'.$rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('A'.$rowIdx.':A'.$rowIdx)->applyFromArray($right);
            $spreadsheet->getActiveSheet()->setCellValue('A'.$rowIdx, $tanggal);
            
            
            $spreadsheet->getActiveSheet()
                    ->setCellValue('B'.$rowIdx, $rdData)
                    ->setCellValue('C'.$rowIdx, $phCodeTmp)
                    ->setCellValue('D'.$rowIdx, $timeTotal)
                    ->setCellValue('E'.$rowIdx, $wDay)
                    ->setCellValue('F'.$rowIdx, $normalTime)
                    ->setCellValue('G'.$rowIdx, $ot01Val)
                    ->setCellValue('H'.$rowIdx, $ot02Val)
                    ->setCellValue('I'.$rowIdx, $ot03Val)
                    ->setCellValue('J'.$rowIdx, $ot04Val);

            $spreadsheet->getActiveSheet()->getStyle("B".$rowIdx.":J".$rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle("B".$rowIdx.":J".$rowIdx)->applyFromArray($center); 

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;
            $dayss = $wdAttendCount - 1;
            $dateProcessing = str_replace("-","",$tanggal);
                
            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $allTimeTotal = $allTimeTotal + $phHoursTmp;
            $biodata_id = $row['biodata_id'];
            $ts_id = $row['ts_id'];
            $slip_id = $row['slip_id'];
            $allTunjangan = $malam + $siang;
            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4; 
        }
        
        $endDate = date('Y-m-d', strtotime('+'.$dayss.'days', strtotime($tanggal1)));
        
            
            
        $spreadsheet->getActiveSheet()->getColumnDimension('A')->setWidth(6);             
        $spreadsheet->getActiveSheet()->getColumnDimension('B')->setWidth(9);             
        $spreadsheet->getActiveSheet()->getColumnDimension('C')->setWidth(7);             
        $spreadsheet->getActiveSheet()->getColumnDimension('D')->setWidth(8);         
        $spreadsheet->getActiveSheet()->getColumnDimension('E')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('F')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('G')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('H')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('I')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('J')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('K')->setWidth(3);
        $spreadsheet->getActiveSheet()->getColumnDimension('M')->setWidth(8);

        $spreadsheet->getActiveSheet()
            ->setCellValue('A1', 'PT. SANGATI SOERYA SEJAHTERA')
            ->setCellValue('A2', 'Slip Gaji Karyawan')
            ->setCellValue('A4', 'PT : '.$client_display)
            ->setCellValue('A5', 'STARTDATE : '.$tanggal1.' to '.$endDate);

        $spreadsheet->getActiveSheet()->getStyle("A1:D1")->getFont()->setBold(true)->setSize(16);
        $spreadsheet->getActiveSheet()->getStyle("A2:D2")->getFont()->setBold(true)->setSize(14)->setUnderline(true);
        $spreadsheet->getActiveSheet()->getStyle("A4:G4")->getFont()->setBold(true)->setSize(12);

        $spreadsheet->getActiveSheet()->mergeCells("A6:A7");
        $spreadsheet->getActiveSheet()->mergeCells("B6:B7");
        $spreadsheet->getActiveSheet()->mergeCells("C6:C7");
        $spreadsheet->getActiveSheet()->mergeCells("D6:D7"); 
        $spreadsheet->getActiveSheet()->mergeCells("E6:E7");
        $spreadsheet->getActiveSheet()->mergeCells("F6:F7");
        $spreadsheet->getActiveSheet()->mergeCells("G6:J6");
        
        $spreadsheet->getActiveSheet()->getStyle("A6:F7")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("G6:J7")->applyFromArray($allBorderStyle);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($center);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()
            ->setCellValue('A6', 'DATE')
            ->setCellValue('B6', 'ROSTER DAY')
            ->setCellValue('C6', 'SHIFT DAY')
            ->setCellValue('D6', 'HOURS TOTAL')
            ->setCellValue('E6', 'WORK DAY')
            ->setCellValue('F6', 'NT')
            ->setCellValue('G6', 'OVERTIME')
            ->setCellValue('G7', '1')
            ->setCellValue('H7', '2')
            ->setCellValue('I7', '3')
            ->setCellValue('J7', '4');

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($boldFont);
          

        $totalTitle = $rowIdx+1;
        $spreadsheet->getActiveSheet()
            ->setCellValue('A'.$totalTitle, 'TOTAL')
            ->setCellValue('C'.$totalTitle, $wdAttendCount)
            ->setCellValue('D'.$totalTitle, $allTimeTotal)
            ->setCellValue('E'.$totalTitle, $wDayTotal)
            ->setCellValue('F'.$totalTitle, $normalTotal)
            ->setCellValue('G'.$totalTitle, $ot01Count)
            ->setCellValue('H'.$totalTitle, $ot02Count)
            ->setCellValue('I'.$totalTitle, $ot03Count)
            ->setCellValue('J'.$totalTitle, $ot04Count);

        $totalTitle_sum         = $totalTitle;
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle)->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle)->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle)->getFont()->setBold(true)->setSize(13);
        
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->getFont()->setBold(true)->setSize(13);

        $totalTitle = $totalTitle+1;
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->getFont()->setBold(true)->setSize(13);
        
        $spreadsheet->getActiveSheet()->setCellValue('A'.$totalTitle, 'TOTAL OT');
        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle."")->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle."")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->mergeCells("C".$totalTitle.":J".$totalTitle."");
        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle."")->getFont()->setBold(true)->setSize(13);
        $spreadsheet->getActiveSheet()->setCellValue('C'.$totalTitle, '=SUM(G'.$totalTitle_sum.':J'.$totalTitle_sum.')');
            
            
        $spreadsheet->getActiveSheet()->getStyle("A43:J59")->applyFromArray($outlineBorderStyle);
        
        $bankName = $row['bank_name'];
        $bankNo = $row['account_no'];
        $spreadsheet->getActiveSheet()
                ->setCellValue('C43', 'Dibayarkan Oleh')    
                ->setCellValue('C48', 'Payroll/ Accounting')    
                ->setCellValue('C52', 'Diterima Oleh Karyawan')    
                ->setCellValue('C57', $row['full_name'])
                ->setCellValue('C58', $bankName." : ".$bankNo);
        
        $spreadsheet->getActiveSheet()->getStyle("L4:M4")->applyFromArray($left);
        $spreadsheet->getActiveSheet()->getStyle("L4:R43")->getFont()->setSize(13);

        $basicSalary = $monthly; 
        $salaryHourly = $monthly / 173;
        $salaryDay = $basicSalary / 20;
        $upah = 0 ;
        if ($sPayroll == 'daily' || $sPayroll == 'Daily') {
            $upah = $salaryDay * $wdAttendCount;
        } 
        else if ($sPayroll == 'daily p' || $sPayroll == 'Daily p') {
            $upah = $salaryDay * $wdAttendCount;
        }
        else if ($sPayroll == 'month' || $sPayroll == 'Monthly') {
            $upah = $bsProrate;
        }
        // dd($salaryDay);
        $absensi = ($alpa + $izin) * $salaryDay;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L4', 'NAMA')
            ->setCellValue('N4', $row['full_name'])
            ->setCellValue('O4', 'Id')
            ->setCellValue('P4', $id)
            ->setCellValue('L5', 'JABATAN')
            ->setCellValue('N5', $row['position'])
            ->setCellValue('O5', 'DEPT ')
            ->setCellValue('P5', $dept)
            ->setCellValue('L6', 'STATUS')
            ->setCellValue('N6', $row['marital_status'])
            ->setCellValue('O6', 'NPWP ')
            ->setCellValue('P6', $npwp)
            ->setCellValue('L7', 'UMK')
            ->setCellValue('N7', $basicSalary)
            ->setCellValue('O7', 'RATE/DAY')
            ->setCellValue('P7', $salaryDay)
            ->setCellValue('L8', 'RATE/HOUR')
            ->setCellValue('N8', $salaryHourly)
            ->setCellValue('L10', 'UPAH')
            ->setCellValue('P10', $upah)
            ->setCellValue('L11', 'OT 1')
            ->setCellValue('L12', 'OT 2')
            ->setCellValue('L13', 'OT 3')
            ->setCellValue('L14', 'OT 4')
            ;  

        $spreadsheet->getActiveSheet()->getStyle('N7:N8')->applyFromArray($totalStyle);

        
        $ot1 = 1.5;
        $ot2 = 2.0;
        $ot3 = 3.0;
        $ot4 = 4.0;


        $hasilOt1 = $ot01Count * $ot1 * $salaryHourly;
        $hasilOt2 = $ot02Count * $ot2 * $salaryHourly;
        $hasilOt3 = $ot03Count * $ot3 * $salaryHourly;
        $hasilOt4 = $ot04Count * $ot4 * $salaryHourly;
        $allottotal = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
        


        $strOT1 = number_format($ot01Count,1)." x ".number_format($ot1,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT2 = number_format($ot02Count,1)." x ".number_format($ot2,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT3 = number_format($ot03Count,1)." x ".number_format($ot3,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT4 = number_format($ot04Count,1)." x ".number_format($ot4,1)." x ".number_format($salaryHourly,2)." = Rp.";

        $spreadsheet->getActiveSheet()
            ->setCellValue('N11', $strOT1)
            ->setCellValue('O11', $hasilOt1)
            ->setCellValue('N12', $strOT2)
            ->setCellValue('O12', $hasilOt2)
            ->setCellValue('N13', $strOT3)
            ->setCellValue('O13', $hasilOt3)
            ->setCellValue('N14', $strOT4)
            ->setCellValue('O14', $hasilOt4)
            ->setCellValue('L15', 'OT TOTAL')
            ->setCellValue('P15', $allottotal);

        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($totalStyle);

        $bonusIdx = 17;
        $Thr = $row['thr'];
        $bonusdll = $row['allowance_03'];
        $bonusTotal = $malam + $siang + $Thr + $bonusdll;
        // dd($bonusTotal);
        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$bonusIdx, 'Shift Malam')
            ->setCellValue('O'.$bonusIdx, $malam)
            ->setCellValue('L'.($bonusIdx+1), 'Shift Siang')
            ->setCellValue('O'.($bonusIdx+1), $siang)
            ->setCellValue('L'.($bonusIdx+2), 'THR')
            ->setCellValue('O'.($bonusIdx+2), $Thr)
            ->setCellValue('L'.($bonusIdx+3), 'Lain-lain')
            ->setCellValue('O'.($bonusIdx+3), $bonusdll)
            ->setCellValue('L'.($bonusIdx+4), 'BONUS TOTAL')
            ->setCellValue('P'.($bonusIdx+4), $bonusTotal);

        $spreadsheet->getActiveSheet()->getStyle('L'.($bonusIdx+4).':P'.($bonusIdx+4))->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.($bonusIdx+4).':P'.($bonusIdx+4))->applyFromArray($totalStyle);

        $govRegIdx = 23;
        $Bpjs = $basicSalary * 0.04;
        // echo $Bpjs.' '.$basicSalary;
        // exit();
        $JkkJkm = $basicSalary * 0.0204;
        $JHT2 = $basicSalary * 0.037;
        $JHT = $basicSalary * 0.02;
        $Bpjs1 = $basicSalary * 0.05;
        $JP = $basicSalary * 0.01;
        // $JkkJkm = $row['jkkjkm'];
        // $Bpjs = $row['bpjs'];
        // $JHT = $row['emp_jht'];
        // $JP = $row['emp_jp'];
        // $JHT2 = $row['jht'];
        // $Bpjs1 = $row['emp_bpjs'];
        $check = $trSlip->validasiBpjs($biodataId, $tDate1, $tDate3, $row['slip_period']);
        
        if (!isset($check['BPJS'])) {
            $checkBpjs1 = 0;
        } else {
           $checkBpjs1 = $check['BPJS']; 
        }
        if (!isset($check['JHT'])) {
            $checkJHT1 = 0;
        } else {
           $checkJHT1 = $check['JHT']; 
        }
        if (!isset($check['JP'])) {
            $checkJP1 = 0;
        } else {
           $checkJP1 = $check['JP']; 
        }
        if (!isset($check['JKKJKM'])) {
            $checkJKKJKM1 = 0;
        } else {
           $checkJKKJKM1 = $check['JKKJKM']; 
        }

        if ($checkBpjs == 0 || $checkBpjs1 > 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        if ($checkJHT == 0 || $checkJHT1 > 0) {
            $JHT = 0;
            $JHT2 = 0;
            // $JhtJp =0;
        }
        if ($checkJP == 0 || $checkJP1 > 0) {
            $JP = 0;
            // $JhtJp = 0;
        }
        if ($checkJKKJKM == 0 || $checkJKKJKM1 > 0) {
            $JkkJkm = 0;
            
        }

        if ($statusBPJS == 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        $JhtJp = $JHT + $JP;
        
        $trSlip->setBpjs($Bpjs);
        $trSlip->setJkkjkm($JkkJkm);
        $trSlip->setEmpJht($JHT);
        $trSlip->setEmpBpjs($Bpjs1);
        $trSlip->setEmpJp($JP);

        $trSlip->setJht($JHT2);
        $trSlip->setJhtjp($JhtJp);
        $trSlip->UpdTunjangan($ts_id);



      //   $checkBpjs = $_POST['cbHealthBPJS'];
      // $checkJHT = $_POST['cbJHT'];
      // $checkJP = $_POST['cbJP'];
      // $checkJKKJKM = $_POST['cbJKKM'];
        $subTotalVal = $JkkJkm + $Bpjs - $absensi;
        $brutto =$upah + $allottotal + $bonusTotal  + $subTotalVal ;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$govRegIdx, 'JKK & JKM')
            ->setCellValue('O'.$govRegIdx, $JkkJkm)
            ->setCellValue('L'.($govRegIdx+1), 'Iuran BPJS Kesehatan(4%)')
            ->setCellValue('O'.($govRegIdx+1), $Bpjs)
            ->setCellValue('L'.($govRegIdx+2), 'Potongan Absensi')
            ->setCellValue('O'.($govRegIdx+2), '-'.$absensi)
            ->setCellValue('L'.($govRegIdx+3), 'Subtotal')
            ->setCellValue('P'.($govRegIdx+3), $subTotalVal);
        $spreadsheet->getActiveSheet()->getStyle('L'.($govRegIdx+3).':P'.($govRegIdx+3))->applyFromArray($totalStyle);

        $bruttoCoordinate = $govRegIdx+4;
        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$bruttoCoordinate, 'TOTAL KOTOR')
            ->setCellValue('P'.$bruttoCoordinate, $brutto);

        $spreadsheet->getActiveSheet()->getStyle('L'.$bruttoCoordinate.':P'.$bruttoCoordinate)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$bruttoCoordinate.':P'.$bruttoCoordinate)->applyFromArray($totalStyle);

        // echo $biodataId.'-'.$brutto.'-'.$status.'-'.$end.'-'.$tDate1.'-'.$tDate3;
        // exit();

        $dataTax = $this->taxApi($biodataId, $brutto, $status, $end, $tDate1, $tDate3);
        // dd($dataTax);
        // exit();

        /* DATA PAJAK DARI API */

        // dd($dataTax);
        $taxPinalty       = $dataTax->tax_pinalty;
        $TJabatan         = $dataTax->tunjangan_jabatan;
        $taxTot           = $dataTax->tax;
        $bruttoSetahun    = $dataTax->brutto_setahun;
        $nettoSetahun     = $dataTax->netto_setahun;
        $jpSetahun        = $dataTax->jp_setahun;
        $jhtSetahun       = $dataTax->jht_setahun;
        $ptkpTotal        = $dataTax->nilai_ptkp;
        $penghasilanPajak = $dataTax->penghasilan_pajak;
        $taxPercent1      = $dataTax->tax_percent_1;
        $taxPercent2      = $dataTax->tax_percent_2;
        $taxPercent3      = $dataTax->tax_percent_3;
        $taxPercent4      = $dataTax->tax_percent_4;
        $taxPercent5      = $dataTax->tax_percent_5;
        $taxVal1          = $dataTax->tax_val_1;
        $taxVal2          = $dataTax->tax_val_2;
        $taxVal3          = $dataTax->tax_val_3;
        $taxVal4          = $dataTax->tax_val_4;
        $taxVal5          = $dataTax->tax_val_5;
        $pembulatan       = $dataTax->pembulatan;
        $golongan         = $dataTax->golongan;
        $tarif            = $dataTax->tarif;
        $netto            = 0;
        $bonusNonReg      = 0;
        // dd($tDate1);
        if ($tDate1 == 11 OR $end == 1) { // Perubahan tanggal 16/01/2025 Karena Final di martabel bulan 11
            $taxCoordinate = 39; /* TAX ROWS COORDINATE  */
            $tmpCoordinate1 = $taxCoordinate+16;
            $tmpCoordinate2 = 0;

            $spreadsheet->getActiveSheet()->getStyle("L".$taxCoordinate.":P".($tmpCoordinate1-1))->applyFromArray($outlineBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.$taxCoordinate.':P'.($taxCoordinate))->applyFromArray($totalStyle);
            // $tmpCoordinate1 = $taxCoordinate + 19;
            $spreadsheet->getActiveSheet()->getStyle("L".$taxCoordinate.":P".$tmpCoordinate1)->getFont()->setSize(13);
            // dd($bruttoSetahun);

            
        

            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.$taxCoordinate, 'PERHITUNGAN PAJAK PENGHASILAN')
                ->setCellValue('L'.($taxCoordinate+1), 'Penghasilan Kotor')
                ->setCellValue('P'.($taxCoordinate+1), $bruttoSetahun)
                ->setCellValue('L'.($taxCoordinate+2), 'Iuran JHT JP')
                ->setCellValue('P'.($taxCoordinate+2), '-'.$jpSetahun)
                ->setCellValue('L'.($taxCoordinate+3), 'Iuran JHT')
                ->setCellValue('P'.($taxCoordinate+3), '-'.$jhtSetahun)            
                ->setCellValue('L'.($taxCoordinate+4), 'Tunjangan Jabatan')
                ->setCellValue('P'.($taxCoordinate+4), '-'.$TJabatan);

            // $nettoCoordinate = 45;
            // echo $netto;
            // exit();

            // $spreadsheet->getActiveSheet()->getStyle('L'.$nettoCoordinate.':P'.($nettoCoordinate))->applyFromArray($totalStyle);
            // $spreadsheet->getActiveSheet()
            //     ->setCellValue('L'.$nettoCoordinate, 'Netto')
            //     ->setCellValue('P'.$nettoCoordinate, $netton);

            $yearNettoCoordinate = 44;
            // $ptkpTotal = 0;
            $spreadsheet->getActiveSheet()->getStyle('L'.$yearNettoCoordinate.':P'.($yearNettoCoordinate))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($yearNettoCoordinate+3).':P'.($yearNettoCoordinate+3))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.$yearNettoCoordinate, 'Netto Disetahunkan(Tetap)')
                ->setCellValue('P'.$yearNettoCoordinate, $nettoSetahun)
                ->setCellValue('L'.($yearNettoCoordinate+1), 'PTKP '.$row['marital_status'])
                ->setCellValue('P'.($yearNettoCoordinate+1), $ptkpTotal)
                ->setCellValue('L'.($yearNettoCoordinate+2), 'PENGHASILAN KENA PAJAK')
                ->setCellValue('P'.($yearNettoCoordinate+2), $penghasilanPajak);
            $tarifTaxCoordinate = $taxCoordinate + 8;
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+7).':P'.($tarifTaxCoordinate+7))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+7))->applyFromArray($topBorderStyle);
            // $tarifTaxCoordinate = $taxCoordinate + 12; /* TAX ROWS COORDINATE  */
            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.($tarifTaxCoordinate), 'Pembulatan')
                ->setCellValue('P'.($tarifTaxCoordinate), $pembulatan)
                ->setCellValue('L'.($tarifTaxCoordinate+1), 'Tarif Pajak I    '.$taxPercent1)
                ->setCellValue('P'.($tarifTaxCoordinate+1), $taxVal1)
                ->setCellValue('L'.($tarifTaxCoordinate+2), 'Tarif Pajak II    '.$taxPercent2)
                ->setCellValue('P'.($tarifTaxCoordinate+2), $taxVal2)
                ->setCellValue('L'.($tarifTaxCoordinate+3), 'Tarif Pajak III    '.$taxPercent3)
                ->setCellValue('P'.($tarifTaxCoordinate+3), $taxVal3)
                ->setCellValue('L'.($tarifTaxCoordinate+4), 'Tarif Pajak IV    '.$taxPercent4)
                ->setCellValue('P'.($tarifTaxCoordinate+4), $taxVal4)
                ->setCellValue('L'.($tarifTaxCoordinate+5), 'Tarif Pajak V    '.$taxPercent5)
                ->setCellValue('P'.($tarifTaxCoordinate+5), $taxVal5)
                ->setCellValue('L'.($tarifTaxCoordinate+6), 'Total Pajak Sebelumnya') 
                ->setCellValue('P'.($tarifTaxCoordinate+6), $dataTax->totalTaxSebelum)
                ->setCellValue('L'.($tarifTaxCoordinate+7), 'Pajak Akhir')
                ->setCellValue('P'.($tarifTaxCoordinate+7), $taxTot);

            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+6))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+6))->applyFromArray($topBorderStyle);
        }

        $outCoordinate = 29;
        $taxtotDisplay = $taxTot * (-1);
 
        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$outCoordinate, 'Pajak Penghasilan')
            ->setCellValue('N'.$outCoordinate, $golongan)
            ->setCellValue('O'.$outCoordinate, $tarif.'%')
            ->setCellValue('P'.$outCoordinate, $taxtotDisplay)
            ->setCellValue('L'.($outCoordinate+1), 'JKK & JKM')
            ->setCellValue('P'.($outCoordinate+1), '-'. $JkkJkm)
            ->setCellValue('L'.($outCoordinate+2), 'Iuran JHT JP')
            ->setCellValue('P'.($outCoordinate+2), '-'.$JhtJp)
            ->setCellValue('L'.($outCoordinate+3), 'Iuran BPJS Kesehatan')
            ->setCellValue('P'.($outCoordinate+3), '-'.$Bpjs1);

        $outCoordinate2 = $outCoordinate + 4;
        $spreadsheet->getActiveSheet()->getStyle("N".$outCoordinate.":O".$outCoordinate)->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle('L'.$outCoordinate2.':P'.$outCoordinate2)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$outCoordinate2.':P'.$outCoordinate2)->applyFromArray($totalStyle);

        $cutCoordinate = 32;
        $terima = $brutto - ($taxTot + $JkkJkm + $Bpjs1 + $JhtJp);
        // echo 
        $terima_new = $terima  + $adjustment;
        
        $ter = round($terima_new,2);
        $number = round($ter);
        $strTerima = substr($number,-3,6);
        // $thp = 0;
        if ($strTerima > 500) {
            $thp = $number - $strTerima +1000;
            $bulat = $thp - $ter;
        } 
        else if ($strTerima < 500){
            $thp = $number - $strTerima;
            $bulat = $thp - $ter;
        }
        else if ($strTerima == 500){
            $thp = $number;
            $bulat = 0;
        }
        
        $thp = $thp;

        /* END POTONGAN */
        $cutCoordinate2 = $cutCoordinate+5;
        $cutCoordinate3 = $cutCoordinate+5;
             
        $spreadsheet->getActiveSheet()->getStyle("L".$cutCoordinate.":P".$cutCoordinate3)->getFont()->setSize(13);
        $spreadsheet->getActiveSheet()->getStyle('L'.$cutCoordinate3.':P'.$cutCoordinate3)->applyFromArray($totalStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$cutCoordinate2.':P'.$cutCoordinate2)->applyFromArray($topBorderStyle);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$outCoordinate2, 'Potong Pajak')
            ->setCellValue('P'.$outCoordinate2, $terima)  
            ->setCellValue('L'.($cutCoordinate+3), 'Adjustment/Deduction')
            ->setCellValue('N'.($cutCoordinate+3), '('.$keterangan.')')
            ->setCellValue('P'.($cutCoordinate+3), $adjustment)
            ->setCellValue('L'.($cutCoordinate+4), 'Pembulatan')
            ->setCellValue('P'.($cutCoordinate+4), $bulat);

        $totalgaji = round($thp);
        $spreadsheet->getActiveSheet()
              ->setCellValue('L'.($cutCoordinate2), 'TOTAL TERIMA')
              ->setCellValue('P'.($cutCoordinate2), round($thp));
        $spreadsheet->getActiveSheet()
              ->getStyle('L7:P66')->getNumberFormat()
              ->setFormatCode('#,##0.00');
          
          $gajipokok = $upah;
          $tunjangan = $bonusTotal;
          $wdTotal = $wdAttendCount;
          $unpaid = 0;
          $taxreg = $pajakPlusSebulan;
          $taxnonreg = $pajakNonReg;
          $taxpenalty = $taxPinalty;

          
        $trSlip->settotalot($allottotal);
        $trSlip->setgaji($terima);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setpph21($taxTot);
        $trSlip->setwdTotal($wdTotal);
        $trSlip->setround($bulat);
        // $trSlip->setround($round);
        $trSlip->settunjangan($tunjangan);
        // $trSlip->setgajipokok($gajipokok); 
        $trSlip->setunpaid($unpaid);
        $trSlip->settaxreg($taxreg);
        $trSlip->settaxnonreg($taxnonreg);
        $trSlip->settaxpenalty($taxpenalty);
        $trSlip->setpotonganAbsensi($absensi);
        $trSlip->settunjanganJabatan($TJabatan);
        $trSlip->setnetto($netto);
        $trSlip->setbonusNonReg($bonusNonReg);
        $trSlip->setBrutto($brutto);
        $trSlip->Rep($ts_id);
        $spreadsheet->getActiveSheet()->setTitle($row['full_name']);

        $spreadsheet->setActiveSheetIndex($noNewSheet);
        /*s*/
        // $spreadsheet->setActiveSheetIndex(0);
        $str = $row['full_name'].$row['bio_rec_id'].'-'.$row['month_process'].$row['year_process'];
        $fileName = preg_replace('/\s+/', '', $str);
        
        $spreadsheet->createSheet();
        return $fileName;

        // Redirect output to a clients web browser (Xlsx)

    }

    public function Excel_split($ts_id,$checkBpjs,$checkJHT,$checkJP,$checkJKKJKM,$spreadsheet, $noNewSheet)
    {
        $trSlip = new M_tr_slip();
        $rpDb = new M_rp_db();
        $writer = new Xls($spreadsheet);


        $spreadsheet->getProperties()->setCreator('Maurice - Web - Android')
            ->setLastModifiedBy('Maurice - Web - Android')
            ->setTitle('Office 2007 XLSX Test Document')
            ->setSubject('Office 2007 XLSX Test Document')
            ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
            ->setKeywords('office 2007 openxml php')
            ->setCategory('Test result file');
        $boldFont = [
            'font' => [
                'bold' => true
                // 'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyle = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyles = [
            'font' => [
                'bold' => true ,
                'color' => ['argb' => 'FFFF0000'],
            ],
        ];

        $allBorderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $outlineBorderStyle = [
            'borders' => [
                'outline' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $topBorderStyle = [
            'borders' => [
                'top' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $bottomBorderStyle = [
            'borders' => [
                'bottom' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];
        $center = array();
        $center['alignment'] = array();
        $center['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER; 
        $center['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER; 

        $right = array();
        $right['alignment'] = array();
        $right['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_RIGHT; 
        $right['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $left = array();
        $left['alignment'] = array();
        $left['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_LEFT; 
        $left['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;
        $rowIdx = 0;
        $ot01Count = 0;
        $ot02Count = 0;
        $ot03Count = 0;
        $ot04Count = 0;
        $totalHour = 0;
        $allTimeTotal = 0;
        $normalTotal = 0;
        $wDayTotal = 0;
        $rowIdx = 8;
        $rowIdx_new = 8;
        $totalTitle_sum = 0;
        $attendStatus = 0;
        $bonusTotal = 0;
        $taxVal1 = 0;
        $taxVal2 = 0;
        $taxVal3 = 0;
        $taxVal4 = 0;
        $taxVal5 = 0;
        $penghasilanPajak = 0;
        $pajakNonReg = 0;
        $pajakPlusSebulan = 0;
        $pajakGajiSthn = 0;
        $pajakSebulan = 0;
        $tTimePerday = 0;
        $wdAttendCount = 0;
        $alpa = 0;
        $bsProrate = 0;
        $end = 0;
        
        



        $trTimesheet = new M_tr_timesheet();
        $row = $trTimesheet->Print($ts_id);
        $biodataId =  $row['biodata_id'];
        $row['bank_id'];
        $nama = $row['full_name'];
        $jabatan = $row['position'];
        $status = $row['marital_status'];
        $id = $row['biodata_id'];
        $dept = $row['dept'];
        $bpjs = $row['bpjs'];
        $monthly = $row['monthly'];
        $siang = $row['allowance_01'];
        $malam = $row['allowance_02'];
        $jk = $row['jk'];
        $jkk = $row['jkk'];
        $jkm = $row['jkm'];
        $bpjstk = $row['emp_bpjs'];
        $empjht = $row['emp_jht'];
        $jkkjkm = $row['jkkjkm'];
        $jptk = $row['emp_jp'];
        $adjustment = $row['adjustment'];
        $keterangan = $row['status_remarks'];
        $client_display = 'PT. Agincourt Resources Martabe Gold Mine';
        $tDate1 = $row['month_process'];
        $tDate3 = $row['year_process'];
        $startDate = $row['start_date'];
        $npwp = $row['tax_no'];
        $sPayroll = $row['status_payroll'];
        $alpa = $row['alpa_total'];
        $izin = $row['permit_total'];
        $bsProrate = $row['real_gajipokok'];
        $statusBPJS = $row['bpjs_status'];
        $tanggal = $tDate3.'-'.$tDate1.'-'.$startDate;
        // echo $nama;
        // exit();
        $dayCountInMonth = cal_days_in_month(CAL_GREGORIAN, $tDate1, $tDate3);
        $tanggal1 = $tanggal;
        for ($i=1; $i <= $dayCountInMonth; $i++) { 
            // echo $i.'<br/>';
            $tunjanganMalam = 0;
            $tunjanganSiang = 0;
            /* START NUMBER TITLE */
            $rowIdx++;
            $rowIdx_new++;
            $in = '';
            
            $ot01Column = '';
            $ot02Column = '';
            $ot03Column = '';
            $ot04Column = '';

            if($i < 10){
                $ot01Column = 'ot1_d0'.$i;
                $ot02Column = 'ot2_d0'.$i;
                $ot03Column = 'ot3_d0'.$i;
                $ot04Column = 'ot4_d0'.$i;
                $timePerday = 'd0'.$i;
                $in = 'in0'.$i;
            }else{
                $ot01Column = 'ot1_d'.$i;
                $ot02Column = 'ot2_d'.$i;
                $ot03Column = 'ot3_d'.$i;
                $ot04Column = 'ot4_d'.$i;
                $timePerday = 'd'.$i;
                $in = 'in'.$i;
            }
            $ot01Val = $row[$ot01Column];
            $ot02Val = $row[$ot02Column];
            $ot03Val = $row[$ot03Column];
            $ot04Val = $row[$ot04Column];
            $inVal   = $row[$in];

            $strTimePerday = $row[$timePerday] ;


            $phCodeTmp = substr($strTimePerday,0,2);
            
            $phHoursTmp = substr($strTimePerday,2,5);

            

            if (($phCodeTmp == 'OA' || $phCodeTmp == 'HA' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN' || $phCodeTmp == 'PH' || $phCodeTmp == 'RO') && ($phHoursTmp == 0 || empty($phHoursTmp))) {
                $phHoursTmp = 0;
            } 
            $outVal = (double)$inVal + (double)$phHoursTmp +1;
            // echo $outVal.'</br>';
            // if ($outVal > 24) {
            //     $outVal = $outVal - 24;
            // } 
            // if ((double)$inVal == 0) {
            //     $outVal = 0;
            // }
            if ($strTimePerday == "STR" || $strTimePerday == "END") {
                $phHoursTmp = 0;
                $phCodeTmp = $strTimePerday;
            }

            if ($phHoursTmp == null || $phHoursTmp == '') {
                $phHoursTmp = 0;
            }


            
            if ($phCodeTmp == "SL" || $phCodeTmp == "AI" || $phCodeTmp == "AB" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $phHoursTmp = 0;
            }
            $totalHour = $phHoursTmp;
            if ($phCodeTmp == "AS" || $phCodeTmp == "OA" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "ON" || $phCodeTmp == "NS" || $phCodeTmp == 'DS' || $phCodeTmp == "PH" || $phCodeTmp == 'RO') {
                $tTimePerday = $phHoursTmp;
            }
            else
            {
                $tTimePerday = $row[$timePerday];
            }
            if(is_numeric($tTimePerday))
            {
                $timeTotal = $tTimePerday;
                if($tTimePerday > 1) {
                    $attendStatus = 1;
                }
            }
            // if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AB" || $phCodeTmp == "AI" || $phCodeTmp == "AL") {
            //     $absen = 1;
            // } else {
            //     $absen = 0;
            // }

            if ($phCodeTmp == "DS" || $phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "SL" || $phCodeTmp == "MD" || $phCodeTmp == "AL") {
                $absen = 1;
            } else if($phCodeTmp == "AB" || $phCodeTmp == "AI"){
                $absen = 0;
            } else {
                $absen = 0;
            }

            if ($phCodeTmp == "END") {
                $end = 1;
            }

            $totalTitle = $rowIdx_new+2;
            $wdAttendCount = $wdAttendCount + $absen;
            $timeTotal = $tTimePerday++;

            if ($phCodeTmp == "NS" || $phCodeTmp == "AS" || $phCodeTmp == "DS")
            {
                $shift_Day = $phCodeTmp;
                $wDay = 1;
                $roPh = '';
            } else {
                $shift_Day = '';
                $wDay = 0;
                $roPh = $phCodeTmp;
            }
            
            $day = date('D', strtotime($tanggal));
            $dayList = array(
                'Sun' => 'Minggu',
                'Mon' => 'Senin',
                'Tue' => 'Selasa',
                'Wed' => 'Rabu',
                'Thu' => 'Kamis',
                'Fri' => 'Jumat',
                'Sat' => 'Sabtu'
            );
            $rdData =  $dayList[$day];


            $ot01Count += $ot01Val;
            $ot02Count += $ot02Val;
            $ot03Count += $ot03Val;
            $ot04Count += $ot04Val;
            $normalTime = $totalHour - $ot01Val - $ot02Val - $ot03Val - $ot04Val;

            if ($phCodeTmp == "OA" || $phCodeTmp == "ON" || $phCodeTmp == "RO" || $phCodeTmp == "HA" || $phCodeTmp == "HN" || $phCodeTmp == "PH") {
                $normalTime = 0 ;
            }
            $normalTotal = $normalTotal + $normalTime;
            $wDayTotal = $wDayTotal + $wDay;
           
            if ($phCodeTmp == 'AS' || $phCodeTmp == 'OA' || $phCodeTmp == 'HA') {
                $tunjanganSiang = 1;
            } 
            if ($phCodeTmp == 'NS' || $phCodeTmp == 'ON' || $phCodeTmp == 'HN') {
                $tunjanganMalam = 1;
            }
           


            $spreadsheet->getActiveSheet()->getStyle('A'.$rowIdx.':A'.$rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('A'.$rowIdx.':A'.$rowIdx)->applyFromArray($right);
            $spreadsheet->getActiveSheet()->setCellValue('A'.$rowIdx, $tanggal);
            
            
            $spreadsheet->getActiveSheet()
                    ->setCellValue('B'.$rowIdx, $rdData)
                    ->setCellValue('C'.$rowIdx, $phCodeTmp)
                    ->setCellValue('D'.$rowIdx, $timeTotal)
                    ->setCellValue('E'.$rowIdx, $wDay)
                    ->setCellValue('F'.$rowIdx, $normalTime)
                    ->setCellValue('G'.$rowIdx, $ot01Val)
                    ->setCellValue('H'.$rowIdx, $ot02Val)
                    ->setCellValue('I'.$rowIdx, $ot03Val)
                    ->setCellValue('J'.$rowIdx, $ot04Val);

            $spreadsheet->getActiveSheet()->getStyle("B".$rowIdx.":J".$rowIdx)->applyFromArray($allBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle("B".$rowIdx.":J".$rowIdx)->applyFromArray($center); 

            $totalOt = $ot01Val + $ot02Val + $ot03Val + $ot04Val;
            $dayss = $wdAttendCount - 1;
            $dateProcessing = str_replace("-","",$tanggal);
                
            $tanggal = date('Y-m-d', strtotime('+1 days', strtotime($dateProcessing)));
            $allTimeTotal = $allTimeTotal + $phHoursTmp;
            $biodata_id = $row['biodata_id'];
            $ts_id = $row['ts_id'];
            $slip_id = $row['slip_id'];
            $allTunjangan = $malam + $siang;
            $ot1 = 1.5;
            $ot2 = 2.0;
            $ot3 = 3.0;
            $ot4 = 4.0;
            $salaryHourly = $monthly / 173;

            $valueOt1 = $ot01Val * $ot1 * $salaryHourly;
            $valueOt2 = $ot02Val * $ot2 * $salaryHourly;
            $valueOt3 = $ot03Val * $ot3 * $salaryHourly;
            $valueOt4 = $ot04Val * $ot4 * $salaryHourly;

            $totalOtValue = $valueOt1 + $valueOt2 + $valueOt3 + $valueOt4; 
        }
        
        $endDate = date('Y-m-d', strtotime('+'.$dayss.'days', strtotime($tanggal1)));
            
            
        $spreadsheet->getActiveSheet()->getColumnDimension('A')->setWidth(6);             
        $spreadsheet->getActiveSheet()->getColumnDimension('B')->setWidth(9);             
        $spreadsheet->getActiveSheet()->getColumnDimension('C')->setWidth(7);             
        $spreadsheet->getActiveSheet()->getColumnDimension('D')->setWidth(8);         
        $spreadsheet->getActiveSheet()->getColumnDimension('E')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('F')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('G')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('H')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('I')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('J')->setWidth(5);             
        $spreadsheet->getActiveSheet()->getColumnDimension('K')->setWidth(3);
        $spreadsheet->getActiveSheet()->getColumnDimension('M')->setWidth(8);

        $spreadsheet->getActiveSheet()
            ->setCellValue('A1', 'PT. SANGATI SOERYA SEJAHTERA')
            ->setCellValue('A2', 'Slip Gaji Karyawan')
            ->setCellValue('A4', 'PT : '.$client_display)
            ->setCellValue('A5', 'STARTDATE : '.$tanggal1.' to '.$endDate);

        $spreadsheet->getActiveSheet()->getStyle("A1:D1")->getFont()->setBold(true)->setSize(16);
        $spreadsheet->getActiveSheet()->getStyle("A2:D2")->getFont()->setBold(true)->setSize(14)->setUnderline(true);
        $spreadsheet->getActiveSheet()->getStyle("A4:G4")->getFont()->setBold(true)->setSize(12);

        $spreadsheet->getActiveSheet()->mergeCells("A6:A7");
        $spreadsheet->getActiveSheet()->mergeCells("B6:B7");
        $spreadsheet->getActiveSheet()->mergeCells("C6:C7");
        $spreadsheet->getActiveSheet()->mergeCells("D6:D7"); 
        $spreadsheet->getActiveSheet()->mergeCells("E6:E7");
        $spreadsheet->getActiveSheet()->mergeCells("F6:F7");
        $spreadsheet->getActiveSheet()->mergeCells("G6:J6");
        
        $spreadsheet->getActiveSheet()->getStyle("A6:F7")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("G6:J7")->applyFromArray($allBorderStyle);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($center);

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()
            ->setCellValue('A6', 'DATE')
            ->setCellValue('B6', 'ROSTER DAY')
            ->setCellValue('C6', 'SHIFT DAY')
            ->setCellValue('D6', 'HOURS TOTAL')
            ->setCellValue('E6', 'WORK DAY')
            ->setCellValue('F6', 'NT')
            ->setCellValue('G6', 'OVERTIME')
            ->setCellValue('G7', '1')
            ->setCellValue('H7', '2')
            ->setCellValue('I7', '3')
            ->setCellValue('J7', '4');

        $spreadsheet->getActiveSheet()->getStyle("A6:J7")->applyFromArray($boldFont);
          

        $totalTitle = $rowIdx+1;
        $spreadsheet->getActiveSheet()
            ->setCellValue('A'.$totalTitle, 'TOTAL')
            ->setCellValue('C'.$totalTitle, $wdAttendCount)
            ->setCellValue('D'.$totalTitle, $allTimeTotal)
            ->setCellValue('E'.$totalTitle, $wDayTotal)
            ->setCellValue('F'.$totalTitle, $normalTotal)
            ->setCellValue('G'.$totalTitle, $ot01Count)
            ->setCellValue('H'.$totalTitle, $ot02Count)
            ->setCellValue('I'.$totalTitle, $ot03Count)
            ->setCellValue('J'.$totalTitle, $ot04Count);

        $totalTitle_sum         = $totalTitle;
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle)->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle)->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle)->getFont()->setBold(true)->setSize(13);
        
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->getFont()->setBold(true)->setSize(13);

        $totalTitle = $totalTitle+1;
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->applyFromArray($left);

        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":A".$totalTitle)->getFont()->setBold(true)->setSize(13);
        
        $spreadsheet->getActiveSheet()->setCellValue('A'.$totalTitle, 'TOTAL OT');
        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle."")->applyFromArray($right);
        $spreadsheet->getActiveSheet()->getStyle("A".$totalTitle.":J".$totalTitle."")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->mergeCells("C".$totalTitle.":J".$totalTitle."");
        $spreadsheet->getActiveSheet()->getStyle("C".$totalTitle.":J".$totalTitle."")->getFont()->setBold(true)->setSize(13);
        $spreadsheet->getActiveSheet()->setCellValue('C'.$totalTitle, '=SUM(G'.$totalTitle_sum.':J'.$totalTitle_sum.')');
            
            
        $spreadsheet->getActiveSheet()->getStyle("A43:J59")->applyFromArray($outlineBorderStyle);
        
        $bankName = $row['bank_name'];
        $bankNo = $row['account_no'];
        $spreadsheet->getActiveSheet()
                ->setCellValue('C43', 'Dibayarkan Oleh')    
                ->setCellValue('C48', 'Payroll/ Accounting')    
                ->setCellValue('C52', 'Diterima Oleh Karyawan')    
                ->setCellValue('C57', $row['full_name'])
                ->setCellValue('C58', $bankName." : ".$bankNo);
        
        $spreadsheet->getActiveSheet()->getStyle("L4:M4")->applyFromArray($left);
        $spreadsheet->getActiveSheet()->getStyle("L4:R43")->getFont()->setSize(13);

        $basicSalary = $monthly;
        $salaryHourly = $monthly / 173;
        $salaryDay = $basicSalary / 20;
        $upah = 0 ;
        // if ($sPayroll == 'daily' || $sPayroll == 'Daily') {
            // $upah = $salaryDay * $wdAttendCount;
        // } 
        // else if ($sPayroll == 'daily p' || $sPayroll == 'Daily p') {
            // $upah = $salaryDay * $wdAttendCount;
        // }
        // else if ($sPayroll == 'month' || $sPayroll == 'Monthly') {
            $upah = $bsProrate;
        // }
        // dd($salaryDay);
        $absensi = ($alpa + $izin) * $salaryDay;
        
        $month_sekarang      = date('F', strtotime('+1 month', strtotime($row['year_process'].'-'.$row['month_process'].'-10')));
        $month_kemarin     = date('F', strtotime($row['year_process'].'-'.$row['month_process'].'-10'));

        // dd($row['year_process'].'-'.$row['month_process'].'-10'.' -> '.$month_kemarin.' '.$month_sekarang);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L4', 'NAMA')
            ->setCellValue('N4', $row['full_name'])
            ->setCellValue('O4', 'Id')
            ->setCellValue('P4', $id)
            ->setCellValue('L5', 'JABATAN')
            ->setCellValue('N5', $row['position'])
            ->setCellValue('O5', 'DEPT ')
            ->setCellValue('P5', $dept)
            ->setCellValue('L6', 'STATUS')
            ->setCellValue('N6', $row['marital_status'])
            ->setCellValue('O6', 'NPWP ')
            ->setCellValue('P6', $npwp)
            ->setCellValue('L7', 'UMK')
            ->setCellValue('N7', $basicSalary)
            ->setCellValue('O7', 'RATE/DAY')
            ->setCellValue('P7', $salaryDay)
            ->setCellValue('L8', 'RATE/HOUR')
            ->setCellValue('N8', $salaryHourly)
            ->setCellValue('L10', 'UPAH')
            
            ->setCellValue('N9', 'Periode '.$month_kemarin)
            ->setCellValue('O9', 'Periode '.$month_sekarang)

            ->setCellValue('N10', $row['gajisebelum'])
            ->setCellValue('O10', $row['gajisesudah'])

            ->setCellValue('P10', $upah)
            ->setCellValue('L11', 'OT 1')
            ->setCellValue('L12', 'OT 2')
            ->setCellValue('L13', 'OT 3')
            ->setCellValue('L14', 'OT 4')
            ;  

        $spreadsheet->getActiveSheet()->getStyle('N7:N8')->applyFromArray($totalStyle);

        
        $ot1 = 1.5;
        $ot2 = 2.0;
        $ot3 = 3.0;
        $ot4 = 4.0;


        $hasilOt1 = $ot01Count * $ot1 * $salaryHourly;
        $hasilOt2 = $ot02Count * $ot2 * $salaryHourly;
        $hasilOt3 = $ot03Count * $ot3 * $salaryHourly;
        $hasilOt4 = $ot04Count * $ot4 * $salaryHourly;
        $allottotal = $hasilOt1 + $hasilOt2 + $hasilOt3 + $hasilOt4;
        


        $strOT1 = number_format($ot01Count,1)." x ".number_format($ot1,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT2 = number_format($ot02Count,1)." x ".number_format($ot2,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT3 = number_format($ot03Count,1)." x ".number_format($ot3,1)." x ".number_format($salaryHourly,2)." = Rp.";
        $strOT4 = number_format($ot04Count,1)." x ".number_format($ot4,1)." x ".number_format($salaryHourly,2)." = Rp.";

        $spreadsheet->getActiveSheet()
            ->setCellValue('N11', $strOT1)
            ->setCellValue('O11', $hasilOt1)
            ->setCellValue('N12', $strOT2)
            ->setCellValue('O12', $hasilOt2)
            ->setCellValue('N13', $strOT3)
            ->setCellValue('O13', $hasilOt3)
            ->setCellValue('N14', $strOT4)
            ->setCellValue('O14', $hasilOt4)
            ->setCellValue('L15', 'OT TOTAL')
            ->setCellValue('P15', $allottotal);

        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L16:P16')->applyFromArray($totalStyle);

        $bonusIdx = 17;
        $Thr = $row['thr'];
        $bonusdll = $row['allowance_03'];
        $bonusTotal = $malam + $siang + $Thr + $bonusdll;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$bonusIdx, 'Shift Malam')
            ->setCellValue('O'.$bonusIdx, $malam)
            ->setCellValue('L'.($bonusIdx+1), 'Shift Siang')
            ->setCellValue('O'.($bonusIdx+1), $siang)
            ->setCellValue('L'.($bonusIdx+2), 'THR')
            ->setCellValue('O'.($bonusIdx+2), $Thr)
            ->setCellValue('L'.($bonusIdx+3), 'Lain-lain')
            ->setCellValue('O'.($bonusIdx+3), $bonusdll)
            ->setCellValue('L'.($bonusIdx+4), 'BONUS TOTAL')
            ->setCellValue('P'.($bonusIdx+4), $bonusTotal);

        $spreadsheet->getActiveSheet()->getStyle('L'.($bonusIdx+4).':P'.($bonusIdx+4))->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.($bonusIdx+4).':P'.($bonusIdx+4))->applyFromArray($totalStyle);

        $govRegIdx = 23;
        $Bpjs = $basicSalary * 0.04;
        // echo $Bpjs.' '.$basicSalary;
        // exit();
        $JkkJkm = $basicSalary * 0.0204;
        $JHT2 = $basicSalary * 0.037;
        $JHT = $basicSalary * 0.02;
        $Bpjs1 = $basicSalary * 0.05;
        $JP = $basicSalary * 0.01;
        // $JkkJkm = $row['jkkjkm'];
        // $Bpjs = $row['bpjs'];
        // $JHT = $row['emp_jht'];
        // $JP = $row['emp_jp'];
        // $JHT2 = $row['jht'];
        // $Bpjs1 = $row['emp_bpjs'];
        $check = $trSlip->validasiBpjs($biodataId, $tDate1, $tDate3, $row['slip_period']);
        
        if (!isset($check['BPJS'])) {
            $checkBpjs1 = 0;
        } else {
           $checkBpjs1 = $check['BPJS']; 
        }
        if (!isset($check['JHT'])) {
            $checkJHT1 = 0;
        } else {
           $checkJHT1 = $check['JHT']; 
        }
        if (!isset($check['JP'])) {
            $checkJP1 = 0;
        } else {
           $checkJP1 = $check['JP']; 
        }
        if (!isset($check['JKKJKM'])) {
            $checkJKKJKM1 = 0;
        } else {
           $checkJKKJKM1 = $check['JKKJKM']; 
        }

        if ($checkBpjs == 0 || $checkBpjs1 > 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        if ($checkJHT == 0 || $checkJHT1 > 0) {
            $JHT = 0;
            $JHT2 = 0;
            // $JhtJp =0;
        }
        if ($checkJP == 0 || $checkJP1 > 0) {
            $JP = 0;
            // $JhtJp = 0;
        }
        if ($checkJKKJKM == 0 || $checkJKKJKM1 > 0) {
            $JkkJkm = 0;
            
        }

        if ($statusBPJS == 0) {
            $Bpjs = 0;
            $Bpjs1 = 0;
        }
        $JhtJp = $JHT + $JP;

        $trSlip->setBpjs($Bpjs);
        $trSlip->setJkkjkm($JkkJkm);
        $trSlip->setEmpJht($JHT);
        $trSlip->setEmpBpjs($Bpjs1);
        $trSlip->setEmpJp($JP);

        $trSlip->setJht($JHT2);
        $trSlip->setJhtjp($JhtJp);
        $trSlip->UpdTunjangan($ts_id);



      //   $checkBpjs = $_POST['cbHealthBPJS'];
      // $checkJHT = $_POST['cbJHT'];
      // $checkJP = $_POST['cbJP'];
      // $checkJKKJKM = $_POST['cbJKKM'];
        $subTotalVal = $JkkJkm + $Bpjs - $absensi;
        $brutto =$upah + $allottotal + $bonusTotal  + $subTotalVal ;

        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$govRegIdx, 'JKK & JKM')
            ->setCellValue('O'.$govRegIdx, $JkkJkm)
            ->setCellValue('L'.($govRegIdx+1), 'Iuran BPJS Kesehatan(4%)')
            ->setCellValue('O'.($govRegIdx+1), $Bpjs)
            ->setCellValue('L'.($govRegIdx+2), 'Potongan Absensi')
            ->setCellValue('O'.($govRegIdx+2), '-'.$absensi)
            ->setCellValue('L'.($govRegIdx+3), 'Subtotal')
            ->setCellValue('P'.($govRegIdx+3), $subTotalVal);
        $spreadsheet->getActiveSheet()->getStyle('L'.($govRegIdx+3).':P'.($govRegIdx+3))->applyFromArray($totalStyle);

        $bruttoCoordinate = $govRegIdx+4;
        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$bruttoCoordinate, 'TOTAL KOTOR')
            ->setCellValue('P'.$bruttoCoordinate, $brutto);

        $spreadsheet->getActiveSheet()->getStyle('L'.$bruttoCoordinate.':P'.$bruttoCoordinate)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$bruttoCoordinate.':P'.$bruttoCoordinate)->applyFromArray($totalStyle);

        // echo $biodataId.'-'.$brutto.'-'.$status.'-'.$end.'-'.$tDate1.'-'.$tDate3;
        // exit();

        $dataTax = $this->taxApi($biodataId, $brutto, $status, $end, $tDate1, $tDate3);
        // dd($dataTax);

        /* DATA PAJAK DARI API */

        $taxPinalty       = $dataTax->tax_pinalty;
        $TJabatan         = $dataTax->tunjangan_jabatan;
        $taxTot           = $dataTax->tax;
        $bruttoSetahun    = $dataTax->brutto_setahun;
        $nettoSetahun     = $dataTax->netto_setahun;
        $jpSetahun        = $dataTax->jp_setahun;
        $jhtSetahun       = $dataTax->jht_setahun;
        $ptkpTotal        = $dataTax->nilai_ptkp;
        $penghasilanPajak = $dataTax->penghasilan_pajak;
        $taxPercent1      = $dataTax->tax_percent_1;
        $taxPercent2      = $dataTax->tax_percent_2;
        $taxPercent3      = $dataTax->tax_percent_3;
        $taxPercent4      = $dataTax->tax_percent_4;
        $taxPercent5      = $dataTax->tax_percent_5;
        $taxVal1          = $dataTax->tax_val_1;
        $taxVal2          = $dataTax->tax_val_2;
        $taxVal3          = $dataTax->tax_val_3;
        $taxVal4          = $dataTax->tax_val_4;
        $taxVal5          = $dataTax->tax_val_5;
        $pembulatan       = $dataTax->pembulatan;
        $golongan         = $dataTax->golongan;
        $tarif            = $dataTax->tarif;
        $netto            = 0;
        $bonusNonReg      = 0;

        if ($tDate1 == 12) {
            $taxCoordinate = 39; /* TAX ROWS COORDINATE  */
            $tmpCoordinate1 = $taxCoordinate+16;
            $tmpCoordinate2 = 0;

            $spreadsheet->getActiveSheet()->getStyle("L".$taxCoordinate.":P".($tmpCoordinate1-1))->applyFromArray($outlineBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.$taxCoordinate.':P'.($taxCoordinate))->applyFromArray($totalStyle);
            // $tmpCoordinate1 = $taxCoordinate + 19;
            $spreadsheet->getActiveSheet()->getStyle("L".$taxCoordinate.":P".$tmpCoordinate1)->getFont()->setSize(13);


            
        

            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.$taxCoordinate, 'PERHITUNGAN PAJAK PENGHASILAN')
                ->setCellValue('L'.($taxCoordinate+1), 'Penghasilan Kotor')
                ->setCellValue('P'.($taxCoordinate+1), $bruttoSetahun)
                ->setCellValue('L'.($taxCoordinate+2), 'Iuran JHT JP')
                ->setCellValue('P'.($taxCoordinate+2), '-'.$jpSetahun)
                ->setCellValue('L'.($taxCoordinate+3), 'Iuran JHT')
                ->setCellValue('P'.($taxCoordinate+3), '-'.$jhtSetahun)            
                ->setCellValue('L'.($taxCoordinate+4), 'Tunjangan Jabatan')
                ->setCellValue('P'.($taxCoordinate+4), '-'.$TJabatan);

            // $nettoCoordinate = 45;
            // echo $netto;
            // exit();

            // $spreadsheet->getActiveSheet()->getStyle('L'.$nettoCoordinate.':P'.($nettoCoordinate))->applyFromArray($totalStyle);
            // $spreadsheet->getActiveSheet()
            //     ->setCellValue('L'.$nettoCoordinate, 'Netto')
            //     ->setCellValue('P'.$nettoCoordinate, $netton);

            $yearNettoCoordinate = 44;
            // $ptkpTotal = 0;
            $spreadsheet->getActiveSheet()->getStyle('L'.$yearNettoCoordinate.':P'.($yearNettoCoordinate))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($yearNettoCoordinate+3).':P'.($yearNettoCoordinate+3))->applyFromArray($topBorderStyle);
            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.$yearNettoCoordinate, 'Netto Disetahunkan(Tetap)')
                ->setCellValue('P'.$yearNettoCoordinate, $nettoSetahun)
                ->setCellValue('L'.($yearNettoCoordinate+1), 'PTKP '.$row['marital_status'])
                ->setCellValue('P'.($yearNettoCoordinate+1), $ptkpTotal)
                ->setCellValue('L'.($yearNettoCoordinate+2), 'PENGHASILAN KENA PAJAK')
                ->setCellValue('P'.($yearNettoCoordinate+2), $penghasilanPajak);
            $tarifTaxCoordinate = $taxCoordinate + 8;
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+7).':P'.($tarifTaxCoordinate+7))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+7))->applyFromArray($topBorderStyle);
            // $tarifTaxCoordinate = $taxCoordinate + 12; /* TAX ROWS COORDINATE  */
            $spreadsheet->getActiveSheet()
                ->setCellValue('L'.($tarifTaxCoordinate), 'Pembulatan')
                ->setCellValue('P'.($tarifTaxCoordinate), $pembulatan)
                ->setCellValue('L'.($tarifTaxCoordinate+1), 'Tarif Pajak I    '.$taxPercent1)
                ->setCellValue('P'.($tarifTaxCoordinate+1), $taxVal1)
                ->setCellValue('L'.($tarifTaxCoordinate+2), 'Tarif Pajak II    '.$taxPercent2)
                ->setCellValue('P'.($tarifTaxCoordinate+2), $taxVal2)
                ->setCellValue('L'.($tarifTaxCoordinate+3), 'Tarif Pajak III    '.$taxPercent3)
                ->setCellValue('P'.($tarifTaxCoordinate+3), $taxVal3)
                ->setCellValue('L'.($tarifTaxCoordinate+4), 'Tarif Pajak IV    '.$taxPercent4)
                ->setCellValue('P'.($tarifTaxCoordinate+4), $taxVal4)
                ->setCellValue('L'.($tarifTaxCoordinate+5), 'Tarif Pajak V    '.$taxPercent5)
                ->setCellValue('P'.($tarifTaxCoordinate+5), $taxVal5)
                ->setCellValue('L'.($tarifTaxCoordinate+6), 'Tax Pinalty')
                ->setCellValue('P'.($tarifTaxCoordinate+6), $pajakGajiSthn)
                ->setCellValue('L'.($tarifTaxCoordinate+7), 'Pajak Akhir')
                ->setCellValue('P'.($tarifTaxCoordinate+7), $taxTot);

            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+6))->applyFromArray($totalStyle);
            $spreadsheet->getActiveSheet()->getStyle('L'.($tarifTaxCoordinate+6).':P'.($tarifTaxCoordinate+6))->applyFromArray($topBorderStyle);
        }

        $outCoordinate = 29;
        $taxtotDisplay = $taxTot * (-1);
 
        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$outCoordinate, 'Pajak Penghasilan')
            ->setCellValue('N'.$outCoordinate, $golongan)
            ->setCellValue('O'.$outCoordinate, $tarif.'%')
            ->setCellValue('P'.$outCoordinate, $taxtotDisplay)
            ->setCellValue('L'.($outCoordinate+1), 'JKK & JKM')
            ->setCellValue('P'.($outCoordinate+1), '-'. $JkkJkm)
            ->setCellValue('L'.($outCoordinate+2), 'Iuran JHT JP')
            ->setCellValue('P'.($outCoordinate+2), '-'.$JhtJp)
            ->setCellValue('L'.($outCoordinate+3), 'Iuran BPJS Kesehatan')
            ->setCellValue('P'.($outCoordinate+3), '-'.$Bpjs1);

        $outCoordinate2 = $outCoordinate + 4;
        $spreadsheet->getActiveSheet()->getStyle("N".$outCoordinate.":O".$outCoordinate)->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle('L'.$outCoordinate2.':P'.$outCoordinate2)->applyFromArray($topBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$outCoordinate2.':P'.$outCoordinate2)->applyFromArray($totalStyle);

        $cutCoordinate = 32;
        $terima = $brutto - $taxTot - $JkkJkm - $Bpjs1 - $JhtJp;


        
        $ter = round($terima,2);
        $number = round($ter);
        $strTerima = substr($number,-3,6);
        // $thp = 0;
        if ($strTerima > 500) {
            $thp = $number - $strTerima +1000;
            $bulat = $thp - $ter;
        } 
        else if ($strTerima < 500){
            $thp = $number - $strTerima;
            $bulat = $thp - $ter;
        }
        else if ($strTerima == 500){
            $thp = $number;
            $bulat = 0;
        }
        
        $thp = $thp + $adjustment;

        /* END POTONGAN */
        $cutCoordinate2 = $cutCoordinate+5;
        $cutCoordinate3 = $cutCoordinate+5;
             
        $spreadsheet->getActiveSheet()->getStyle("L".$cutCoordinate.":P".$cutCoordinate3)->getFont()->setSize(13);
        $spreadsheet->getActiveSheet()->getStyle('L'.$cutCoordinate3.':P'.$cutCoordinate3)->applyFromArray($totalStyle);
        $spreadsheet->getActiveSheet()->getStyle('L'.$cutCoordinate2.':P'.$cutCoordinate2)->applyFromArray($topBorderStyle);

        $spreadsheet->getActiveSheet()
            ->setCellValue('L'.$outCoordinate2, 'Potong Pajak')
            ->setCellValue('P'.$outCoordinate2, $terima)  
            ->setCellValue('L'.($cutCoordinate+3), 'Adjustment/Deduction')
            ->setCellValue('N'.($cutCoordinate+3), '('.$keterangan.')')
            ->setCellValue('P'.($cutCoordinate+3), $adjustment)
            ->setCellValue('L'.($cutCoordinate+4), 'Pembulatan')
            ->setCellValue('P'.($cutCoordinate+4), $bulat);

        $totalgaji = round($thp);
        $spreadsheet->getActiveSheet()
              ->setCellValue('L'.($cutCoordinate2), 'TOTAL TERIMA')
              ->setCellValue('P'.($cutCoordinate2), round($thp));
        $spreadsheet->getActiveSheet()
              ->getStyle('L7:P66')->getNumberFormat()
              ->setFormatCode('#,##0.00');
          
          $gajipokok = $upah;
          $tunjangan = $bonusTotal;
          $wdTotal = $wdAttendCount;
          $unpaid = 0;
          $taxreg = $pajakPlusSebulan;
          $taxnonreg = $pajakNonReg;
          $taxpenalty = $taxPinalty;

          
        $trSlip->settotalot($allottotal);
        $trSlip->setgaji($terima);
        $trSlip->settotalgaji($totalgaji);
        $trSlip->setpph21($taxTot);
        $trSlip->setwdTotal($wdTotal);
        $trSlip->setround($bulat);
        $trSlip->settunjangan($tunjangan);
        $trSlip->setgajipokok($gajipokok); 
        $trSlip->setunpaid($unpaid);
        $trSlip->settaxreg($taxreg);
        $trSlip->settaxnonreg($taxnonreg);
        $trSlip->settaxpenalty($taxpenalty);
        $trSlip->setpotonganAbsensi($absensi);
        $trSlip->settunjanganJabatan($TJabatan);
        $trSlip->setnetto($netto);
        $trSlip->setbonusNonReg($bonusNonReg);
        $trSlip->setBrutto($brutto);
        $trSlip->Rep($ts_id);
        $spreadsheet->getActiveSheet()->setTitle($row['full_name']);

        $spreadsheet->setActiveSheetIndex($noNewSheet);
        /*s*/
        // $spreadsheet->setActiveSheetIndex(0);
        $str = $row['full_name'].$row['bio_rec_id'].'-'.$row['month_process'].$row['year_process'];
        $fileName = preg_replace('/\s+/', '', $str);
        
        $spreadsheet->createSheet();
        return $fileName;

        // Redirect output to a clients web browser (Xlsx)

    }

    public function getSlipByIid($slipId){
        $slip = new M_tr_slip();
        $row = $slip->getSlipById($slipId);
        $myData = array();
        // dd($row);
        // echo $slipId;
        // exit();
        $myData[0] = $row['slip_id']; 
        $myData[1] = $row['full_name'];
        $myData[2] = $row['thr'];
        $myData[3] = $row['allowance_03'];
        $myData[4] = $row['adjustment'];
        $myData[5] = $row['status_remarks'];
        echo json_encode($myData);
     
        
    }

    public function printAllSM($tahun,$bulan,$startDate,$sm,$checkBpjs,$checkJHT,$checkJP,$checkJKKJKM)
    {
        $data_proses = new M_tr_timesheet();
        $data_proses->setMonthProcess($bulan);
        $data_proses->setYearProcess($tahun);
        $data_proses->setstartDate($startDate);
        $query = $data_proses->getTs_Id($sm);
        ini_set('max_execution_time', 1200); //300 seconds = 5 minutes
        $spreadsheet = new Spreadsheet();
        $spreadsheet->setActiveSheetIndex(0);
        $spreadsheet->createSheet();
        $noNewSheet = 1;
        $count = 0;
        foreach ($query as $row) {
            $count++;
            $ts_id = $row['ts_id'];
            
            // AGAR MATCH BIODATA_ID-NIE DI SLIP & SALARY DENGAN BIODATA_ID-NIE DI ROSTER
            $this->Excel($ts_id,$checkBpjs,$checkJHT,$checkJP,$checkJKKJKM, $spreadsheet, $noNewSheet);
            
            $noNewSheet++;
            // echo $noNewSheet;
        }
        // echo $count;
        // exit();
        $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet'));
        $spreadsheet->removeSheetByIndex($sheetIndex);
        $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet 1'));
        $spreadsheet->removeSheetByIndex($sheetIndex);
        // Redirect output to a client?s web browser (Xlsx)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="'.$sm.$tahun.$bulan.$startDate.'.Xlsx"');
        // header('Content-Disposition: attachment;filename="Report Excel.xlsx"');
        header('Cache-Control: max-age=0');
        // If you're serving to IE 9, then the following may be needed
        header('Cache-Control: max-age=1');

        // If you're serving to IE over SSL, then the following may be needed
        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
        header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT'); // always modified
        header('Cache-Control: cache, must-revalidate'); // HTTP/1.1
        header('Pragma: public'); // HTTP/1.0
        /* BY COMPOSER */
        $writer = new Xlsx($spreadsheet);
        /* OFFLINE/ BY COPY EXCEL FOLDER  */
        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');
        $writer->save('php://output');
        exit(0);
    }

    public function toExcel($tsId, $checkBpjs,$checkJHT,$checkJP,$checkJKKJKM)
    {
        $spreadsheet = new Spreadsheet();
        $fileName = $this->Excel($tsId, $checkBpjs,$checkJHT,$checkJP,$checkJKKJKM, $spreadsheet, 0);
        // $sheetIndex = $spreadsheet->getIndex($spreadsheet->getSheetByName('Worksheet'));
        // $spreadsheet->removeSheetByIndex($sheetIndex);
        // Redirect output to a client?s web browser (Xlsx)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="'.$fileName.'.Xlsx"');
        // header('Content-Disposition: attachment;filename="Report Excel.xlsx"');
        header('Cache-Control: max-age=0');
        // If you're serving to IE 9, then the following may be needed
        header('Cache-Control: max-age=1');

        // If you're serving to IE over SSL, then the following may be needed
        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
        header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT'); // always modified
        header('Cache-Control: cache, must-revalidate'); // HTTP/1.1
        header('Pragma: public'); // HTTP/1.0
        /* BY COMPOSER */ 
        $writer = new Xlsx($spreadsheet);
        /* OFFLINE/ BY COPY EXCEL FOLDER  */
        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');
        $writer->save('php://output');
        // $writer->save('./mobile_file/'.$fileName.'.xlsx');
        exit(0);
    }

    public function taxApi($biodata_id,$brutto,$marital,$end,$month,$year)
    {
        // Mengambil instance dari HTTP Request
        $request = service('request');

        // URL API yang akan dipanggil
        // $apiUrl = 'http://localhost:81/api-tax-martabe/public/api/posts';
        $apiUrl = 'http://192.168.10.12/api-tax-test/public/api/posts';

        // Data yang akan dikirim sebagai body request
        $postData = [
            'biodata_id' => $biodata_id,
            'brutto'     => $brutto,
            'marital'    => $marital,
            'end'        => $end,
            'month'      => $month,
            'year'       => $year,
        ];
        // dd($postData);
        // exit();
        // Inisialisasi Curl
        $ch = curl_init();

        // Set konfigurasi Curl
        curl_setopt($ch, CURLOPT_URL, $apiUrl);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        // Eksekusi Curl dan dapatkan respons
        $response = curl_exec($ch);

        // Menutup koneksi Curl
        curl_close($ch);

        // Menampilkan hasil response dari API
        $response = json_decode($response);

        return $response->data;
    }

    function checkClosingPayrollByPeriod(){
        $month      = $this->request->getPost('monthPeriod');
        $year       = $this->request->getPost('yearPeriod');
        $client     = $this->request->getPost('client');


        $trTimesheet= new M_tr_timesheet();
        $dataCount  = $trTimesheet->getDataClosing($client,$year,$month);

        $data_array= array(
            "data_count"=> count($dataCount)
        );

        echo json_encode($data_array);
    }

}
?>
