<?php namespace App\Controllers\Master; 
/*********************************************************************
 *  Created By       : Generator Version 1.0.23                      *
 *  Created Date     : Feb 13, 2022                                 *
 *  Description      : All code generated by controller generator    *
 *  Generator Author : Tommy Maurice(tommy_maurice@yahoo.com)        *
 *********************************************************************/
use CodeIgniter\Controller;
use App\Controllers\BaseController;
use App\Models\Master\M_mt_salary;
use App\Models\Master\M_mt_biodata;
use App\Models\Master\M_bank;
use App\Models\Master\M_dept;
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\Writer\Xls;
use PhpOffice\PhpSpreadsheet\IOFactory;

$session = session();

class Mt_salary extends BaseController
{
     /* START INDEX FUNCTION */
     public function index()
     {
         /* ***Using Valid Path */
         $data['actView'] = 'Master/salary_view';
         return view('home', $data);
     }
     /* END INDEX FUNCTION */
     /* START INPUT FUNCTION */
     public function ins_view()
    {
        $mtSalary = new M_mt_salary();
        $mtdept = new M_dept();
        $data['data_dept'] = $mtdept->get_dept();
        $mtBank   = new M_bank();
        $data['data_biodata'] = $mtSalary->getAllbio();
        $data['data_bank']    = $mtBank->get_bank();
        $data['actView'] = 'Master/salary_ins';
        return view('home', $data);     
    }
     /* END INPUT FUNCTION */
     /* START UPDATE FUNCTION */
     public function upd_view($salary_id)
     {
      $mtBiodata = new M_mt_biodata();
      $mtBank   = new M_bank();
      $mtSalary = new M_mt_salary();
      $mtDept = new M_dept();
      $data['data_dept'] = $mtDept->get_dept();
      $data['mtSalary'] = $mtSalary->getById($salary_id);
      $data['data_biodata'] = $mtBiodata->get_biodata();
      $data['data_bank']    = $mtBank->get_bank();
          /* ***Using Valid Path */
      $data['actView'] = 'Master/salary_upd';
      return view('home', $data);
     }
     /* END UPDATE FUNCTION */
     /* START INSERT */
     public function ins()
     {
      $localed = 0;
      $jp = 0;
      $jht = 0;
      $bpjs = 0;
      $jkkjkm = 0; 
          /*echo $_POST['isActive'];
          exit();*/
          if($_POST['isActive'] == "Y"){
          $localed = 1; 
          }
          if($_POST['cbHealthBPJS'] == "Y"){
          $bpjs = 1; 
          }
          if($_POST['cbJHT'] == "Y"){
          $jht = 1; 
          }
          if($_POST['cbJP'] == "Y"){
          $jp = 1; 
          }
          if($_POST['cbJKKM'] == "Y"){
          $jkkjkm = 1; 
          }
      $userId = $_SESSION['uId'];
      $currDateTm = date("Y-m-d H:i:s");
      $mtSalary = new M_mt_salary();
      $headerId = $mtSalary->generateId('salary_id')['doc_id'];
      $mtSalary->resetValues();
      $mtSalary->setSalaryId($headerId);
      $mtSalary->setBiodataId($_POST['biodataId']);
      $mtSalary->setAccNo($_POST['accNo']);
      $mtSalary->setAccName($_POST['accName']);
      $mtSalary->setBankId($_POST['bankId']);
      $mtSalary->setMonthly($_POST['monthly']);
      $mtSalary->setDaily($_POST['daily']);
      $mtSalary->setbpjs($bpjs);
      $mtSalary->setjht($jht);
      $mtSalary->setjp($jp);
      $mtSalary->setjkkjkm($jkkjkm);
      $mtSalary->setmonth($_POST['month']);
      $mtSalary->setIsActive($localed);
      $mtSalary->setPicInput($userId);
      $mtSalary->setInputTime($currDateTm);
      $mtSalary->ins();
     }
     /* END INSERT */
     /* START UPDATE */
     public function upd()
     {
     
      
      $jp = 0;
      $jht = 0;
      $bpjs = 0;
      $jkkjkm = 0; 
          if($_POST['cbHealthBPJS'] == "Y"){
          $bpjs = 1; 
          }
          if($_POST['cbJHT'] == "Y"){
          $jht = 1; 
          }
          if($_POST['cbJP'] == "Y"){
          $jp = 1; 
          }
          if($_POST['cbJKKM'] == "Y"){
          $jkkjkm = 1; 
          }
      $id = $_POST['salaryId'];
      $userId = $_SESSION['uId'];
      $currdateTm = date("Y-m-d H:i:s");
      $mtSalary = new M_mt_salary();
      $mtSalary->setObjectById($id);
      $mtSalary->setBiodataId($_POST['biodataId']);
      $mtSalary->setBankId($_POST['bankId']);
      $mtSalary->setAccNo($_POST['accNo']);
      $mtSalary->setMonthly($_POST['monthly']);
      $mtSalary->setDaily($_POST['daily']);
      $mtSalary->setbpjs($bpjs);
      $mtSalary->setjht($jht);
      $mtSalary->setjp($jp);
      $mtSalary->setjkkjkm($jkkjkm);
      $mtSalary->setmonth($_POST['month']);
      $mtSalary->setPicEdit($userId);
      $mtSalary->setEditTime($currdateTm);
      $mtSalary->upd($id);
     }
     /* END UPDATE */
     /* START DELETE */
     public function del()
     {
      $mtSalary = new M_mt_salary();
      $id = $_POST['id'];
      $mtSalary->del($id);
     }
     /* END DELETE */
     /* START GET ALL */
     public function getAll()
     {
      $mtSalary = new M_mt_salary();
      $rs = $mtSalary->getAll();
      return json_encode($rs); 
     }
     /* END GET ALL */
     public function reset()
     {
          /*Clear Session*/
          if (!(isset($_SESSION['unset_userdata']))) {

            return redirect()->to(base_url('Master/mt_salary'));
            
        }
     }

     public function printSalary()
     {
       // Create new Spreadsheet object

        $mtSalary = new M_mt_salary();
        // echo $depart;
        // exit();
        
        // echo ($dept);
        // exit();
        $data = $mtSalary->getAll();
         $spreadsheet = new Spreadsheet();  

         $spreadsheet->getProperties()->setCreator('Maurice - Web - Android')
            ->setLastModifiedBy('Maurice - Web - Android')
            ->setTitle('Office 2007 XLSX Test Document')
            ->setSubject('Office 2007 XLSX Test Document')
            ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
            ->setKeywords('office 2007 openxml php')
            ->setCategory('Test result file');

        $boldFont = [
            'font' => [
                'bold' => true
                // 'color' => ['argb' => '0000FF'],
            ],
        ];

        $totalStyle = [
            'font' => [
                'bold' => true,
                'color' => ['argb' => '0000FF'],
            ],
        ];

        $allBorderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $outlineBorderStyle = [
            'borders' => [
                'outline' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $topBorderStyle = [
            'borders' => [
                'top' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $bottomBorderStyle = [
            'borders' => [
                'bottom' => [
                    'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                    'color' => ['argb' => '00000000'],
                ],
            ],
        ];

        $center = array();
        $center['alignment'] = array();
        $center['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER; 
        $center['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER; 

        $right = array();
        $right['alignment'] = array();
        $right['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_RIGHT; 
        $right['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        $left = array();
        $left['alignment'] = array();
        $left['alignment']['horizontal'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_LEFT; 
        $left['alignment']['vertical'] = \PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER;

        

        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 1, 'SUMMARY INVOICE PT SANGATI SOERYA SEJAHTERA - PT. Agincourt Resources Martabe Gold Mine');
        $spreadsheet->getActiveSheet()->mergeCells("A1:H1");
        $spreadsheet->getActiveSheet()->getStyle("A1:H1")->applyFromArray($center);
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'PT. PONTIL');
        // $spreadsheet->getActiveSheet()->mergeCells("A2:U2");
        // $spreadsheet->getActiveSheet()->getStyle("A2:U2")->applyFromArray($center);
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'PERIOD : '.$monthPeriod.'-'.$yearPeriod);
        //$spreadsheet->getActiveSheet()->mergeCells("A2:AC2");
        //$spreadsheet->getActiveSheet()->getStyle("A2:AC2")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("A1:D1")->getFont()->setBold(true)->setSize(16);
        $spreadsheet->getActiveSheet()->getStyle("A2:D2")->getFont()->setBold(true)->setSize(16);
        //$spreadsheet->getActiveSheet()->getStyle("A3:G5")->getFont()->setBold(true)->setSize(12); 
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 3, 'DATE        : ');
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 4, 'INVOICE NO  : ');
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(0, 5, 'CONTRACT NO : ');        

        /* SET HEADER BG COLOR*/
        $spreadsheet->getActiveSheet()->getStyle('A4:H4')
            ->getFill()
            ->setFillType(\PhpOffice\PhpSpreadsheet\Style\Fill::FILL_SOLID)
            ->getStartColor()
            ->setRGB('F2BE6B'); 

        /* START INVOICE TITLE */
        $spreadsheet->getActiveSheet()->getStyle("A4:H4")->getFont()->setSize(12);

        $spreadsheet->getActiveSheet()->getStyle("A4:A4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("B4:B4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("C4:C4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("D4:D4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("E4:E4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("F4:F4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("G4:G4")->applyFromArray($allBorderStyle);
        $spreadsheet->getActiveSheet()->getStyle("H4:H4")->applyFromArray($allBorderStyle);


        $spreadsheet->getActiveSheet()->getStyle("A4:A4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("B4:B4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("C4:C4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("D4:D4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("F4:F4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("G4:G4")->applyFromArray($center);
        $spreadsheet->getActiveSheet()->getStyle("H4:H4")->applyFromArray($center);

        $spreadsheet->getActiveSheet()->getStyle("B4:B4")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()->getStyle("C4:C4")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()->getStyle("F4:F4")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()->getStyle("G4:G4")->getAlignment()->setWrapText(true);
        $spreadsheet->getActiveSheet()->getStyle("H4:H4")->getAlignment()->setWrapText(true);

        $spreadsheet->getActiveSheet()->getStyle("A4:H4")->applyFromArray($outlineBorderStyle);

        $spreadsheet->getActiveSheet()->mergeCells("A4:A4");
        $spreadsheet->getActiveSheet()->mergeCells("B4:B4");
        $spreadsheet->getActiveSheet()->mergeCells("C4:C4");
        $spreadsheet->getActiveSheet()->mergeCells("D4:D4");
        $spreadsheet->getActiveSheet()->mergeCells("F4:F4");
        $spreadsheet->getActiveSheet()->mergeCells("G4:G4");
        $spreadsheet->getActiveSheet()->mergeCells("H4:H4");

        $total = 0;
        $rounded = 0;
        $gaji = 0;
        $dana = 0;
        

        $spreadsheet->getActiveSheet()
                ->setCellValue('A4', 'NO')
                ->setCellValue('B4', 'SALARY ID')
                ->setCellValue('C4', 'Biodata ID')
                ->setCellValue('D4', 'BANK ID')
                ->setCellValue('E4', 'NOMER REKENING')
                ->setCellValue('F4', 'NAMA REKENING')
                ->setCellValue('G4', 'MONTHLY')
                ->setCellValue('H4', 'DAILY')
                ;

        /* START TOTAL WORK HOUR */     

        $rowIdx = 5;
        $startIdx = $rowIdx; 
        $rowNo = 0;

        foreach ($data as $row) {
            $rowIdx++;
            $rowNo++;
        

        


            $spreadsheet->getActiveSheet()
                ->setCellValue('A'.$rowIdx, $rowNo)
                ->setCellValue('B'.$rowIdx, $row['salary_id']) 
                ->setCellValue('C'.$rowIdx, $row['biodata_id'])
                ->setCellValue('D'.$rowIdx, $row['bank_id'])
                ->setCellValue('E'.$rowIdx, $row['account_no'])
                ->setCellValue('F'.$rowIdx, $row['account_name'])
                ->setCellValue('G'.$rowIdx, $row['monthly'])
                ->setCellValue('H'.$rowIdx, $row['daily'])
                ;

            $spreadsheet->getActiveSheet()->getStyle("A".$rowIdx.":H".$rowIdx)->applyFromArray($outlineBorderStyle);
            $spreadsheet->getActiveSheet()->getStyle("A".$rowIdx.":H".$rowIdx)->applyFromArray($allBorderStyle);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(0, $rowIdx, $rowNo);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(1, $rowIdx, $row['name']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(2, $rowIdx, $row['job_desc']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(3, $rowIdx, $row['basic_salary']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(4, $rowIdx, $row['rate']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(5, $rowIdx, $row['normal_d']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(6, $rowIdx, $row['ot_count1']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(7, $rowIdx, $row['ot_count2']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(8, $rowIdx, $row['ot_count3']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(9, $rowIdx, $row['ot_count4']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(10, $rowIdx, $row['worked_hours']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(11, $rowIdx, $row['current_salary']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(12, $rowIdx, $row['ot_total']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(13, $rowIdx, $row['travel_bonus']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(14, $rowIdx, $gross);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(12, $rowIdx, $row['uplift']);
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(15, $rowIdx, '=IF(K'.$rowIdx.'<=312,((E'.$rowIdx.'*K'.$rowIdx.')*64%),((E'.$rowIdx.'*312)*64%))');
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(7, $rowIdx, '1');
            // $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(16, $rowIdx, $chargeTotal);
            /* SET ROW COLOR */
            if($rowIdx % 2 == 1)
            {
                $spreadsheet->getActiveSheet()->getStyle('A'.$rowIdx.':H'.$rowIdx)
                    ->getFill()
                    ->setFillType(\PhpOffice\PhpSpreadsheet\Style\Fill::FILL_SOLID)
                    ->getStartColor()
                    ->setRGB('EAEBAF');             
            } 

        
        $spreadsheet->getActiveSheet()
                ->setCellValue('A1', 'LIST SALARY KARYAWAN PT SANGATI SOERYA SEJAHTERA')
                ->setCellValue('A2', 'PT '.'AGINCOURT MARTABE RESOURCES');
    } /* end foreach ($query as $row) */
        
       

        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(2, ($rowIdx+2), "TOTAL");
        // $spreadsheet->getActiveSheet()->setCellValueByColumnAndRow(16, ($rowIdx+2), "=SUM(Q".$startIdx.":Q".$rowIdx.")");
        
        /* SET NUMBERS FORMAT*/
        
        unset($allBorderStyle);
        unset($center);
        unset($right);
        unset($left);
        
        $spreadsheet->setActiveSheetIndex(0);
        $datenow = date('Y-m-d');
        $str = 'LISTSALARYAGR'.$datenow;
        $fileName = preg_replace('/\s+/', '', $str);

        // Redirect output to a client’s web browser (Xlsx)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="'.$fileName.'.Xlsx"');
        // header('Content-Disposition: attachment;filename="Report Excel.xlsx"');
        header('Cache-Control: max-age=0');
        // If you're serving to IE 9, then the following may be needed
        header('Cache-Control: max-age=1');

        // If you're serving to IE over SSL, then the following may be needed
        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
        header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT'); // always modified
        header('Cache-Control: cache, must-revalidate'); // HTTP/1.1
        header('Pragma: public'); // HTTP/1.0
        /* BY COMPOSER */
        // $writer = new Xlsx($spreadsheet);
        /* OFFLINE/ BY COPY EXCEL FOLDER  */
        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');
        $writer->save('php://output');
        exit(0);
     }
}
?>
